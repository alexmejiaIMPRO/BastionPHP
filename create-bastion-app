#!/usr/bin/env bash
#==============================================================================
# Bastion PHP GENERATOR v0.1.0 - create-bastion-app
#
# Generates a Bastion PHP project with:
#  - Service Container, DV view engine, Theme helpers
#  - File-based routing with [param] folders & +server.php (Next.js-style)
#  - Nested layouts via app/layout.php + per-folder layout.php
#  - DB facade (SQLite default) with QueryBuilder
#  - Logger, Response helpers, enhanced Request & Validation
#  - Auth (JWT with refresh tokens), CSRF middleware, SecurityHeaders, RateLimit
#  - Admin panel scaffold, migrations, seeders
#  - bastion CLI (run-dev, migrate, seed) + artisan shim
#
# Usage:
#   ./create-bastion-app my-app
#==============================================================================

set -euo pipefail

#--- COLORS ---
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

info()    { echo -e "${BLUE}ℹ${NC} $1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
error()   { echo -e "${RED}✗${NC} $1"; exit 1; }

#--- ARGS ---
if [ "$#" -lt 1 ]; then
  echo "Usage: $0 <project-name>"
  exit 1
fi

PROJECT="$1"
ROOT="$(pwd)/$PROJECT"

info "Creating Bastion PHP 0.1.0 Project: $PROJECT"

if [ -e "$ROOT" ]; then
  error "Directory '$ROOT' already exists. Remove or choose another name."
fi

mkdir -p "$ROOT"
cd "$ROOT"

#------------------------------------------------------------------------------
# DIRECTORIES
#------------------------------------------------------------------------------
mkdir -p app/Core app/Middleware app/Models app/Services
mkdir -p app/admin users app/admin/settings app/admin/database
mkdir -p app/login app/logout

mkdir -p app/api/auth/login app/api/auth/logout app/api/auth/refresh
mkdir -p app/api/users app/api/users/[id]

mkdir -p resources/views/errors resources/css
mkdir -p config database/migrations database/seeds
mkdir -p public/css storage/db storage/logs storage/uploads

touch storage/db/app.db || true
touch storage/logs/.gitkeep || true

#------------------------------------------------------------------------------
# KEYS
#------------------------------------------------------------------------------
if command -v openssl >/dev/null 2>&1; then
  APP_KEY=$(openssl rand -base64 32)
  JWT_SECRET=$(openssl rand -base64 32)
else
  APP_KEY=$(php -r "echo base64_encode(random_bytes(32));")
  JWT_SECRET=$(php -r "echo base64_encode(random_bytes(32));")
fi

#==============================================================================
# 1. CONFIG & COMPOSER
#==============================================================================

info "Generating configuration files..."

cat > .env <<ENV
APP_NAME="Bastion PHP 0.1.0"
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost:8000
APP_KEY=$APP_KEY

DB_CONNECTION=sqlite
DB_PATH=storage/db/app.db

JWT_SECRET=$JWT_SECRET
JWT_TTL=3600
JWT_REFRESH_TTL=604800

CSRF_ENABLED=true
SECURE_COOKIES=false
LOG_LEVEL=debug
ENV

cat > .env.example <<'ENV'
APP_NAME="Bastion PHP 0.1.0"
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost:8000
APP_KEY=base64:REPLACE_ME

DB_CONNECTION=sqlite
DB_PATH=storage/db/app.db

JWT_SECRET=REPLACE_ME
JWT_TTL=3600
JWT_REFRESH_TTL=604800

CSRF_ENABLED=true
SECURE_COOKIES=false
LOG_LEVEL=debug
ENV

cat > config/style.php <<'PHP'
<?php
return [
    'theme'        => getenv('THEME_MODE') ?: 'system',
    'useTailwind'  => true,
    'tailwindMode' => 'cdn', // we use CDN by default
    'fallbackCss'  => '/css/fallback.css',
];
PHP

cat > composer.json <<'JSON'
{
  "name": "bastion/app",
  "description": "Bastion PHP 0.1.0 - Secure Internal Tools Framework",
  "type": "project",
  "require": {
    "php": "^8.1",
    "firebase/php-jwt": "^6.0"
  },
  "autoload": {
    "psr-4": { "App\\": "app/" },
    "files": ["app/Core/helpers.php"]
  }
}
JSON

#==============================================================================
# 2. CORE ARCHITECTURE
#==============================================================================

info "Building Core Architecture..."

cat > app/Core/Container.php <<'PHP'
<?php
namespace App\Core;

class Container {
    protected array $bindings = [];
    protected array $instances = [];

    public function bind(string $key, callable $resolver): void {
        $this->bindings[$key] = $resolver;
    }

    public function singleton(string $key, callable $resolver): void {
        $this->bindings[$key] = function ($c) use ($resolver) {
            static $object;
            if (!$object) $object = $resolver($c);
            return $object;
        };
    }

    public function resolve(string $key): mixed {
        if (isset($this->instances[$key])) {
            return $this->instances[$key];
        }
        if (isset($this->bindings[$key])) {
            return $this->bindings[$key]($this);
        }
        if (class_exists($key)) {
            return new $key();
        }
        throw new \RuntimeException("Cannot resolve: $key");
    }

    public function instance(string $key, mixed $value): void {
        $this->instances[$key] = $value;
    }
}
PHP

cat > app/Core/App.php <<'PHP'
<?php
namespace App\Core;

class App extends Container {
    private static App $instance;
    private Router $router;

    public function __construct(string $rootPath) {
        self::$instance = $this;
        $this->router   = new Router($rootPath . '/app');
        $this->registerServices();
    }

    public static function getInstance(): App {
        return self::$instance;
    }

    private function registerServices(): void {
        $this->singleton(DB::class, fn() => new DB());
        $this->singleton(Auth::class, fn() => new Auth());
        $this->singleton(Logger::class, fn() => new Logger());
    }

    public function router(): Router {
        return $this->router;
    }

    public function run(): void {
        if (session_status() !== PHP_SESSION_ACTIVE && PHP_SAPI !== 'cli') {
            session_start();
        }

        $request = new Request();
        $this->instance(Request::class, $request);

        $middlewares = [
            \App\Middleware\SecurityHeaders::class,
            \App\Middleware\RateLimit::class,
            \App\Middleware\AuthMiddleware::class,
        ];

        $handler = fn($req) => $this->router->dispatch($req);

        foreach (array_reverse($middlewares) as $mw) {
            $next = $handler;
            $handler = function($req) use ($mw, $next) {
                $instance = new $mw();
                return $instance->handle($req, $next);
            };
        }

        $handler($request);
    }
}
PHP

cat > app/Core/Logger.php <<'PHP'
<?php
namespace App\Core;

class Logger {
    private string $logFile;

    public function __construct() {
        $this->logFile = __DIR__ . '/../../storage/logs/app.log';
    }

    private function write(string $level, string $message, array $ctx = []): void {
        $date   = date('Y-m-d H:i:s');
        $ctxStr = $ctx ? ' ' . json_encode($ctx, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE) : '';
        $line   = "[$date] " . strtoupper($level) . ": $message$ctxStr" . PHP_EOL;
        $dir    = dirname($this->logFile);
        if (!is_dir($dir)) @mkdir($dir, 0755, true);
        @file_put_contents($this->logFile, $line, FILE_APPEND | LOCK_EX);
    }

    public function debug(string $m, array $c = []): void { $this->write('debug', $m, $c); }
    public function info(string $m, array $c = []): void  { $this->write('info', $m, $c); }
    public function warning(string $m, array $c = []): void{ $this->write('warning', $m, $c); }
    public function error(string $m, array $c = []): void { $this->write('error', $m, $c); }
}
PHP

cat > app/Core/Request.php <<'PHP'
<?php
namespace App\Core;

class Request {
    public string $path = '';
    public string $method = 'GET';
    public array  $headers = [];
    public array  $cookies = [];
    public array  $query = [];
    public array  $body = [];
    public array  $files = [];
    public array  $meta = [];

    public function __construct() {
        $uri        = parse_url($_SERVER['REQUEST_URI'] ?? '/', PHP_URL_PATH) ?? '/';
        $clean      = preg_replace('#/+#', '/', $uri);
        $safe       = str_replace(['..', './', '.\\'], '', $clean);
        $this->path = ltrim(trim($safe, '/'), '/');

        $this->method  = $_SERVER['REQUEST_METHOD'] ?? 'GET';
        $this->headers = $this->getAllHeaders();
        $this->cookies = $_COOKIE ?? [];
        $this->query   = $_GET ?? [];
        $this->body    = $_POST ?? [];
        $this->files   = $_FILES ?? [];
    }

    private function getAllHeaders(): array {
        if (function_exists('getallheaders')) {
            return getallheaders() ?: [];
        }
        $headers = [];
        foreach ($_SERVER as $name => $value) {
            if (str_starts_with($name, 'HTTP_')) {
                $key = str_replace(' ', '-', ucwords(strtolower(str_replace('_', ' ', substr($name, 5)))));
                $headers[$key] = $value;
            }
        }
        return $headers;
    }

    public function input(string $key, mixed $default = null): mixed {
        if ($this->isJson()) {
            $data = $this->json();
            return $data[$key] ?? $default;
        }
        return $this->body[$key] ?? $this->query[$key] ?? $default;
    }

    public function json(): array {
        $input = file_get_contents('php://input');
        return json_decode($input, true) ?? [];
    }

    public function isJson(): bool {
        return stripos($this->headers['Content-Type'] ?? '', 'application/json') !== false;
    }

    public function validate(array $rules): array {
        $errors = [];
        $data   = $this->isJson() ? $this->json() : $this->body;

        foreach ($rules as $field => $ruleStr) {
            $val      = $data[$field] ?? null;
            $ruleList = explode('|', $ruleStr);
            foreach ($ruleList as $rule) {
                if ($rule === 'required' && ($val === null || $val === '')) {
                    $errors[$field][] = "$field is required";
                }
                if (str_starts_with($rule, 'min:')) {
                    $min = (int)substr($rule, 4);
                    if (strlen((string)$val) < $min) {
                        $errors[$field][] = "$field must be at least $min characters";
                    }
                }
                if ($rule === 'email' && !empty($val) && !filter_var($val, FILTER_VALIDATE_EMAIL)) {
                    $errors[$field][] = "$field must be a valid email";
                }
            }
        }

        if (!empty($errors)) {
            throw new ValidationException('Validation failed', $errors);
        }

        return $data;
    }
}
PHP

cat > app/Core/ValidationException.php <<'PHP'
<?php
namespace App\Core;

class ValidationException extends \Exception {
    public array $errors = [];

    public function __construct(string $message = "Validation failed", array $errors = [], int $code = 422) {
        parent::__construct($message, $code);
        $this->errors = $errors;
    }
}
PHP

cat > app/Core/Response.php <<'PHP'
<?php
namespace App\Core;

class Response {
    public static function json($data, int $status = 200): never {
        http_response_code($status);
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode($data, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE);
        exit;
    }

    public static function html(string $content, int $status = 200): never {
        http_response_code($status);
        header('Content-Type: text/html; charset=UTF-8');
        echo $content;
        exit;
    }

    public static function redirect(string $url, int $code = 302): never {
        $url = str_replace(["\r","\n"], '', $url);
        header("Location: $url", true, $code);
        exit;
    }

    public static function abort(int $code, string $msg = ''): never {
        http_response_code($code);
        $file = __DIR__ . "/../../resources/views/errors/{$code}.php";
        if (file_exists($file)) {
            echo DV::render($file, ['message' => $msg]);
        } else {
            echo "<h1>Error {$code}</h1><p>" . htmlentities($msg) . "</p>";
        }
        exit;
    }
}
PHP

cat > app/Core/DB.php <<'PHP'
<?php
namespace App\Core;

use PDO;

class DB {
    private PDO $pdo;

    public function __construct() {
        $path = env('DB_PATH', 'storage/db/app.db');
        $full = __DIR__ . '/../../' . ltrim($path, '/');
        $dir  = dirname($full);
        if (!is_dir($dir)) @mkdir($dir, 0755, true);
        if (!file_exists($full)) @touch($full);

        $this->pdo = new PDO("sqlite:$full");
        $this->pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        $this->pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
        $this->pdo->exec('PRAGMA journal_mode=WAL');
    }

    public function query(string $table): QueryBuilder {
        return new QueryBuilder($this->pdo, $table);
    }

    public function getPdo(): PDO {
        return $this->pdo;
    }

    public static function __callStatic($method, $args) {
        $instance = App::getInstance()->resolve(self::class);
        if ($method === 'table') {
            return $instance->query(...$args);
        }
        return $instance->$method(...$args);
    }
}

class QueryBuilder {
    private PDO $pdo;
    private string $table;
    private array $wheres = [];
    private array $bindings = [];
    private ?int $limit = null;
    private ?int $offset = null;
    private array $orderBy = [];

    public function __construct(PDO $pdo, string $table) {
        $this->pdo   = $pdo;
        $this->table = $table;
    }

    public function where($col, $val): self {
        $this->wheres[]   = "$col = ?";
        $this->bindings[] = $val;
        return $this;
    }

    public function limit(int $l): self { $this->limit = $l; return $this; }
    public function offset(int $o): self { $this->offset = $o; return $this; }

    public function orderBy($col, $dir='ASC'): self {
        $this->orderBy[] = "$col $dir";
        return $this;
    }

    public function get(): array {
        $sql = "SELECT * FROM {$this->table}";
        if ($this->wheres)  $sql .= " WHERE " . implode(' AND ', $this->wheres);
        if ($this->orderBy) $sql .= " ORDER BY " . implode(', ', $this->orderBy);
        if ($this->limit)   $sql .= " LIMIT {$this->limit}";
        if ($this->offset)  $sql .= " OFFSET {$this->offset}";

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute($this->bindings);
        return $stmt->fetchAll();
    }

    public function first(): ?array {
        $this->limit(1);
        $r = $this->get();
        return $r[0] ?? null;
    }

    public function insert(array $data): int {
        $cols = implode(',', array_keys($data));
        $vals = implode(',', array_fill(0, count($data), '?'));
        $stmt = $this->pdo->prepare("INSERT INTO {$this->table} ($cols) VALUES ($vals)");
        $stmt->execute(array_values($data));
        return (int)$this->pdo->lastInsertId();
    }

    public function update(array $data): bool {
        $set = implode(',', array_map(fn($k)=>"$k=?", array_keys($data)));
        $sql = "UPDATE {$this->table} SET $set";
        if ($this->wheres) $sql .= " WHERE " . implode(' AND ', $this->wheres);
        $stmt = $this->pdo->prepare($sql);
        return $stmt->execute([...array_values($data), ...$this->bindings]);
    }

    public function delete(): bool {
        $sql = "DELETE FROM {$this->table}";
        if ($this->wheres) $sql .= " WHERE " . implode(' AND ', $this->wheres);
        $stmt = $this->pdo->prepare($sql);
        return $stmt->execute($this->bindings);
    }

    public function count(): int {
        $sql = "SELECT COUNT(*) FROM {$this->table}";
        if ($this->wheres) $sql .= " WHERE " . implode(' AND ', $this->wheres);
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute($this->bindings);
        return (int)$stmt->fetchColumn();
    }
}
PHP

cat > app/Core/DV.php <<'PHP'
<?php
namespace App\Core;

class DV {
    protected static array $data = [];

    public static function set(string $key, mixed $value): void {
        self::$data[$key] = $value;
    }

    public static function get(string $key, mixed $default = null): mixed {
        return self::$data[$key] ?? $default;
    }

    public static function render(string $path, array $local = []): string {
        $data = array_merge(self::$data, $local);
        extract($data, EXTR_SKIP);
        ob_start();
        $file = file_exists($path)
            ? $path
            : __DIR__ . '/../../resources/views/' . $path . '.php';
        if (file_exists($file)) {
            include $file;
        }
        return ob_get_clean();
    }
}
PHP

cat > app/Core/CSRF.php <<'PHP'
<?php
namespace App\Core;

class CSRF {
    public static function token(): string {
        if (session_status() !== PHP_SESSION_ACTIVE && PHP_SAPI !== 'cli') {
            session_start();
        }
        if (empty($_SESSION['_csrf'])) {
            $_SESSION['_csrf'] = bin2hex(random_bytes(32));
        }
        return $_SESSION['_csrf'];
    }

    public static function handle(Request $req, callable $next): mixed {
        if (in_array(strtoupper($req->method), ['POST','PUT','PATCH','DELETE'], true)) {
            if (!$req->isJson()) {
                $sent = $req->input('_csrf')
                    ?? $req->headers['X-CSRF-TOKEN']
                    ?? $req->headers['X-Csrf-Token']
                    ?? '';
                $sess = $_SESSION['_csrf'] ?? '';
                if (!is_string($sent) || !hash_equals((string)$sess, (string)$sent)) {
                    logger()->warning('CSRF token mismatch', ['path'=>$req->path ?? '']);
                    return Response::json(['error'=>'CSRF token mismatch'], 403);
                }
            }
        }
        return $next($req);
    }
}
PHP

cat > app/Core/Theme.php <<'PHP'
<?php
namespace App\Core;

class Theme {
    public static function applyHtmlAttrs(): string {
        $c = require __DIR__ . '/../../config/style.php';
        $m = $c['theme'] ?? 'system';
        if ($m === 'dark') return 'class="dark"';
        if ($m === 'light') return '';
        return 'onload="(function(){if(localStorage.theme===\'dark\'||(!(\'theme\' in localStorage)&&window.matchMedia(\'(prefers-color-scheme: dark)\').matches)){document.documentElement.classList.add(\'dark\');}})()"';
    }
}
PHP

cat > app/Core/helpers.php <<'PHP'
<?php
use App\Core\DV;
use App\Core\Auth;
use App\Core\CSRF;
use App\Core\Logger;

if (!function_exists('env')) {
    function env(string $k, $d = null) {
        $v = getenv($k);
        if ($v === false) return $d;
        if (preg_match('/^([\'"])(.*)\1$/', $v, $m)) return $m[2];
        return $v;
    }
}

if (!function_exists('view')) {
    function view($p, $d = []) { return DV::render($p, $d); }
}

if (!function_exists('e')) {
    function e($s) { return htmlspecialchars($s ?? '', ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8'); }
}

if (!function_exists('csrf_token')) {
    function csrf_token(): string { return CSRF::token(); }
}

if (!function_exists('csrf_field')) {
    function csrf_field(): string {
        return '<input type="hidden" name="_csrf" value="'.csrf_token().'">';
    }
}

if (!function_exists('auth')) {
    function auth() { return Auth::user() ?? null; }
}

if (!function_exists('logger')) {
    function logger(): Logger {
        static $instance = null;
        if ($instance === null) $instance = new Logger();
        return $instance;
    }
}
PHP

#==============================================================================
# 3. ROUTER (File-based + Next.js-style layouts)
#==============================================================================

cat > app/Core/Router.php <<'PHP'
<?php
namespace App\Core;

class Router {
    private string $root;

    public function __construct(string $root) {
        $this->root = rtrim($root, '/');
    }

    public function dispatch(Request $req): void {
        // 1) Try API (+server.php)
        if ($this->apiRoute($req)) {
            return;
        }

        // 2) Page routing with Next.js-like layout resolution
        $this->pageRoute($req);
    }

    private function apiRoute(Request $req): bool {
        [$dir, $params] = $this->resolveWithParams($req->path, 'api');
        if (!$dir) return false;

        $file = "$dir/+server.php";
        if (!file_exists($file)) return false;

        $req->meta['params'] = $params;
        $handlers = require $file;
        $method   = strtolower($req->method);

        if (!isset($handlers[$method])) {
            Response::json(['error' => 'Method not allowed'], 405);
        }

        $handlers[$method]($req);
        return true;
    }

    private function pageRoute(Request $req): void {
        [$dir, $params] = $this->resolveWithParams($req->path, 'page');
        if (!$dir) {
            Response::abort(404, 'Page not found');
        }

        $pageFile = "$dir/page.php";
        if (!file_exists($pageFile)) {
            Response::abort(404, 'Page file missing');
        }

        DV::set('params', $params);

        // Collect layouts (root app/layout.php + nested folder layout.php)
        $layouts = $this->collectLayouts($dir);

        // Define base content closure = just page
        $content = function () use ($pageFile) {
            include $pageFile;
        };

        // Wrap content with layouts from inner to outer
        foreach (array_reverse($layouts) as $layoutFile) {
            $previous = $content;
            $content = function () use ($layoutFile, $previous) {
                $content = $previous; // layout will call $content()
                include $layoutFile;
            };
        }

        // Execute final composed layout+page
        ob_start();
        $content();
        $html = ob_get_clean();
        Response::html($html, 200);
    }

    /**
     * Resolve path with dynamic [param] folders.
     * Mode:
     *  - 'api'  => start from app/api
     *  - 'page' => start from app (regular pages)
     */
    private function resolveWithParams(string $uri, string $mode): array {
        $segs = ($uri === '' || $uri === '/') ? [] : explode('/', trim($uri, '/'));
        if ($mode === 'api') {
            if (!empty($segs) && $segs[0] === 'api') {
                array_shift($segs);
            } else {
                return [null, []];
            }
            $curr = $this->root . '/api';
        } else {
            // page mode
            $curr = $this->root;
        }

        $params = [];
        foreach ($segs as $seg) {
            $direct = "$curr/$seg";
            if (is_dir($direct)) {
                $curr = $direct;
                continue;
            }
            // dynamic [param] directory
            $found = false;
            foreach (glob("$curr/*", GLOB_ONLYDIR) as $dir) {
                $base = basename($dir);
                if (preg_match('/^\[(.+)\]$/', $base, $m)) {
                    $params[$m[1]] = $seg;
                    $curr          = $dir;
                    $found         = true;
                    break;
                }
            }
            if (!$found) {
                return [null, []];
            }
        }

        return [$curr, $params];
    }

    /**
     * Collect layouts from root app/layout.php and nested folders
     * up to the directory that holds the page.
     */
    private function collectLayouts(string $dir): array {
        $layouts = [];
        $rootApp = $this->root;

        // root layout
        $rootLayout = $rootApp . '/layout.php';
        if (file_exists($rootLayout)) {
            $layouts[] = $rootLayout;
        }

        // nested layouts along directory path
        $rel = str_replace($rootApp, '', $dir);
        $rel = trim($rel, '/');

        if ($rel === '') {
            return $layouts;
        }

        $segments = explode('/', $rel);
        $current  = $rootApp;

        foreach ($segments as $segment) {
            $current .= '/' . $segment;
            $layoutFile = $current . '/layout.php';
            if (file_exists($layoutFile)) {
                $layouts[] = $layoutFile;
            }
        }

        return $layouts;
    }
}
PHP

#==============================================================================
# 4. MIDDLEWARE
#==============================================================================

info "Creating Middleware..."

cat > app/Middleware/SecurityHeaders.php <<'PHP'
<?php
namespace App\Middleware;

use App\Core\Request;

class SecurityHeaders {
    public function handle(Request $req, callable $next) {
        $nonce = base64_encode(random_bytes(16));
        $req->meta['csp_nonce'] = $nonce;

        $csp = "default-src 'self'; ".
               "script-src 'self' 'nonce-{$nonce}' https://cdn.tailwindcss.com https://unpkg.com; ".
               "style-src 'self' 'nonce-{$nonce}' https://cdn.tailwindcss.com https://unpkg.com; ".
               "img-src 'self' data:; ".
               "connect-src 'self'";

        header("Content-Security-Policy: $csp");
        header("X-Frame-Options: SAMEORIGIN");
        header("X-Content-Type-Options: nosniff");
        header("Referrer-Policy: strict-origin-when-cross-origin");

        return $next($req);
    }
}
PHP

cat > app/Middleware/RateLimit.php <<'PHP'
<?php
namespace App\Middleware;

use App\Core\Request;

class RateLimit {
    public function handle(Request $req, callable $next) {
        // TODO: real IP-based limiter
        return $next($req);
    }
}
PHP

cat > app/Middleware/AuthMiddleware.php <<'PHP'
<?php
namespace App\Middleware;

use App\Core\Auth;
use App\Core\CSRF;
use App\Core\Request;

class AuthMiddleware {
    public function handle(Request $req, callable $next) {
        Auth::check($req);
        if (filter_var(getenv('CSRF_ENABLED') ?: 'true', FILTER_VALIDATE_BOOLEAN)) {
            return CSRF::handle($req, $next);
        }
        return $next($req);
    }
}
PHP

cat > app/Middleware/AdminOnly.php <<'PHP'
<?php
namespace App\Middleware;

use App\Core\Response;

class AdminOnly {
    public function handle($req, $next) {
        $user = auth();
        if (!$user || ($user['role'] ?? '') !== 'admin') {
            Response::abort(403, 'Admin Access Required');
        }
        return $next($req);
    }
}
PHP

#==============================================================================
# 5. MODELS & AUTH
#==============================================================================

info "Creating Models & Auth..."

cat > app/Models/User.php <<'PHP'
<?php
namespace App\Models;

use App\Core\DB;

class User {
    public static function find($id) { return DB::table('users')->where('id', $id)->first(); }
    public static function findByEmail($email) { return DB::table('users')->where('email', $email)->first(); }
    public static function all() { return DB::table('users')->orderBy('id', 'DESC')->get(); }

    public static function create(array $data) {
        $data['created_at'] = time();
        return DB::table('users')->insert($data);
    }

    public static function updateUser($id, array $data) {
        return DB::table('users')->where('id', $id)->update($data);
    }

    public static function deleteUser($id) {
        return DB::table('users')->where('id', $id)->delete();
    }
}
PHP

cat > app/Core/Auth.php <<'PHP'
<?php
namespace App\Core;

use Firebase\JWT\JWT;
use Firebase\JWT\Key;
use App\Models\User;

class Auth {
    public static function issueTokens(int|string $userId): array {
        $now        = time();
        $secret     = env('JWT_SECRET');
        if (!$secret) throw new \RuntimeException('JWT_SECRET not configured');
        $accessExp  = (int)env('JWT_TTL', 3600);
        $refreshExp = (int)env('JWT_REFRESH_TTL', 604800);

        $accessPayload = [
            'sub'  => $userId,
            'iat'  => $now,
            'exp'  => $now + $accessExp,
            'type' => 'access'
        ];
        $access = JWT::encode($accessPayload, $secret, 'HS256');

        $selector      = bin2hex(random_bytes(12));
        $validator     = bin2hex(random_bytes(32));
        $validatorHash = hash('sha256', $validator);
        $expiresAt     = $now + $refreshExp;

        DB::getPdo()->prepare('INSERT INTO refresh_tokens (user_id, selector, validator_hash, expires_at) VALUES (?, ?, ?, ?)')
            ->execute([$userId, $selector, $validatorHash, $expiresAt]);

        return [
            'access'  => $access,
            'refresh' => $selector . ':' . $validator,
            'expires' => $accessPayload['exp']
        ];
    }

    public static function validate(string $token): ?object {
        try {
            $secret = env('JWT_SECRET');
            if (!$secret) return null;
            return JWT::decode($token, new Key($secret, 'HS256'));
        } catch (\Throwable $e) {
            logger()->debug('JWT validate failed: ' . $e->getMessage());
            return null;
        }
    }

    public static function validateRefreshToken(string $token): ?int {
        $parts = explode(':', $token);
        if (count($parts) !== 2) return null;
        [$selector, $validator] = $parts;

        $stmt = DB::getPdo()->prepare('SELECT * FROM refresh_tokens WHERE selector = ?');
        $stmt->execute([$selector]);
        $row = $stmt->fetch();
        if (!$row) return null;

        DB::getPdo()->prepare('DELETE FROM refresh_tokens WHERE selector = ?')->execute([$selector]);
        if (time() > (int)$row['expires_at']) return null;
        if (!hash_equals($row['validator_hash'], hash('sha256', $validator))) return null;

        return (int)$row['user_id'];
    }

    public static function attempt($email, $password) {
        $user = User::findByEmail($email);
        if (!$user || !password_verify($password, $user['password'] ?? '')) return false;
        return self::issueTokens($user['id']);
    }

    public static function check(Request $req) {
        $token = $req->headers['Authorization'] ?? null;
        if (!$token) $token = $_COOKIE['access'] ?? null;
        if ($token && preg_match('/Bearer\s+(.+)/', (string)$token, $m)) {
            $token = $m[1];
        }
        if (!$token) return null;

        $decoded = self::validate($token);
        if ($decoded && isset($decoded->sub)) {
            $user = User::find($decoded->sub);
            $GLOBALS['auth_user'] = $user;
            $req->meta['user']    = $user;
            return $user;
        }
        return null;
    }

    public static function user() {
        return $GLOBALS['auth_user'] ?? null;
    }
}
PHP

#==============================================================================
# 6. VIEWS & LAYOUTS (Next.js-style)
#==============================================================================

info "Creating Next.js-style layouts and pages..."

# Root layout
cat > app/layout.php <<'PHP'
<?php
use App\Core\Theme;
$nonce = $_SESSION['csp_nonce'] ?? ($_SESSION['csp_nonce'] = base64_encode(random_bytes(16)));
?>
<!doctype html>
<html lang="en" <?= Theme::applyHtmlAttrs() ?>>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title><?= e(\App\Core\DV::get('title', 'Bastion PHP')) ?></title>

    <!-- Tailwind via CDN -->
    <script nonce="<?= e($nonce) ?>" src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script nonce="<?= e($nonce) ?>" src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
<nav class="border-b border-slate-800 bg-slate-900/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <a href="/" class="font-bold text-xl tracking-tight">Bastion PHP</a>
        <div class="flex items-center gap-4 text-sm text-slate-300">
            <a href="/admin" class="hover:text-white">Admin</a>
            <?php if (auth()): ?>
                <span class="text-slate-400">Hi, <?= e(auth()['name']) ?></span>
                <a href="/logout" class="text-red-400 hover:text-red-300">Logout</a>
            <?php else: ?>
                <a href="/login" class="text-blue-400 hover:text-blue-300">Login</a>
            <?php endif; ?>
        </div>
    </div>
</nav>
<main class="max-w-6xl mx-auto px-4 py-8">
    <?php $content(); ?>
</main>
</body>
</html>
PHP

# Admin layout (nested layout)
mkdir -p app/admin
cat > app/admin/layout.php <<'PHP'
<?php
$nonce = $_SESSION['csp_nonce'] ?? ($_SESSION['csp_nonce'] = base64_encode(random_bytes(16)));
?>
<section class="space-y-6">
    <header class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-3xl font-bold">Admin Panel</h1>
            <p class="text-sm text-slate-400">Secure internal dashboard</p>
        </div>
        <span class="px-3 py-1 rounded-full text-xs bg-emerald-500/10 text-emerald-300 border border-emerald-500/30">
            Bastion 0.1.0
        </span>
    </header>

    <div class="grid gap-4 grid-cols-1 md:grid-cols-3">
        <div class="md:col-span-2 rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
            <?php $content(); ?>
        </div>

        <aside class="space-y-3">
            <div class="rounded-2xl border border-slate-800 bg-slate-900/80 p-4 text-sm text-slate-300">
                <h2 class="font-semibold mb-2 text-slate-100">Shortcuts</h2>
                <ul class="space-y-1">
                    <li><a class="hover:text-white" href="/admin">Dashboard</a></li>
                    <li><a class="hover:text-white" href="/admin/users">Users</a></li>
                </ul>
            </div>
        </aside>
    </div>
</section>
PHP

# Home page
cat > app/page.php <<'PHP'
<?php
use App\Core\DV;
DV::set('title', 'Bastion PHP - Home');
?>
<div class="space-y-8">
    <section class="text-center py-12">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">Bastion PHP 0.1.0</h1>
        <p class="text-lg text-slate-300 mb-6 max-w-2xl mx-auto">
            Secure, file-based PHP framework for internal tools. Next.js-style layouts, HTMX components,
            JWT auth, and SQLite performance — without heavy frameworks.
        </p>
        <div class="flex flex-wrap justify-center gap-4">
            <a href="/admin"
               class="px-6 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 font-semibold shadow">
                Go to Admin Panel
            </a>
            <a href="/api/users"
               class="px-6 py-3 rounded-xl border border-slate-700 hover:border-slate-500">
                Test Users API
            </a>
        </div>
    </section>
</div>
PHP

# Login page
mkdir -p app/login
cat > app/login/page.php <<'PHP'
<?php
use App\Core\DV;
DV::set('title', 'Login');
?>
<div class="max-w-md mx-auto">
    <div class="bg-slate-900/70 border border-slate-800 rounded-2xl shadow-xl p-8">
        <h1 class="text-2xl font-bold mb-6">Login</h1>

        <?php if (isset($_GET['error'])): ?>
            <div class="bg-red-900/40 border border-red-700 text-red-200 px-4 py-3 rounded mb-4">
                Invalid credentials. Please try again.
            </div>
        <?php endif; ?>

        <form method="POST" action="/api/auth/login" class="space-y-4">
            <div>
                <label class="block mb-1 text-sm font-medium">Email</label>
                <input name="email" value="admin@example.com"
                       class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block mb-1 text-sm font-medium">Password</label>
                <input name="password" type="password" value="password"
                       class="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <?= csrf_field() ?>
            <button
                class="w-full mt-2 bg-blue-600 hover:bg-blue-500 text-white py-2.5 rounded-lg font-semibold">
                Sign In
            </button>
        </form>
    </div>
</div>
PHP

# Logout page
mkdir -p app/logout
cat > app/logout/page.php <<'PHP'
<?php
setcookie('access', '', time() - 3600, '/');
setcookie('refresh', '', time() - 3600, '/');
\App\Core\Response::redirect('/');
PHP

# Admin dashboard page
mkdir -p app/admin
cat > app/admin/page.php <<'PHP'
<?php
use App\Core\DV;
use App\Core\DB;

DV::set('title', 'Admin Dashboard');

$userCount   = DB::table('users')->count();
$adminCount  = DB::table('users')->where('role', 'admin')->count();
$recentUsers = DB::table('users')->orderBy('id', 'DESC')->limit(5)->get();
?>
<div class="space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
            <div class="text-sm text-slate-400 mb-1">Total Users</div>
            <div class="text-3xl font-bold"><?= e($userCount) ?></div>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
            <div class="text-sm text-slate-400 mb-1">Admins</div>
            <div class="text-3xl font-bold"><?= e($adminCount) ?></div>
        </div>
    </div>

    <div class="rounded-2xl border border-slate-800 bg-slate-900/60 p-5">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Recent Users</h2>
            <button
                hx-get="/api/users"
                hx-target="#user-table"
                hx-swap="innerHTML"
                class="px-3 py-1.5 text-sm rounded-lg bg-blue-600 hover:bg-blue-500">
                Reload via HTMX
            </button>
        </div>
        <div id="user-table">
            <table class="w-full text-sm">
                <thead class="bg-slate-900/80">
                <tr>
                    <th class="px-3 py-2 text-left">Name</th>
                    <th class="px-3 py-2 text-left">Email</th>
                    <th class="px-3 py-2 text-left">Role</th>
                </tr>
                </thead>
                <tbody>
                <?php foreach($recentUsers as $u): ?>
                    <tr class="border-t border-slate-800">
                        <td class="px-3 py-2"><?= e($u['name']) ?></td>
                        <td class="px-3 py-2"><?= e($u['email']) ?></td>
                        <td class="px-3 py-2">
                            <span class="px-2 py-1 rounded text-xs <?= $u['role'] === 'admin' ? 'bg-red-500/20 text-red-300' : 'bg-slate-700/60 text-slate-100' ?>">
                                <?= e($u['role']) ?>
                            </span>
                        </td>
                    </tr>
                <?php endforeach; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>
PHP

# Simple errors
cat > resources/views/errors/404.php <<'PHP'
<!doctype html>
<html>
<head><meta charset="utf-8"><title>404</title></head>
<body>
<h1>404 - Not Found</h1>
<p><?= e($message ?? 'Page not found') ?></p>
</body>
</html>
PHP

cat > resources/views/errors/500.php <<'PHP'
<!doctype html>
<html>
<head><meta charset="utf-8"><title>500</title></head>
<body>
<h1>500 - Server Error</h1>
<p><?= e($message ?? 'Something went wrong') ?></p>
</body>
</html>
PHP

#==============================================================================
# 7. API ENDPOINTS (+server.php)
#==============================================================================

info "Creating API Endpoints..."

# Auth Login
cat > app/api/auth/login/+server.php <<'PHP'
<?php
use App\Core\Auth;
use App\Core\Response;

return [
    'post' => function($req) {
        $email    = $req->input('email');
        $password = $req->input('password');

        $tokens = Auth::attempt($email, $password);
        if ($tokens === false) {
            Response::redirect('/login?error=1');
        }

        $secure = filter_var(getenv('SECURE_COOKIES') ?: 'false', FILTER_VALIDATE_BOOLEAN);

        setcookie('access', $tokens['access'], [
            'expires'  => $tokens['expires'],
            'path'     => '/',
            'secure'   => $secure,
            'httponly' => false,
            'samesite' => 'Lax'
        ]);

        setcookie('refresh', $tokens['refresh'], [
            'expires'  => time() + (int)(getenv('JWT_REFRESH_TTL') ?: 604800),
            'path'     => '/',
            'secure'   => $secure,
            'httponly' => true,
            'samesite' => 'Lax'
        ]);

        Response::redirect('/admin');
    }
];
PHP

# Auth Logout
cat > app/api/auth/logout/+server.php <<'PHP'
<?php
use App\Core\Response;

return [
    'post' => function($req) {
        setcookie('access', '', time()-3600, '/');
        setcookie('refresh', '', time()-3600, '/');
        Response::json(['success' => true]);
    }
];
PHP

# Auth Refresh
cat > app/api/auth/refresh/+server.php <<'PHP'
<?php
use App\Core\Auth;
use App\Core\Response;

return [
    'post' => function($req) {
        $refresh = $_COOKIE['refresh'] ?? '';
        if (!$refresh) {
            Response::json(['error'=>'Missing refresh token'], 401);
        }
        $userId = Auth::validateRefreshToken($refresh);
        if (!$userId) {
            Response::json(['error'=>'Invalid refresh token'], 401);
        }
        $tokens = Auth::issueTokens($userId);
        $secure = filter_var(getenv('SECURE_COOKIES') ?: 'false', FILTER_VALIDATE_BOOLEAN);

        setcookie('access', $tokens['access'], [
            'expires'  => $tokens['expires'],
            'path'     => '/',
            'secure'   => $secure,
            'httponly' => false,
            'samesite' => 'Lax'
        ]);

        Response::json(['success'=>true]);
    }
];
PHP

# Users List/Create
cat > app/api/users/+server.php <<'PHP'
<?php
use App\Core\Response;
use App\Models\User;
use App\Core\ValidationException;

return [
    'get' => function($req) {
        $users = User::all();
        // If HTMX HTML requested
        if (stripos($_SERVER['HTTP_ACCEPT'] ?? '', 'text/html') !== false ||
            isset($_SERVER['HTTP_HX_REQUEST'])) {
            ob_start();
            ?>
            <table class="w-full text-sm">
                <thead class="bg-slate-900/80">
                <tr>
                    <th class="px-3 py-2 text-left">Name</th>
                    <th class="px-3 py-2 text-left">Email</th>
                    <th class="px-3 py-2 text-left">Role</th>
                </tr>
                </thead>
                <tbody>
                <?php foreach($users as $u): ?>
                    <tr class="border-t border-slate-800">
                        <td class="px-3 py-2"><?= e($u['name']) ?></td>
                        <td class="px-3 py-2"><?= e($u['email']) ?></td>
                        <td class="px-3 py-2">
                            <span class="px-2 py-1 rounded text-xs <?= $u['role'] === 'admin' ? 'bg-red-500/20 text-red-300' : 'bg-slate-700/60 text-slate-100' ?>">
                                <?= e($u['role']) ?>
                            </span>
                        </td>
                    </tr>
                <?php endforeach; ?>
                </tbody>
            </table>
            <?php
            $html = ob_get_clean();
            Response::html($html);
        } else {
            Response::json($users);
        }
    },

    'post' => function($req) {
        try {
            $data = $req->validate([
                'email'    => 'required|email',
                'name'     => 'required',
                'password' => 'required|min:8'
            ]);

            $id = User::create([
                'email'    => $data['email'],
                'name'     => $data['name'],
                'password' => password_hash($data['password'], PASSWORD_DEFAULT),
                'role'     => 'user'
            ]);

            Response::json(['id' => $id, 'message' => 'User created'], 201);
        } catch (ValidationException $e) {
            Response::json(['errors' => $e->errors], 422);
        }
    }
];
PHP

# Users Get/Update/Delete
mkdir -p app/api/users/[id]
cat > app/api/users/[id]/+server.php <<'PHP'
<?php
use App\Core\Response;
use App\Models\User;
use App\Core\ValidationException;

return [
    'get' => function($req) {
        $id   = $req->meta['params']['id'] ?? null;
        $user = $id ? User::find($id) : null;
        if (!$user) Response::json(['error'=>'Not found'], 404);
        Response::json($user);
    },

    'put' => function($req) {
        $id = $req->meta['params']['id'] ?? null;
        if (!$id) Response::json(['error'=>'Missing id'], 400);

        try {
            $data = $req->validate([
                'name'  => 'required',
                'email' => 'required|email'
            ]);
            User::updateUser($id, $data);
            Response::json(['message'=>'Updated']);
        } catch (ValidationException $e) {
            Response::json(['errors'=>$e->errors], 422);
        }
    },

    'delete' => function($req) {
        $id = $req->meta['params']['id'] ?? null;
        if (!$id) Response::json(['error'=>'Missing id'], 400);
        User::deleteUser($id);
        Response::json(['message'=>'Deleted']);
    }
];
PHP

#==============================================================================
# 8. MIGRATIONS & SEEDERS
#==============================================================================

info "Creating migrations and seeders..."

cat > database/migrations/001_create_users.sql <<'SQL'
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE,
    password TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'user',
    created_at INTEGER NOT NULL
);
SQL

cat > database/migrations/002_create_refresh_tokens.sql <<'SQL'
CREATE TABLE IF NOT EXISTS refresh_tokens (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    selector TEXT NOT NULL,
    validator_hash TEXT NOT NULL,
    expires_at INTEGER NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
SQL

cat > database/seeds/UsersSeeder.php <<'PHP'
<?php
use App\Core\DB;

$pdo = DB::getPdo();

$exists = $pdo->query("SELECT COUNT(*) FROM users")->fetchColumn();
if ((int)$exists === 0) {
    $stmt = $pdo->prepare("INSERT INTO users (name, email, password, role, created_at) VALUES (?, ?, ?, ?, ?)");
    $stmt->execute([
        'Admin User',
        'admin@example.com',
        password_hash('password', PASSWORD_DEFAULT),
        'admin',
        time()
    ]);
}
PHP

#==============================================================================
# 9. PUBLIC ENTRY POINT & CLI
#==============================================================================

info "Creating public index and CLI..."

cat > public/index.php <<'PHP'
<?php
declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

use App\Core\App;
use App\Core\Response;

try {
    $app = new App(dirname(__DIR__));
    $app->run();
} catch (Throwable $e) {
    if (getenv('APP_DEBUG') === 'true') {
        echo "<pre>" . htmlspecialchars((string)$e) . "</pre>";
    } else {
        Response::abort(500, 'Internal Server Error');
    }
}
PHP

cat > bastion <<'PHP'
#!/usr/bin/env php
<?php
require __DIR__ . '/vendor/autoload.php';

use App\Core\DB;

$argv = $_SERVER['argv'];
$cmd  = $argv[1] ?? null;

function bastion_help() {
    echo "Bastion CLI 0.1.0\n";
    echo "Commands:\n";
    echo "  run-dev     Start PHP dev server on :8000\n";
    echo "  migrate     Run all SQL migrations\n";
    echo "  seed        Run basic seeders\n";
    echo "\n";
}

if (!$cmd) {
    bastion_help();
    exit(0);
}

switch ($cmd) {
    case 'run-dev':
        echo "Starting PHP dev server at http://127.0.0.1:8000\n";
        passthru('php -S 127.0.0.1:8000 -t public');
        break;

    case 'migrate':
        echo "Running migrations...\n";
        $pdo = DB::getPdo();
        foreach (glob(__DIR__ . '/database/migrations/*.sql') as $file) {
            $sql = file_get_contents($file);
            if (trim($sql) !== '') {
                echo "  > " . basename($file) . "\n";
                $pdo->exec($sql);
            }
        }
        echo "Done.\n";
        break;

    case 'seed':
        echo "Running seeders...\n";
        foreach (glob(__DIR__ . '/database/seeds/*.php') as $file) {
            echo "  > " . basename($file) . "\n";
            require $file;
        }
        echo "Done.\n";
        break;

    default:
        bastion_help();
}
PHP
chmod +x bastion

# artisan shim (optional)
cat > artisan <<'PHP'
#!/usr/bin/env php
<?php
// Simple shim to keep old docs working
require __DIR__ . '/bastion';
PHP
chmod +x artisan

#==============================================================================
# 10. BASIC CSS (fallback)
#==============================================================================

cat > public/css/fallback.css <<'CSS'
body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
CSS

#==============================================================================
# DONE
#==============================================================================

success "Bastion PHP 0.1.0 project generated in ./$PROJECT"
echo
echo "Next steps:"
echo "  cd $PROJECT"
echo "  composer install"
echo "  ./bastion migrate"
echo "  ./bastion seed"
echo "  ./bastion run-dev"
echo
echo "Then open: http://127.0.0.1:8000"