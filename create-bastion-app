#!/usr/bin/env bash
#==============================================================================
# Bastion PHP Project Generator (Integrated)
# Creates a full Bastion PHP project with:
#  - Service Container, App, Router, DV view engine
#  - DB (PDO) with QueryBuilder, Logger, Response helpers
#  - Request, Auth (JWT), CSRF middleware, SecurityHeaders, RateLimit, AdminOnly
#  - User model, migrations, seeders (admin + demo user)
#  - Admin panel scaffold and API handlers
#  - Tailwind CSS setup + bastion CLI which replaces artisan (migrate, db:seed, serve, dev/build)
#  - Composer and npm package scaffolding
#
# Usage: ./create-php-app.sh <project-name>
#==============================================================================

set -euo pipefail

# Terminal colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

info(){ echo -e "${BLUE}ℹ${NC} $1"; }
success(){ echo -e "${GREEN}✓${NC} $1"; }
warn(){ echo -e "${YELLOW}⚠${NC} $1"; }
error(){ echo -e "${RED}✗${NC} $1"; exit 1; }

if [ "$#" -lt 1 ]; then
    echo "Usage: $0 <project-name>"
    exit 1
fi

PROJECT="$1"
ROOT="$(pwd)/$PROJECT"

info "Starting Bastion project generator for: $PROJECT"

if [ -e "$ROOT" ]; then
    error "Directory '$ROOT' already exists. Abort."
fi

# Basic prereqs
if ! command -v php >/dev/null 2>&1; then error "PHP is required."; fi
if ! command -v composer >/dev/null 2>&1; then warn "Composer not found. Composer steps will be skipped."; COMPOSER=false; else COMPOSER=true; fi
if ! command -v npm >/dev/null 2>&1; then warn "npm not found. npm steps will be skipped."; NPM=false; else NPM=true; fi

mkdir -p "$ROOT"
cd "$ROOT"

# Directory layout
info "Creating folders..."
mkdir -p app/core app/middleware app/models app/services app/admin app/admin/users app/admin/database app/admin/settings
mkdir -p resources/views/layouts resources/views/pages resources/views/errors resources/css
mkdir -p config database/migrations database/seeds public/css storage/db storage/logs storage/cache
touch storage/db/app.db
touch storage/logs/.gitkeep storage/cache/.gitkeep

# Generate keys
APP_KEY=$(openssl rand -base64 32 || php -r "echo base64_encode(random_bytes(32));")
JWT_SECRET=$(openssl rand -base64 32 || php -r "echo base64_encode(random_bytes(32));")

info "Generating configuration files..."

cat > .env <<ENV
APP_NAME="Bastion App"
APP_ENV=local
APP_KEY=$APP_KEY
APP_URL=http://localhost:9876

DB_CONNECTION=sqlite
DB_PATH=storage/db/app.db

JWT_SECRET=$JWT_SECRET
JWT_ACCESS_EXP=900
JWT_REFRESH_EXP=604800

CSRF_ENABLED=true
SECURE_COOKIES=false

LOG_LEVEL=debug
LOG_FILE=storage/logs/app.log
ENV

cat > config/style.php <<'PHP'
<?php
return [
    'theme' => env('THEME_MODE', 'system'),
    'useTailwind' => true,
    'tailwindMode' => 'build',
    'fallbackCss' => '/css/fallback.css',
];
PHP

cat > composer.json <<JSON
{
  "name": "bastionphp/app",
  "description": "Bastion PHP - Generated by create-php-app.sh",
  "type": "project",
  "require": {
    "php": "^8.0",
    "firebase/php-jwt": "^6.0"
  },
  "autoload": {
    "psr-4": {
      "App\\\\": "app/"
    },
    "files": [
      "app/core/helpers.php"
    ]
  }
}
JSON

cat > package.json <<JSON
{
  "private": true,
  "scripts": {
    "dev": "./bastion run-dev",
    "build": "./bastion run-build"
  },
  "devDependencies": {
    "tailwindcss": "^4.0.0-alpha",
    "@tailwindcss/cli": "^4.0.0-alpha",
    "browser-sync": "^3.0.0"
  }
}
JSON

# ==============================================================================
# CORE FILES
# ==============================================================================

info "Writing core PHP files..."

cat > app/core/helpers.php <<'PHP'
<?php
use App\Core\DV;

if (!function_exists('env')) {
    function env($key, $default = null) {
        $val = getenv($key);
        return $val !== false ? $val : $default;
    }
}

if (!function_exists('e')) {
    function e($value) {
        return htmlspecialchars((string)$value, ENT_QUOTES, 'UTF-8');
    }
}

if (!function_exists('view')) {
    function view($path, $data = []) {
        return DV::render($path, $data);
    }
}

if (!function_exists('logger')) {
    function logger(): \App\Core\Logger {
        static $l = null;
        if ($l === null) $l = new \App\Core\Logger();
        return $l;
    }
}

if (!function_exists('normalize_path')) {
    function normalize_path(string $uri): string {
        $path = parse_url($uri, PHP_URL_PATH) ?? '/';
        $segments = explode('/', $path);
        $safe = [];
        foreach ($segments as $segment) {
            if ($segment === '' || $segment === '.' || $segment === '..') continue;
            $safe[] = $segment;
        }
        return implode('/', $safe);
    }
}
PHP

cat > app/core/Container.php <<'PHP'
<?php
namespace App\Core;
class Container {
    protected array $bindings = [];
    protected array $instances = [];
    public function bind(string $key, callable $resolver): void { $this->bindings[$key] = $resolver; }
    public function singleton(string $key, callable $resolver): void {
        $this->bindings[$key] = function($c) use ($resolver) { static $object; if (!$object) $object = $resolver($c); return $object; };
    }
    public function resolve(string $key): mixed {
        if (isset($this->instances[$key])) return $this->instances[$key];
        if (isset($this->bindings[$key])) return $this->bindings[$key]($this);
        if (class_exists($key)) return new $key();
        throw new \Exception("No se pudo resolver el servicio: {$key}");
    }
}
PHP

cat > app/core/App.php <<'PHP'
<?php
namespace App\Core;
class App extends Container {
    private static App $instance;
    private Router $router;
    private array $middlewares = [];
    public function __construct(string $rootPath) {
        self::$instance = $this;
        $this->router = new Router($rootPath . '/app');
        $this->registerCoreServices();
    }
    public static function getInstance(): App { return self::$instance; }
    private function registerCoreServices(): void {
        $this->singleton(DB::class, fn() => new DB());
        $this->singleton(Auth::class, fn() => new Auth());
        $this->singleton(\App\Core\Logger::class, fn() => new \App\Core\Logger());
    }
    public function use(callable $middleware): void { $this->middlewares[] = $middleware; }
    public function run(): void {
        $request = new Request();
        $this->instances[Request::class] = $request;
        $handler = function($req) { return $this->router->dispatch($req); };
        foreach (array_reverse($this->middlewares) as $middleware) {
            $next = $handler;
            $handler = function($req) use ($middleware, $next) { return $middleware($req, $next); };
        }
        $handler($request);
    }
}
PHP

cat > app/core/Logger.php <<'PHP'
<?php
namespace App\Core;
class Logger {
    private string $logFile;
    private string $logLevel;
    private const LEVELS = ['debug'=>0,'info'=>1,'warning'=>2,'error'=>3];
    public function __construct() {
        $this->logFile = __DIR__ . '/../../' . env('LOG_FILE', 'storage/logs/app.log');
        $this->logLevel = env('LOG_LEVEL', 'info');
    }
    public function debug(string $m, array $c=[]){$this->log('debug',$m,$c);}
    public function info(string $m, array $c=[]){$this->log('info',$m,$c);}
    public function warning(string $m, array $c=[]){$this->log('warning',$m,$c);}
    public function error(string $m, array $c=[]){$this->log('error',$m,$c);}
    private function log(string $level, string $message, array $context): void {
        if (self::LEVELS[$level] < self::LEVELS[$this->logLevel]) return;
        $ts = date('Y-m-d H:i:s');
        $ctx = !empty($context) ? ' ' . json_encode($context) : '';
        $line = "[$ts] " . strtoupper($level) . ": $message$ctx\n";
        $dir = dirname($this->logFile);
        if (!is_dir($dir)) @mkdir($dir,0755,true);
        @file_put_contents($this->logFile, $line, FILE_APPEND | LOCK_EX);
    }
}
PHP

cat > app/core/Response.php <<'PHP'
<?php
namespace App\Core;
class Response {
    public static function json(mixed $data, int $code = 200): never {
        http_response_code($code); header('Content-Type: application/json'); echo json_encode($data); exit;
    }
    public static function html(string $content, int $code = 200): never {
        http_response_code($code); header('Content-Type: text/html; charset=UTF-8'); echo $content; exit;
    }
    public static function redirect(string $url, int $code = 302): never {
        $url = str_replace(["\r","\n"],'',$url); header("Location: $url",true,$code); exit;
    }
}
PHP

cat > app/core/DB.php <<'PHP'
<?php
namespace App\Core;
use PDO; use PDOException;
class DB {
    private static ?PDO $pdo = null;
    public static function pdo(): PDO {
        if (self::$pdo !== null) return self::$pdo;
        $connection = env('DB_CONNECTION','sqlite');
        try {
            if ($connection === 'sqlite') {
                $path = __DIR__ . '/../../' . env('DB_PATH','storage/db/app.db');
                $dsn = "sqlite:$path";
                self::$pdo = new PDO($dsn);
                self::$pdo->exec('PRAGMA journal_mode=WAL');
                self::$pdo->exec('PRAGMA synchronous=NORMAL');
            } elseif ($connection === 'mysql') {
                $host = env('DB_HOST','127.0.0.1');
                $port = env('DB_PORT','3306');
                $name = env('DB_DATABASE','app');
                $user = env('DB_USERNAME','root');
                $pass = env('DB_PASSWORD','');
                $dsn = "mysql:host=$host;port=$port;dbname=$name;charset=utf8mb4";
                self::$pdo = new PDO($dsn,$user,$pass);
            } else throw new \RuntimeException("Unsupported DB: $connection");
            self::$pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            self::$pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
        } catch (PDOException $e) { logger()->error("DB failed: " . $e->getMessage()); throw $e; }
        return self::$pdo;
    }
    public static function table(string $table): QueryBuilder { return new QueryBuilder($table); }
}
class QueryBuilder {
    private string $table; private array $wheres=[]; private array $bindings=[]; private ?int $limit=null; private ?int $offset=null;
    public function __construct(string $table){$this->table=$table;}
    public function where(string $col, mixed $val): self { $this->wheres[]="$col = ?"; $this->bindings[]=$val; return $this; }
    public function limit(int $n): self { $this->limit = $n; return $this; }
    public function offset(int $n): self { $this->offset = $n; return $this; }
    public function get(): array {
        $sql = "SELECT * FROM {$this->table}";
        if (!empty($this->wheres)) $sql .= " WHERE " . implode(' AND ', $this->wheres);
        if ($this->limit !== null) $sql .= " LIMIT {$this->limit}";
        if ($this->offset !== null) $sql .= " OFFSET {$this->offset}";
        $stmt = DB::pdo()->prepare($sql); $stmt->execute($this->bindings); return $stmt->fetchAll();
    }
    public function first(): ?array { $r = $this->limit(1)->get(); return $r[0] ?? null; }
    public function insert(array $data): int {
        $cols = array_keys($data); $ph = array_fill(0,count($cols),'?');
        $sql = sprintf("INSERT INTO %s (%s) VALUES (%s)", $this->table, implode(', ', $cols), implode(', ', $ph));
        $stmt = DB::pdo()->prepare($sql); $stmt->execute(array_values($data)); return (int)DB::pdo()->lastInsertId();
    }
}
PHP

cat > app/core/DV.php <<'PHP'
<?php
namespace App\Core;
class DV {
    protected static array $data = [];
    public static function set(string $k, mixed $v): void { self::$data[$k] = $v; }
    public static function render(string $path, array $local = []): string {
        $data = array_merge(self::$data, $local); extract($data, EXTR_SKIP);
        ob_start();
        $viewFile = __DIR__ . '/../../resources/views/' . $path . '.php';
        if (!file_exists($viewFile)) $viewFile = $path;
        if (file_exists($viewFile)) include $viewFile; else echo "View not found: $path";
        return ob_get_clean();
    }
}
PHP

cat > app/core/Theme.php <<'PHP'
<?php
namespace App\Core;
class Theme {
    public static function apply(): string {
        $config = require __DIR__ . '/../../config/style.php';
        $mode = $config['theme'] ?? 'system';
        if ($mode === 'dark') return 'class="dark"';
        if ($mode === 'light') return '';
        return <<<'HTML'
        onload="
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        "
HTML;
    }
}
PHP

cat > app/core/Request.php <<'PHP'
<?php
namespace App\Core;
class Request {
    public string $method; public string $path; public array $query; public array $body; public array $headers; public array $cookies; public array $files; public array $meta = []; private ?array $jsonData = null;
    public function __construct() {
        $this->method = $_SERVER['REQUEST_METHOD'] ?? 'GET';
        $this->path = normalize_path($_SERVER['REQUEST_URI'] ?? '/');
        $this->query = $_GET; $this->body = $_POST; $this->headers = $this->getHeaders(); $this->cookies = $_COOKIE; $this->files = $_FILES;
    }
    private function getHeaders(): array {
        if (function_exists('getallheaders')) return getallheaders() ?: [];
        $h = [];
        foreach ($_SERVER as $k=>$v) if (strpos($k,'HTTP_')===0) $h[str_replace(' ','-',ucwords(str_replace('_',' ',strtolower(substr($k,5)))))] = $v;
        return $h;
    }
    public function json(): array {
        if ($this->jsonData !== null) return $this->jsonData;
        $ct = $this->headers['Content-Type'] ?? '';
        if (stripos($ct,'application/json')!==false) $this->jsonData = json_decode(file_get_contents('php://input'), true) ?? [];
        else $this->jsonData = [];
        return $this->jsonData;
    }
    public function input(string $k, mixed $d=null): mixed { if (isset($this->body[$k])) return $this->body[$k]; $j = $this->json(); return $j[$k] ?? $d; }
    public function isAjax(): bool { return ($this->headers['X-Requested-With'] ?? '') === 'XMLHttpRequest'; }
    public function isJson(): bool { return stripos($this->headers['Content-Type'] ?? '', 'application/json') !== false; }
    public function validate(array $rules): array { $errors=[]; foreach($rules as $field=>$rule){ $rl=explode('|',$rule); $val=$this->input($field); foreach($rl as $r){ if($r==='required' && empty($val)) $errors[$field][]="$field is required"; if($r==='email' && !empty($val) && !filter_var($val,FILTER_VALIDATE_EMAIL)) $errors[$field][]="$field must be a valid email"; if(strpos($r,'min:')===0){$min=(int)substr($r,4); if(strlen($val)<$min) $errors[$field][]="$field must be at least $min characters";} if(strpos($r,'max:')===0){$max=(int)substr($r,4); if(strlen($val)>$max) $errors[$field][]="$field must not exceed $max characters";}} } if(!empty($errors)) throw new \Exception('Validation failed: '.json_encode($errors)); return array_intersect_key($this->body, array_flip(array_keys($rules))); }
}
PHP

cat > app/core/Auth.php <<'PHP'
<?php
namespace App\Core;
use Firebase\JWT\JWT; use Firebase\JWT\Key;
class Auth {
    public static function issueTokens(int|string $userId): array {
        $now=time(); $secret=env('JWT_SECRET'); $accessExp=(int)env('JWT_ACCESS_EXP',900); $refreshExp=(int)env('JWT_REFRESH_EXP',604800);
        if (!$secret) throw new \RuntimeException('JWT_SECRET not configured');
        $accessPayload=['sub'=>$userId,'iat'=>$now,'exp'=>$now+$accessExp,'type'=>'access'];
        $accessToken = JWT::encode($accessPayload, $secret, 'HS256');
        $selector = bin2hex(random_bytes(16)); $validator = bin2hex(random_bytes(32)); $validatorHash = hash('sha256',$validator); $expiresAt = $now + $refreshExp;
        DB::pdo()->prepare('INSERT INTO refresh_tokens (user_id, selector, validator_hash, expires_at) VALUES (?, ?, ?, ?)')->execute([$userId,$selector,$validatorHash,$expiresAt]);
        $refreshToken = "$selector:$validator";
        return ['access'=>$accessToken,'refresh'=>$refreshToken,'expires'=>$accessPayload['exp']];
    }
    public static function validate(string $token): ?object {
        try { $secret=env('JWT_SECRET'); if (!$secret) return null; return JWT::decode($token, new Key($secret,'HS256')); } catch(\Throwable $e){ logger()->debug("JWT fail: ".$e->getMessage()); return null; }
    }
    public static function validateRefreshToken(string $token): ?int {
        $parts = explode(':',$token); if(count($parts)!==2) return null; [$selector,$validator]=$parts;
        $stmt=DB::pdo()->prepare('SELECT * FROM refresh_tokens WHERE selector = ?'); $stmt->execute([$selector]); $t=$stmt->fetch(); if(!$t) return null;
        DB::pdo()->prepare('DELETE FROM refresh_tokens WHERE selector = ?')->execute([$selector]);
        if (time() > $t['expires_at']) return null;
        if (!hash_equals($t['validator_hash'], hash('sha256',$validator))) return null;
        return $t['user_id'];
    }
    public static function loadUser(Request $req, callable $next): mixed {
        $token=null; $authHeader = $req->headers['Authorization'] ?? '';
        if (preg_match('/Bearer\s+(.+)/',$authHeader,$m)) $token=$m[1];
        if (!$token && isset($req->cookies['access'])) $token=$req->cookies['access'];
        if ($token) {
            $decoded = self::validate($token);
            if ($decoded && isset($decoded->sub) && ($decoded->type ?? '') === 'access') {
                $user = \App\Models\User::find($decoded->sub);
                $GLOBALS['auth_user'] = $user; $req->meta['user']=$user;
            }
        }
        return $next($req);
    }
    public static function requireAuth(Request $req, callable $next): mixed {
        if (!isset($GLOBALS['auth_user'])) {
            if ($req->isJson()) Response::json(['error'=>'Unauthorized'],401);
            else redirect('/login');
        }
        return $next($req);
    }
}
PHP

cat > app/core/CSRF.php <<'PHP'
<?php
namespace App\Core;
class CSRF {
    public static function token(): string {
        if (session_status() !== PHP_SESSION_ACTIVE) { if (PHP_SAPI !== 'cli') session_start(); }
        if (!isset($_SESSION['_csrf'])) $_SESSION['_csrf'] = bin2hex(random_bytes(32));
        return $_SESSION['_csrf'];
    }
    public static function verify(Request $req, callable $next): mixed {
        if (in_array($req->method, ['POST','PUT','PATCH','DELETE'])) {
            if ($req->isJson()) return $next($req);
            $sent = $req->input('_csrf') ?? $req->headers['X-CSRF-Token'] ?? null;
            $sess = $_SESSION['_csrf'] ?? '';
            if (!$sent || !hash_equals((string)$sess, (string)$sent)) { logger()->warning('CSRF mismatch',['ip'=>$_SERVER['REMOTE_ADDR']??'unknown','path'=>$req->path]); abort(403,'CSRF token mismatch'); }
        }
        return $next($req);
    }
}
PHP

# ==============================================================================
# MIDDLEWARE
# ==============================================================================

info "Writing middleware..."

cat > app/middleware/SecurityHeaders.php <<'PHP'
<?php
namespace App\Middleware;
use App\Core\Request;
class SecurityHeaders {
    public static function handle(Request $req, callable $next): mixed {
        $nonce = base64_encode(random_bytes(16));
        $req->meta['csp_nonce'] = $nonce;
        header("X-Frame-Options: SAMEORIGIN");
        header("X-Content-Type-Options: nosniff");
        header("X-XSS-Protection: 1; mode=block");
        header("Referrer-Policy: strict-origin-when-cross-origin");
        $csp = "default-src 'self'; script-src 'self' 'nonce-{$nonce}' https://unpkg.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;";
        header("Content-Security-Policy: $csp");
        if (env('SECURE_COOKIES', false)) header("Strict-Transport-Security: max-age=31536000; includeSubDomains");
        return $next($req);
    }
}
PHP

cat > app/middleware/RateLimit.php <<'PHP'
<?php
namespace App\Middleware;
use App\Core\Request;
use App\Core\Response;
class RateLimit {
    private static array $attempts = [];
    public static function limit(int $maxAttempts = 5, int $decayMinutes = 1): callable {
        return function(Request $req, callable $next) use ($maxAttempts,$decayMinutes) {
            $ip = $_SERVER['REMOTE_ADDR'] ?? 'unknown'; $key = md5($ip.$req->path); $now=time();
            self::$attempts[$key] = array_filter(self::$attempts[$key] ?? [], fn($t)=> $t > $now - ($decayMinutes*60));
            if (count(self::$attempts[$key] ?? []) >= $maxAttempts) {
                logger()->warning('Rate limit', ['ip'=>$ip,'path'=>$req->path]);
                if ($req->isJson()) Response::json(['error'=>'Too many requests'],429);
                http_response_code(429); echo 'Too many requests'; exit;
            }
            self::$attempts[$key][] = $now;
            return $next($req);
        };
    }
}
PHP

cat > app/middleware/AdminOnly.php <<'PHP'
<?php
namespace App\Middleware;
use App\Core\Request;
use App\Core\Response;
class AdminOnly {
    public static function handle(Request $req, callable $next): mixed {
        $user = $GLOBALS['auth_user'] ?? null;
        if (!$user || $user['role'] !== 'admin') {
            if ($req->isJson()) Response::json(['error'=>'Admin access required'],403);
            $_SESSION['error'] = 'Admin access required'; redirect('/login');
        }
        return $next($req);
    }
}
PHP

# ==============================================================================
# MODELS
# ==============================================================================

info "Writing User model..."

cat > app/models/User.php <<'PHP'
<?php
namespace App\Models;
use App\Core\DB;
class User {
    public static function find(int|string $id): ?array {
        $stmt = DB::pdo()->prepare('SELECT id,email,name,role,created_at FROM users WHERE id = ?'); $stmt->execute([$id]); $u = $stmt->fetch(); return $u ?: null;
    }
    public static function findByEmail(string $email): ?array {
        $stmt = DB::pdo()->prepare('SELECT * FROM users WHERE email = ?'); $stmt->execute([$email]); $u = $stmt->fetch(); return $u ?: null;
    }
    public static function all(): array { return DB::pdo()->query('SELECT id,email,name,role,created_at FROM users ORDER BY created_at DESC')->fetchAll(); }
    public static function create(array $data): int {
        $stmt = DB::pdo()->prepare('INSERT INTO users (email,password,name,role,created_at) VALUES (?,?,?,?,?)');
        $stmt->execute([$data['email'], password_hash($data['password'], PASSWORD_DEFAULT), $data['name'] ?? '', $data['role'] ?? 'user', time()]);
        return (int)DB::pdo()->lastInsertId();
    }
    public static function update(int|string $id, array $data): bool {
        $stmt = DB::pdo()->prepare('UPDATE users SET email = ?, name = ?, role = ? WHERE id = ?');
        return $stmt->execute([$data['email'],$data['name'],$data['role'],$id]);
    }
    public static function delete(int|string $id): bool {
        $stmt = DB::pdo()->prepare('DELETE FROM users WHERE id = ?'); return $stmt->execute([$id]);
    }
}
PHP

# ==============================================================================
# MIGRATIONS & SEEDERS
# ==============================================================================

info "Creating migrations and seeders..."

cat > database/migrations/001_create_users_table.php <<'PHP'
<?php
use App\Core\DB;
$pdo = DB::pdo();
$pdo->exec("
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    name TEXT NOT NULL,
    role TEXT DEFAULT 'user',
    created_at INTEGER NOT NULL
)
");
echo "✓ Created users table\n";
PHP

cat > database/migrations/002_create_migrations_table.php <<'PHP'
<?php
use App\Core\DB;
$pdo = DB::pdo();
$pdo->exec("
CREATE TABLE IF NOT EXISTS migrations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    migration TEXT UNIQUE NOT NULL,
    executed_at INTEGER NOT NULL
)
");
echo "✓ Created migrations table\n";
PHP

cat > database/migrations/003_create_refresh_tokens_table.php <<'PHP'
<?php
use App\Core\DB;
$pdo = DB::pdo();
$pdo->exec("
CREATE TABLE IF NOT EXISTS refresh_tokens (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    selector TEXT UNIQUE NOT NULL,
    validator_hash TEXT NOT NULL,
    expires_at INTEGER NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
)
");
echo "✓ Created refresh_tokens table\n";
PHP

cat > database/seeds/UserSeeder.php <<'PHP'
<?php
use App\Core\DB;
$pdo = DB::pdo();
$stmt = $pdo->prepare('SELECT id FROM users WHERE email = ?');
$stmt->execute(['admin@example.com']);
if (!$stmt->fetch()) {
    $stmt = $pdo->prepare('INSERT INTO users (email,password,name,role,created_at) VALUES (?,?,?,?,?)');
    $stmt->execute(['admin@example.com', password_hash('password', PASSWORD_DEFAULT), 'Admin User', 'admin', time()]);
    echo "✓ Created admin (admin@example.com / password)\n";
} else { echo "• Admin exists\n"; }
$stmt = $pdo->prepare('SELECT id FROM users WHERE email = ?');
$stmt->execute(['user@example.com']);
if (!$stmt->fetch()) {
    $stmt = $pdo->prepare('INSERT INTO users (email,password,name,role,created_at) VALUES (?,?,?,?,?)');
    $stmt->execute(['user@example.com', password_hash('password', PASSWORD_DEFAULT), 'Demo User', 'user', time()]);
    echo "✓ Created demo user (user@example.com / password)\n";
} else { echo "• Demo exists\n"; }
PHP

# ==============================================================================
# ADMIN PANEL & API HANDLERS
# ==============================================================================

info "Creating admin pages and API handlers..."

cat > app/admin/page.php <<'PHP'
<?php
use App\Core\DB;
$title = 'Admin Dashboard';
$pdo = DB::pdo();
$userCount = $pdo->query('SELECT COUNT(*) FROM users')->fetchColumn();
$adminCount = $pdo->query('SELECT COUNT(*) FROM users WHERE role = "admin"')->fetchColumn();
$recentUsers = DB::table('users')->limit(5)->get();
?>
<div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Admin Dashboard</h1>
    <div>Total users: <?= e($userCount) ?> | Admins: <?= e($adminCount) ?></div>
    <h2 class="mt-6">Recent users</h2>
    <ul>
        <?php foreach ($recentUsers as $u): ?>
            <li><?= e($u['id']) ?> - <?= e($u['email']) ?> (<?= e($u['role']) ?>)</li>
        <?php endforeach; ?>
    </ul>
</div>
PHP

cat > app/admin/users/page.php <<'PHP'
<?php
use App\Core\DB;
$title = 'User Management';
$users = DB::table('users')->get();
?>
<h1>User Management</h1>
<table>
<thead><tr><th>ID</th><th>Email</th><th>Name</th><th>Role</th></tr></thead>
<tbody>
<?php foreach ($users as $u): ?>
<tr><td><?= e($u['id']) ?></td><td><?= e($u['email']) ?></td><td><?= e($u['name']) ?></td><td><?= e($u['role']) ?></td></tr>
<?php endforeach; ?>
</tbody>
</table>
PHP

cat > app/admin/users/+server.php <<'PHP'
<?php
use App\Core\DB;
use App\Core\Response;
use App\Core\Request;
return [
    'get' => function(Request $req) {
        if ($req->isJson()) {
            $users = DB::pdo()->query('SELECT id,email,name,role,created_at FROM users ORDER BY created_at DESC')->fetchAll();
            Response::json($users);
        } else {
            $title = 'User Management';
            ob_start(); require __DIR__ . '/page.php'; $content = ob_get_clean();
            $layout = __DIR__ . '/../layout.php'; if (file_exists($layout)) require $layout; else echo $content;
        }
    },
    'post' => function(Request $req) {
        $email=$req->input('email'); $password=$req->input('password'); $name=$req->input('name',''); $role=$req->input('role','user');
        if (!$email||!$password) Response::json(['error'=>'email and password required'],400);
        $stmt=DB::pdo()->prepare('SELECT id FROM users WHERE email = ?'); $stmt->execute([$email]); if ($stmt->fetch()) Response::json(['error'=>'email exists'],409);
        DB::pdo()->prepare('INSERT INTO users (email,password,name,role,created_at) VALUES (?,?,?,?,?)')->execute([$email,password_hash($password,PASSWORD_DEFAULT),$name,$role,time()]);
        Response::json(['ok'=>true],201);
    },
    'put' => function(Request $req) {
        $id=$req->input('id'); $email=$req->input('email'); $name=$req->input('name',''); $role=$req->input('role','user');
        if (!$id||!$email) Response::json(['error'=>'id and email required'],400);
        DB::pdo()->prepare('UPDATE users SET email = ?, name = ?, role = ? WHERE id = ?')->execute([$email,$name,$role,$id]);
        Response::json(['ok'=>true]);
    },
    'delete' => function(Request $req) {
        $id=$req->input('id'); if (!$id) Response::json(['error'=>'id required'],400);
        DB::pdo()->prepare('DELETE FROM users WHERE id = ?')->execute([$id]);
        Response::json(['ok'=>true]);
    }
];
PHP

# ==============================================================================
# VIEWS & ASSETS
# ==============================================================================

info "Creating default views and CSS..."

cat > resources/views/layouts/main.php <<'PHP'
<?php use App\Core\Theme; ?>
<!doctype html>
<html lang="en" <?= Theme::apply() ?>>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title><?= $title ?? 'Bastion' ?></title>
<link rel="stylesheet" href="/css/app.css">
</head>
<body>
<nav><a href="/">Home</a> | <a href="/admin">Admin</a></nav>
<main><?= $content ?></main>
</body>
</html>
PHP

cat > resources/css/app.css <<'CSS'
/* Minimal Tailwind entry (real Tailwind builds will replace) */
body{font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",Arial;}
CSS

cat > app/page.php <<'PHP'
<?php
use App\Core\DV;
DV::set('title','Welcome to Bastion');
?>
<div style="max-width:800px;margin:3rem auto">
  <h1>Bastion PHP</h1>
  <p>Edit app/page.php to start building.</p>
</div>
PHP

# ==============================================================================
# BOOTSTRAP & PUBLIC ENTRYPOINT
# ==============================================================================

info "Creating bootstrap and front controller..."

cat > app/bootstrap.php <<'PHP'
<?php
$envFile = __DIR__ . '/../.env';
if (file_exists($envFile)) {
    $lines = file($envFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    foreach ($lines as $line) {
        $line = trim($line);
        if ($line === '' || strpos($line,'#')===0) continue;
        if (strpos($line,'=')===false) continue;
        list($k,$v) = explode('=', $line,2);
        $v = trim($v);
        if (preg_match('/^([\'"])(.*)\1$/',$v,$m)) $v = $m[2];
        putenv(trim($k).'='.trim($v));
        $_ENV[trim($k)] = trim($v);
    }
}
if (session_status() === PHP_SESSION_NONE && PHP_SAPI !== 'cli') {
    session_start(['cookie_httponly'=>true,'cookie_samesite'=>'Lax','cookie_secure'=>env('SECURE_COOKIES',false)]);
}
date_default_timezone_set(env('APP_TIMEZONE','UTC'));
PHP

cat > public/index.php <<'PHP'
<?php
require_once __DIR__ . '/../vendor/autoload.php';
require_once __DIR__ . '/../app/bootstrap.php';
use App\Core\App;
use App\Core\Request;
$app = new App(__DIR__ . '/..');
$request = new Request();
$app->use([\App\Middleware\SecurityHeaders::class, 'handle']);
if (env('CSRF_ENABLED', true)) $app->use([\App\Core\CSRF::class, 'verify']);
$app->use([\App\Core\Auth::class, 'loadUser']);
if ($request->path === 'admin' || str_starts_with($request->path, 'admin/')) {
    $app->use([\App\Middleware\AdminOnly::class, 'handle']);
}
$app->run();
PHP

# ==============================================================================
# BASTION CLI (replaces artisan)
# ==============================================================================

info "Creating bastion CLI (replaces artisan)..."

cat > bastion <<'BASH'
#!/usr/bin/env php
<?php
/**
 * Bastion CLI - integrated (migrate, db:seed, serve, dev/build)
 */
$cwd = __DIR__;
$cmd = $argv[1] ?? 'help';
function php_require_bootstrap(){ require __DIR__ . '/vendor/autoload.php'; require __DIR__ . '/app/bootstrap.php'; }
switch ($cmd) {
    case 'run-dev':
        echo "[BASTION] Starting dev environment\n";
        $HOST='127.0.0.1'; $PORT_PUBLIC=9876; $PORT_INTERNAL=8000;
        $php="php -S $HOST:$PORT_INTERNAL -t public";
        $tw="npx @tailwindcss/cli -i resources/css/app.css -o public/css/app.css --watch";
        $bs="npx browser-sync start --proxy '$HOST:$PORT_INTERNAL' --files 'app/**/*.php, resources/**/*.php, public/css/*.css' --port $PORT_PUBLIC --no-open --no-ui";
        $procs = [
            ['name'=>'PHP','cmd'=>$php,'color'=>"\033[90m"],
            ['name'=>'CSS','cmd'=>$tw,'color'=>"\033[36m"],
            ['name'=>'SYNC','cmd'=>$bs,'color'=>"\033[32m"]
        ];
        $des=[0=>['pipe','r'],1=>['pipe','w'],2=>['pipe','w']];
        $running=[];
        foreach($procs as $p){ $r = proc_open($p['cmd'],$des,$pipes); if(is_resource($r)){ stream_set_blocking($pipes[1],0); stream_set_blocking($pipes[2],0); $running[]=['res'=>$r,'pipes'=>$pipes,'data'=>$p]; } }
        echo "Open http://localhost:9876\n";
        while(count($running)>0){
            foreach($running as $k=>$r){
                foreach([1,2] as $i){
                    $out = stream_get_contents($r['pipes'][$i]);
                    if($out) foreach(explode("\n",$out) as $l) if(trim($l)) echo "{$r['data']['color']}[{$r['data']['name']}]\033[0m $l\n";
                }
                if(!proc_get_status($r['res'])['running']) unset($running[$k]);
            }
            usleep(100000);
        }
        break;
    case 'run-build':
        echo "[BASTION] Building assets\n";
        passthru("npx @tailwindcss/cli -i resources/css/app.css -o public/css/app.css --minify", $ret);
        echo $ret===0 ? "[OK] Build complete\n" : "[ERROR] Build failed\n";
        break;
    case 'migrate':
        php_require_bootstrap();
        echo "Running migrations...\n";
        $m = glob(__DIR__ . '/database/migrations/*.php'); sort($m);
        $pdo = \App\Core\DB::pdo();
        $executed = [];
        try { $stmt = $pdo->query('SELECT migration FROM migrations'); $executed = $stmt->fetchAll(PDO::FETCH_COLUMN); } catch(\Throwable $e) {}
        foreach($m as $f){ $name = basename($f); if(in_array($name,$executed)){ echo "Skipping $name\n"; continue; } echo "-> $name\n"; require $f; try{ $stmt = $pdo->prepare('INSERT INTO migrations (migration, executed_at) VALUES (?, ?)'); $stmt->execute([$name,time()]); }catch(\Throwable$e){} }
        echo "Migrations done\n";
        break;
    case 'db:seed':
        php_require_bootstrap();
        echo "Running seeders...\n";
        $s = glob(__DIR__ . '/database/seeds/*.php'); sort($s);
        foreach($s as $f){ echo "-> " . basename($f) . "\n"; require $f; }
        echo "Seeding done\n";
        break;
    case 'serve':
        $host = $argv[2] ?? '127.0.0.1'; $port = $argv[3] ?? '9876';
        echo "Serving on http://$host:$port\n";
        passthru(PHP_BINARY . " -S $host:$port -t public");
        break;
    case 'key:generate':
        $k = base64_encode(random_bytes(32)); $env = file_get_contents(__DIR__ . '/.env');
        if (strpos($env,'APP_KEY=')!==false) $env = preg_replace('/APP_KEY=.*/',"APP_KEY={$k}",$env); else $env .= PHP_EOL . "APP_KEY={$k}\n";
        file_put_contents(__DIR__ . '/.env', $env); echo "APP_KEY generated\n";
        break;
    case 'help':
    default:
        echo "Bastion CLI - usage:\n  ./bastion run-dev\n  ./bastion run-build\n  ./bastion migrate\n  ./bastion db:seed\n  ./bastion serve [host] [port]\n  ./bastion key:generate\n";
        break;
}
PHP
chmod +x bastion

# Make sure bastion is used instead of artisan (leave artisan option as backup)
if [ -f artisan ]; then
    warn "artisan exists in project root. bastion is primary CLI. Remove artisan if you want to fully replace it."
fi

# ==============================================================================
# INSTALL DEPENDENCIES (best effort, do not fail on network issues)
# ==============================================================================

info "Installing dependencies (best effort)..."
if [ "$COMPOSER" = true ]; then
    composer install --no-interaction --quiet || warn "composer install failed — run it manually."
fi
if [ "$NPM" = true ]; then
    npm install --silent || warn "npm install failed — run it manually."
fi

# Set permissions
chmod +x bastion || true
chmod -R 755 storage || true
[ -f storage/db/app.db ] && chmod 664 storage/db/app.db || true

success "Project $PROJECT created."

cat <<MSG

Next steps (in $PROJECT):
  cd $PROJECT
  ./bastion migrate
  ./bastion db:seed
  ./bastion run-dev

Notes:
- bastion is the new CLI (replaces artisan). It supports migrate, db:seed, serve, run-dev, run-build, key:generate.
- Change JWT_SECRET and APP_KEY in .env before production.
- If you want artisan as backup, keep it; bastion is primary.

If you want, I can:
 - produce a git patch of these changes,
 - further flesh out admin UI (forms) wired to the API endpoints,
 - or remove artisan automatically.

MSG

exit 0
