#!/usr/bin/env bash
#==============================================================================
# Bastion PHP Framework Generator v3.0 (Enterprise Architecture)
#
# A modern, file-based PHP framework featuring:
# - Service Container (Dependency Injection)
# - DV (Data View) Rendering Engine
# - File-based Routing
# - Tailwind CSS v4 (Oxide Engine)
# - JWT Auth & Admin Panel
#==============================================================================

set -euo pipefail

#------------------------------------------------------------------------------
# Helpers & Colors
#------------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${BLUE}ℹ${NC} $1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1"; exit 1; }

#------------------------------------------------------------------------------
# Argument Parsing
#------------------------------------------------------------------------------
usage() {
    cat <<EOF
Usage: $0 <project-name> [options]

Options:
  --minimal      Create minimal structure
  --with-auth    Include Auth system
  --full-stack   Include Auth, API, and Admin Panel
  --help         Show this message
EOF
    exit 0
}

MINIMAL=false
WITH_AUTH=true
FULL_STACK=false

if [ "$#" -lt 1 ]; then usage; fi
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then usage; fi

PROJECT="$1"
shift

while [ "$#" -gt 0 ]; do
    case "$1" in
        --minimal)     MINIMAL=true; WITH_AUTH=false; shift ;;
        --with-auth)   WITH_AUTH=true; shift ;;
        --full-stack)  FULL_STACK=true; WITH_AUTH=true; shift ;;
        *)             error "Unknown option: $1";;
    esac
done

ROOT="$(pwd)/$PROJECT"

#------------------------------------------------------------------------------
# Checks & Init
#------------------------------------------------------------------------------
info "Running pre-flight checks..."
if [ -d "$ROOT" ]; then error "Directory '$PROJECT' already exists."; fi
if ! command -v php >/dev/null; then error "PHP is required."; fi
if ! command -v composer >/dev/null; then error "Composer is required."; fi
if ! command -v npm >/dev/null; then error "Node.js/NPM is required for Tailwind 4."; fi

info "Creating project: $PROJECT"
mkdir -p "$ROOT"
cd "$ROOT"

# Structure
mkdir -p app/Core app/Middleware app/Models app/Services
mkdir -p resources/views/layouts resources/views/pages resources/views/errors resources/css
mkdir -p config database/migrations database/seeds
mkdir -p public/css storage/db storage/logs
touch storage/db/app.db

APP_KEY=$(openssl rand -base64 32)
JWT_SECRET=$(openssl rand -base64 32)

#------------------------------------------------------------------------------
# 1. Configuration (.env & Composer)
#------------------------------------------------------------------------------
info "Generating configuration..."

cat > .env <<ENV
APP_NAME="Bastion Enterprise"
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost:9876
APP_KEY=$APP_KEY

# Database
DB_CONNECTION=sqlite
DB_PATH=storage/db/app.db

# Auth
JWT_SECRET=$JWT_SECRET
JWT_TTL=3600
JWT_REFRESH_TTL=604800

# Security
CSRF_ENABLED=true
SECURE_COOKIES=false

# Theme (system, light, dark)
THEME_MODE=system
ENV

cat > config/style.php <<'PHP'
<?php
return [
    'theme' => env('THEME_MODE', 'system'),
];
PHP

cat > composer.json <<JSON
{
    "name": "bastion/app",
    "description": "Bastion PHP v3 - Enterprise Architecture",
    "type": "project",
    "require": {
        "php": "^8.1",
        "firebase/php-jwt": "^6.0"
    },
    "autoload": {
        "psr-4": {
            "App\\": "app/"
        },
        "files": [
            "app/Core/helpers.php"
        ]
    }
}
JSON

#------------------------------------------------------------------------------
# 2. Core Architecture (The Brains)
#------------------------------------------------------------------------------
info "Building Core Architecture..."

# --- CONTAINER ---
cat > app/Core/Container.php <<'PHP'
<?php
namespace App\Core;

/**
 * Dependency Injection Container.
 * Manages class instances and dependencies.
 */
class Container
{
    protected array $bindings = [];
    protected array $instances = [];

    public function bind(string $key, callable $resolver): void {
        $this->bindings[$key] = $resolver;
    }

    public function singleton(string $key, callable $resolver): void {
        $this->bindings[$key] = function ($c) use ($resolver) {
            static $object;
            if (!$object) $object = $resolver($c);
            return $object;
        };
    }

    public function resolve(string $key): mixed {
        if (isset($this->instances[$key])) return $this->instances[$key];
        if (isset($this->bindings[$key])) return $this->bindings[$key]($this);
        if (class_exists($key)) return new $key();
        throw new \Exception("Cannot resolve service: {$key}");
    }
}
PHP

# --- APP ---
cat > app/Core/App.php <<'PHP'
<?php
namespace App\Core;

class App extends Container
{
    private static App $instance;
    private Router $router;
    private array $middlewares = [];

    public function __construct(string $rootPath) {
        self::$instance = $this;
        $this->router = new Router($rootPath . '/app');
        $this->registerServices();
    }

    public static function getInstance(): App {
        return self::$instance;
    }

    private function registerServices(): void {
        $this->singleton(DB::class, fn() => new DB());
        $this->singleton(Auth::class, fn() => new Auth());
    }

    public function use(callable $middleware): void {
        $this->middlewares[] = $middleware;
    }

    public function run(): void {
        $request = new Request();
        $this->instances[Request::class] = $request;

        $handler = fn($req) => $this->router->dispatch($req);

        foreach (array_reverse($this->middlewares) as $mw) {
            $next = $handler;
            $handler = function($req) use ($mw, $next) {
                // If middleware is a class name, resolve it
                if (is_string($mw)) {
                    $instance = App::getInstance()->resolve($mw);
                    return $instance->handle($req, $next);
                }
                return $mw($req, $next);
            };
        }

        $handler($request);
    }
}
PHP

# --- DB & QUERY BUILDER ---
cat > app/Core/DB.php <<'PHP'
<?php
namespace App\Core;
use PDO;
use PDOException;

class DB {
    private PDO $pdo;

    public function __construct() {
        $conn = env('DB_CONNECTION', 'sqlite');
        try {
            if ($conn === 'sqlite') {
                $path = __DIR__ . '/../../' . env('DB_PATH');
                $this->pdo = new PDO("sqlite:$path");
                $this->pdo->exec('PRAGMA journal_mode=WAL');
            } else {
                // MySQL stub
            }
            $this->pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            $this->pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
        } catch (PDOException $e) {
            die("Database Config Error: " . $e->getMessage());
        }
    }

    public function query(string $table): QueryBuilder {
        return new QueryBuilder($this->pdo, $table);
    }

    public function getPdo(): PDO { return $this->pdo; }

    // Facade Magic
    public static function __callStatic($method, $args) {
        $instance = App::getInstance()->resolve(self::class);
        if ($method === 'table') return $instance->query(...$args);
        return $instance->$method(...$args);
    }
}

class QueryBuilder {
    private PDO $pdo;
    private string $table;
    private array $wheres = [];
    private array $bindings = [];
    private ?int $limit = null;
    private array $orderBy = [];

    public function __construct(PDO $pdo, string $table) {
        $this->pdo = $pdo;
        $this->table = $table;
    }

    public function where(string $col, mixed $val): self {
        $this->wheres[] = "$col = ?";
        $this->bindings[] = $val;
        return $this;
    }

    public function limit(int $limit): self {
        $this->limit = $limit;
        return $this;
    }

    public function orderBy(string $col, string $dir = 'ASC'): self {
        $this->orderBy[] = "$col $dir";
        return $this;
    }

    public function get(): array {
        $sql = "SELECT * FROM {$this->table}";
        if ($this->wheres) $sql .= " WHERE " . implode(' AND ', $this->wheres);
        if ($this->orderBy) $sql .= " ORDER BY " . implode(', ', $this->orderBy);
        if ($this->limit) $sql .= " LIMIT {$this->limit}";
        
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute($this->bindings);
        return $stmt->fetchAll();
    }

    public function first(): ?array {
        $this->limit(1);
        $res = $this->get();
        return $res[0] ?? null;
    }

    public function insert(array $data): int {
        $keys = array_keys($data);
        $fields = implode(', ', $keys);
        $placeholders = implode(', ', array_fill(0, count($keys), '?'));
        
        $sql = "INSERT INTO {$this->table} ($fields) VALUES ($placeholders)";
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute(array_values($data));
        return (int)$this->pdo->lastInsertId();
    }
    
    public function update(array $data): bool {
        $set = implode(', ', array_map(fn($k) => "$k = ?", array_keys($data)));
        $sql = "UPDATE {$this->table} SET $set";
        if ($this->wheres) $sql .= " WHERE " . implode(' AND ', $this->wheres);
        
        $stmt = $this->pdo->prepare($sql);
        return $stmt->execute([...array_values($data), ...$this->bindings]);
    }

    public function delete(): bool {
        $sql = "DELETE FROM {$this->table}";
        if ($this->wheres) $sql .= " WHERE " . implode(' AND ', $this->wheres);
        $stmt = $this->pdo->prepare($sql);
        return $stmt->execute($this->bindings);
    }
    
    public function count(): int {
        $sql = "SELECT COUNT(*) FROM {$this->table}";
        if ($this->wheres) $sql .= " WHERE " . implode(' AND ', $this->wheres);
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute($this->bindings);
        return $stmt->fetchColumn();
    }
}
PHP

# --- DV (DATA VIEW ENGINE) ---
cat > app/Core/DV.php <<'PHP'
<?php
namespace App\Core;

/**
 * DV (Data View) Engine.
 * Handles data passing and rendering.
 */
class DV
{
    protected static array $data = [];

    public static function set(string $key, mixed $value): void {
        self::$data[$key] = $value;
    }

    public static function render(string $path, array $localData = []): string {
        $data = array_merge(self::$data, $localData);
        extract($data, EXTR_SKIP);

        ob_start();
        
        // Check for direct file path first, then resource path
        $viewFile = file_exists($path) ? $path : __DIR__ . '/../../resources/views/' . $path . '.php';

        if (file_exists($viewFile)) {
            include $viewFile;
        } else {
            echo "View not found: $path";
        }

        return ob_get_clean();
    }
}
PHP

# --- ROUTER ---
cat > app/Core/Router.php <<'PHP'
<?php
namespace App\Core;

class Router
{
    private string $appDir;

    public function __construct(string $appDir) {
        $this->appDir = rtrim($appDir, '/');
    }

    public function dispatch(Request $req): void {
        // 1. API Routes (+server.php)
        if ($this->dispatchServerRoute($req)) return;
        
        // 2. Page Routes (page.php)
        $this->dispatchPageRoute($req);
    }

    private function dispatchServerRoute(Request $req): bool {
        // Simplified Logic for brevity (Search +server.php)
        $path = $this->resolvePath($req->path);
        $serverFile = "$path/+server.php";
        
        if (file_exists($serverFile)) {
            $handler = require $serverFile;
            $method = strtolower($req->method);
            if (isset($handler[$method])) {
                $handler[$method]($req);
            } else {
                http_response_code(405);
                echo json_encode(['error' => 'Method not allowed']);
            }
            return true;
        }
        return false;
    }

    private function dispatchPageRoute(Request $req): void {
        list($currentPath, $params) = $this->resolvePathWithParams($req->path);
        
        $pageFile = "$currentPath/page.php";
        
        if (file_exists($pageFile)) {
            // Pass params to DV
            DV::set('params', $params);
            
            // Render Page
            $content = DV::render($pageFile);
            
            // Render Layout (Bubble up)
            $layout = $this->findLayout($currentPath);
            if ($layout) {
                echo DV::render($layout, ['content' => $content]);
            } else {
                echo $content;
            }
        } else {
            $this->renderError(404);
        }
    }

    private function resolvePathWithParams($uri) {
        $segments = $uri === '' ? [] : explode('/', $uri);
        $current = $this->appDir;
        $params = [];
        
        foreach ($segments as $segment) {
            $direct = "$current/$segment";
            if (is_dir($direct)) {
                $current = $direct;
                continue;
            }
            // Check dynamic [param]
            $found = false;
            foreach (glob("$current/*", GLOB_ONLYDIR) as $dir) {
                if (preg_match('/^\[(.+)\]$/', basename($dir), $matches)) {
                    $params[$matches[1]] = $segment;
                    $current = $dir;
                    $found = true;
                    break;
                }
            }
            if (!$found) return [null, []];
        }
        return [$current, $params];
    }

    private function resolvePath($uri) {
        $res = $this->resolvePathWithParams($uri);
        return $res[0];
    }

    private function findLayout($path) {
        // Look in current dir, then parent, etc.
        // For simplicity in this script, we just return main layout
        return __DIR__ . '/../../resources/views/layouts/main.php';
    }

    private function renderError($code) {
        http_response_code($code);
        $file = __DIR__ . "/../../resources/views/errors/$code.php";
        if (file_exists($file)) echo DV::render($file);
        else echo "Error $code";
    }
}
PHP

# --- THEME HELPER ---
cat > app/Core/Theme.php <<'PHP'
<?php
namespace App\Core;

class Theme
{
    public static function apply(): string {
        $config = require __DIR__ . '/../../config/style.php';
        $mode = $config['theme'] ?? 'system';

        if ($mode === 'dark') return 'class="dark"';
        if ($mode === 'light') return '';

        return <<<'HTML'
        x-data onload="
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        "
HTML;
    }
}
PHP

# --- HELPERS, AUTH, REQUEST ---
cat > app/Core/helpers.php <<'PHP'
<?php
use App\Core\DV;

function env($key, $default = null) {
    $val = getenv($key);
    return $val !== false ? $val : $default;
}

function view($path, $data = []) {
    return DV::render($path, $data);
}

function e($str) {
    return htmlspecialchars($str ?? '', ENT_QUOTES);
}

function redirect($url) {
    header("Location: $url");
    exit;
}

function csrf_token() {
    if (empty($_SESSION['csrf'])) $_SESSION['csrf'] = bin2hex(random_bytes(32));
    return $_SESSION['csrf'];
}

function auth() {
    return $GLOBALS['auth_user'] ?? null;
}
PHP

cat > app/Core/Request.php <<'PHP'
<?php
namespace App\Core;

class Request {
    public string $path;
    public string $method;
    public array $headers;
    public array $cookies;

    public function __construct() {
        $uri = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH) ?? '/';
        $this->path = trim($uri, '/');
        $this->method = $_SERVER['REQUEST_METHOD'];
        $this->headers = getallheaders();
        $this->cookies = $_COOKIE;
    }

    public function input($key, $default = null) {
        return $_POST[$key] ?? $_GET[$key] ?? $default;
    }
}
PHP

cat > app/Core/Auth.php <<'PHP'
<?php
namespace App\Core;
use Firebase\JWT\JWT;
use Firebase\JWT\Key;
use App\Models\User;

class Auth {
    public static function attempt($email, $password) {
        $user = User::findByEmail($email);
        if (!$user || !password_verify($password, $user['password'])) return false;
        
        $payload = [
            'sub' => $user['id'],
            'iat' => time(),
            'exp' => time() + env('JWT_TTL', 3600)
        ];
        
        return JWT::encode($payload, env('JWT_SECRET'), 'HS256');
    }

    public static function check($req) {
        $token = $req->cookies['token'] ?? null;
        if (!$token) return null;
        
        try {
            $decoded = JWT::decode($token, new Key(env('JWT_SECRET'), 'HS256'));
            $user = User::find($decoded->sub);
            $GLOBALS['auth_user'] = $user;
            return $user;
        } catch (\Exception $e) {
            return null;
        }
    }
}
PHP

#------------------------------------------------------------------------------
# 3. Models
#------------------------------------------------------------------------------
info "Creating Models..."

cat > app/Models/User.php <<'PHP'
<?php
namespace App\Models;
use App\Core\DB;

class User {
    public static function find($id) {
        return DB::table('users')->where('id', $id)->first();
    }
    
    public static function findByEmail($email) {
        return DB::table('users')->where('email', $email)->first();
    }

    public static function create($data) {
        return DB::table('users')->insert($data);
    }
    
    public static function count() {
        return DB::table('users')->count();
    }
}
PHP

#------------------------------------------------------------------------------
# 4. Middleware
#------------------------------------------------------------------------------
cat > app/Middleware/AuthMiddleware.php <<'PHP'
<?php
namespace App\Middleware;
use App\Core\Auth;

class AuthMiddleware {
    public function handle($req, $next) {
        Auth::check($req);
        return $next($req);
    }
}
PHP

#------------------------------------------------------------------------------
# 5. Views & Layouts
#------------------------------------------------------------------------------
info "Creating Views..."

cat > resources/views/layouts/main.php <<'PHP'
<?php use App\Core\Theme; ?>
<!DOCTYPE html>
<html lang="en" <?= Theme::apply() ?>>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= $title ?? 'Bastion Enterprise' ?></title>
    <link href="/css/app.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 antialiased transition-colors">
    <nav class="border-b border-gray-200 dark:border-gray-800 bg-white/50 dark:bg-gray-900/50 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <a href="/" class="font-bold text-xl bg-gradient-to-r from-blue-500 to-cyan-400 bg-clip-text text-transparent">Bastion v3</a>
            
            <div class="flex gap-4 text-sm font-medium">
                <?php if(auth()): ?>
                    <?php if(auth()['role'] === 'admin'): ?>
                        <a href="/admin" class="hover:text-blue-500">Admin</a>
                    <?php endif; ?>
                    <span><?= e(auth()[
