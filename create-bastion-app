#!/usr/bin/env bash
set -euo pipefail

APP_NAME="${1:-bastion-app}"
ROOT="$(pwd)/$APP_NAME"

echo "Creating Bastion PHP app at $ROOT ..."

# Helpers
mkdir -p "$ROOT"
cd "$ROOT"

info(){ echo -e "\033[1;34m[INFO]\033[0m $1"; }
success(){ echo -e "\033[1;32m[OK]\033[0m $1"; }
warn(){ echo -e "\033[1;33m[WARN]\033[0m $1"; }

# Basic dirs
mkdir -p app app/core app/middleware app/models app/api app/views app/views/errors app/views/partials app/layouts app/register app/login app/admin
mkdir -p public public/css resources/css resources/js storage/db storage/logs database/migrations database/seeds vendor
mkdir -p config

####################
# .env.example
####################
cat > .env.example <<'ENV'
APP_NAME=BastionPHP
APP_ENV=local
APP_DEBUG=true
APP_KEY=
JWT_SECRET=
DB_CONNECTION=sqlite
DB_PATH=storage/db/app.db
SECURE_COOKIES=false
JWT_ACCESS_EXP=900
JWT_REFRESH_EXP=604800
APP_TIMEZONE=UTC
APP_URL=http://127.0.0.1:9876
ENV

cp .env.example .env || true

####################
# composer.json
####################
cat > composer.json <<'JSON'
{
  "name": "bastion/php-app",
  "description": "Bastion PHP generated app",
  "autoload": {
    "psr-4": {
      "App\\\\": "app/"
    }
  },
  "require": {
    "firebase/php-jwt": "^6.0"
  }
}
JSON

####################
# package.json (tailwind minimal)
####################
cat > package.json <<'JSON'
{
  "private": true,
  "scripts": {
    "dev": "npx tailwindcss -i ./resources/css/app.css -o ./public/css/app.css --watch",
    "build": "npx tailwindcss -i ./resources/css/app.css -o ./public/css/app.css --minify"
  },
  "devDependencies": {
    "tailwindcss": "^4.0.0-alpha",
    "browser-sync": "^2.27.10"
  }
}
JSON

####################
# tailwind config (minimal)
####################
cat > tailwind.config.js <<'JS'
module.exports = {
  content: ["./app/**/*.php","./resources/**/*.php","./resources/**/*.html"],
  theme: { extend: {} },
  plugins: []
}
JS

####################
# resources css entry
####################
cat > resources/css/app.css <<'CSS'
@tailwind base;
@tailwind components;
@tailwind utilities;
CSS

####################
# PUBLIC INDEX, FRONT CONTROLLER
####################
cat > public/index.php <<'PHP'
<?php
declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

use App\Core\Request;
use App\Core\Router;
use App\Core\App;

$app = new App(__DIR__ . '/..'); // app root
$req = Request::capture();
$router = new Router(realpath(__DIR__ . '/../app'));
$router->dispatch($req);
PHP

####################
# CORE: App bootstrap
####################
cat > app/core/App.php <<'PHP'
<?php
namespace App\Core;

class App {
    public string $root;
    public array $bindings = [];
    public function __construct(string $root) {
        \$this->root = realpath(\$root);
        // Load helpers
        require_once \$this->root . '/core/helpers.php';
        // Load core classes autoloaded by composer (PSR-4) or require manually if needed
    }
    public function bind(string \$key, \$resolver) {
        \$this->bindings[\$key] = \$resolver;
    }
    public function resolve(string \$key) {
        if (!isset(\$this->bindings[\$key])) throw new \\RuntimeException("Service not bound: \$key");
        return call_user_func(\$this->bindings[\$key]);
    }
}
PHP

####################
# CORE: Helpers
####################
cat > app/core/helpers.php <<'PHP'
<?php
use App\Core\DV;

if (!function_exists('env')) {
    function env(string \$k, \$d = null) {
        \$v = getenv(\$k);
        if (\$v === false) return \$d;
        if (strtolower(\$v) === 'true') return true;
        if (strtolower(\$v) === 'false') return false;
        return \$v;
    }
}

if (!function_exists('e')) {
    function e(\$v){ return htmlspecialchars((string)\$v, ENT_QUOTES, 'UTF-8'); }
}

if (!function_exists('view')) {
    function view(string \$path, array \$data = []) {
        \$file = __DIR__ . '/../views/' . \$path . '.php';
        if (!file_exists(\$file)) throw new \\RuntimeException('View not found: ' . \$path);
        ob_start();
        extract(\$data, EXTR_SKIP);
        include \$file;
        return ob_get_clean();
    }
}

if (!function_exists('logger')) {
    function logger() {
        return new class {
            public function info(\$m, \$ctx=[]){ file_put_contents(__DIR__ . '/../../storage/logs/app.log', date('c') . ' INFO ' . json_encode(['msg'=>\$m,'ctx'=>\$ctx]) . PHP_EOL, FILE_APPEND); }
            public function warning(\$m, \$ctx=[]){ file_put_contents(__DIR__ . '/../../storage/logs/app.log', date('c') . ' WARN ' . json_encode(['msg'=>\$m,'ctx'=>\$ctx]) . PHP_EOL, FILE_APPEND); }
            public function error(\$m, \$ctx=[]){ file_put_contents(__DIR__ . '/../../storage/logs/app.log', date('c') . ' ERROR ' . json_encode(['msg'=>\$m,'ctx'=>\$ctx]) . PHP_EOL, FILE_APPEND); }
        };
    }
}
PHP

####################
# CORE: Request
####################
cat > app/core/Request.php <<'PHP'
<?php
namespace App\Core;

class Request {
    public string \$method;
    public string \$uri;
    public string \$path;
    public array \$headers = [];
    public array \$query = [];
    public array \$body = [];
    public array \$meta = [];

    public static function capture(): self {
        \$r = new self();
        \$r->method = $_SERVER['REQUEST_METHOD'] ?? 'GET';
        \$r->uri = $_SERVER['REQUEST_URI'] ?? '/';
        \$r->path = trim(parse_url(\$r->uri, PHP_URL_PATH), '/');
        foreach (\$_SERVER as \$k => \$v) {
            if (strpos(\$k,'HTTP_')===0) {
                \$r->headers[strtolower(str_replace('_','-',substr(\$k,5)))] = \$v;
            }
        }
        // parse input
        if (in_array(\$r->method, ['POST','PUT','PATCH','DELETE'])) {
            if (strpos(\$_SERVER['CONTENT_TYPE'] ?? '', 'application/json') !== false) {
                \$r->body = json_decode(file_get_contents('php://input'), true) ?? [];
            } else {
                \$r->body = \$_POST;
            }
        } else {
            \$r->body = \$_GET;
        }
        \$r->query = \$_GET;
        return \$r;
    }

    public function input(string \$k, \$d = null) {
        return \$this->body[\$k] ?? \$this->query[\$k] ?? \$d;
    }

    public function json() {
        return \$this->body;
    }

    public function isJson(): bool {
        return strpos(\$_SERVER['HTTP_ACCEPT'] ?? '', 'application/json') !== false;
    }
}
PHP

####################
# CORE: Response
####################
cat > app/core/Response.php <<'PHP'
<?php
namespace App\Core;

class Response {
    public static function json(\$data, int \$status=200) {
        http_response_code(\$status);
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode(\$data, JSON_UNESCAPED_UNICODE|JSON_UNESCAPED_SLASHES);
        exit;
    }
    public static function html(string \$html, int \$status=200) {
        http_response_code(\$status);
        header('Content-Type: text/html; charset=utf-8');
        echo \$html;
        exit;
    }
    public static function redirect(string \$url, int \$code=302) {
        header('Location: ' . str_replace(["\r","\n"],'',$url), true, \$code);
        exit;
    }
    public static function abort(int \$code, string \$msg='') {
        http_response_code(\$code);
        // Use view errors if exists
        \$errView = __DIR__ . '/../../app/views/errors/' . \$code . '.php';
        if (file_exists(\$errView)) {
            echo (function() use (\$errView, \$msg) {
                ob_start(); include \$errView; return ob_get_clean();
            })();
        } else {
            if (strpos(\$_SERVER['HTTP_ACCEPT'] ?? '', 'application/json') !== false) {
                echo json_encode(['error' => \$msg ?: 'Error ' . \$code]);
            } else {
                echo \"<h1>Error {\$code}</h1><p>\" . htmlspecialchars(\$msg) . \"</p>\";
            }
        }
        exit;
    }
}
PHP

####################
# CORE: DV template engine (children/slot support)
####################
cat > app/core/DV.php <<'PHP'
<?php
namespace App\Core;

class DV {
    public static array \$shared = [];

    public static function set(string \$k, \$v) { self::\$shared[\$k] = \$v; }

    public static function render(string \$file, array \$data = []): string {
        // file is absolute path expected
        \$data = array_merge(self::\$shared, \$data);
        if (!isset(\$data['children'])) \$data['children'] = '';
        if (!isset(\$data['slot'])) \$data['slot'] = '';
        extract(\$data, EXTR_SKIP);
        ob_start();
        include \$file;
        return ob_get_clean();
    }
}
PHP

####################
# CORE: DB + QueryBuilder minimal
####################
cat > app/core/DB.php <<'PHP'
<?php
namespace App\Core;

use PDO;

class DB {
    private PDO \$pdo;
    public function __construct() {
        \$path = env('DB_PATH', 'storage/db/app.db');
        \$full = __DIR__ . '/../../' . ltrim(\$path, '/');
        if (!is_dir(dirname(\$full))) @mkdir(dirname(\$full), 0755, true);
        if (!file_exists(\$full)) @touch(\$full);
        \$this->pdo = new PDO('sqlite:' . \$full);
        \$this->pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        \$this->pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
    }
    public function pdo(): PDO { return \$this->pdo; }
    public function table(string \$t): QueryBuilder { return new QueryBuilder(\$this->pdo, \$t); }
    public static function instance(): self { static \$i; if (!\$i) \$i = new self(); return \$i; }
}

class QueryBuilder {
    private PDO \$pdo;
    private string \$table;
    private array \$wheres = [];
    private array \$bindings = [];
    private int \$limit = 0;
    public function __construct(PDO \$pdo, string \$table) { \$this->pdo=\$pdo; \$this->table=\$table; }
    public function where(string \$col, \$val): self { \$this->wheres[] = \"\\\"\$col\\\" = ?\"; \$this->bindings[] = \$val; return \$this;}
    public function first() {
        \$sql = \"SELECT * FROM \\\"\$this->table\\\"\" . (\$this->wheres ? ' WHERE ' . implode(' AND ', \$this->wheres) : '') . ' LIMIT 1';
        \$stmt = \$this->pdo->prepare(\$sql);
        \$stmt->execute(\$this->bindings);
        return \$stmt->fetch();
    }
    public function get() {
        \$sql = \"SELECT * FROM \\\"\$this->table\\\"\" . (\$this->wheres ? ' WHERE ' . implode(' AND ', \$this->wheres) : '');
        \$stmt = \$this->pdo->prepare(\$sql);
        \$stmt->execute(\$this->bindings);
        return \$stmt->fetchAll();
    }
    public function insert(array \$data) {
        \$cols = array_keys(\$data);
        \$place = implode(',', array_fill(0,count(\$cols),'?'));
        \$sql = \"INSERT INTO \\\"\$this->table\\\" (\" . implode(',', array_map(fn(\$c)=>\"\\\"\$c\\\"\",\$cols)) . \") VALUES ({\$place})\";
        \$stmt = \$this->pdo->prepare(\$sql);
        \$stmt->execute(array_values(\$data));
        return (int)\$this->pdo->lastInsertId();
    }
    public function update(array \$data, array \$where = []) {
        \$sets = implode(',', array_map(fn(\$c)=>\"\\\"\$c\\\" = ?\", array_keys(\$data)));
        \$sql = \"UPDATE \\\"\$this->table\\\" SET {\$sets}\" . (\$this->wheres ? ' WHERE ' . implode(' AND ', \$this->wheres) : '');
        \$stmt = \$this->pdo->prepare(\$sql);
        \$stmt->execute(array_merge(array_values(\$data), \$this->bindings));
        return \$stmt->rowCount();
    }
    public function delete() {
        \$sql = \"DELETE FROM \\\"\$this->table\\\"\" . (\$this->wheres ? ' WHERE ' . implode(' AND ', \$this->wheres) : '');
        \$stmt = \$this->pdo->prepare(\$sql);
        \$stmt->execute(\$this->bindings);
        return \$stmt->rowCount();
    }
}
PHP

####################
# MODEL: User (example)
####################
cat > app/models/User.php <<'PHP'
<?php
namespace App\Models;

use App\Core\DB;

class User {
    public static function find(int \$id) { return DB::instance()->table('users')->where('id', \$id)->first(); }
    public static function findByEmail(string \$email) { return DB::instance()->table('users')->where('email', \$email)->first(); }
    public static function all() { return DB::instance()->table('users')->get(); }
    public static function create(array \$data) {
        return DB::instance()->table('users')->insert(\$data);
    }
    public static function update(int \$id, array \$data) {
        return DB::instance()->table('users')->where('id', \$id)->update(\$data);
    }
    public static function delete(int \$id) {
        return DB::instance()->table('users')->where('id', \$id)->delete();
    }
}
PHP

####################
# Middleware: SecurityHeaders, CSRF, Auth skeleton, RateLimit, AdminOnly
####################
cat > app/middleware/SecurityHeaders.php <<'PHP'
<?php
namespace App\Middleware;
use App\Core\Request;

class SecurityHeaders {
    public static function handle(Request \$req, callable \$next) {
        \$nonce = base64_encode(random_bytes(16));
        \$req->meta['csp_nonce'] = \$nonce;
        header(\"X-Frame-Options: SAMEORIGIN\");
        header(\"X-Content-Type-Options: nosniff\");
        header(\"Referrer-Policy: strict-origin-when-cross-origin\");
        header(\"Content-Security-Policy: default-src 'self'; script-src 'self' 'nonce-{\$nonce}' https://unpkg.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:;\");
        return \$next(\$req);
    }
}
PHP

cat > app/middleware/CSRF.php <<'PHP'
<?php
namespace App\Middleware;
use App\Core\Request;
use App\Core\Response;

class CSRF {
    public static function token(): string {
        if (session_status() !== PHP_SESSION_ACTIVE) session_start();
        if (empty(\$_SESSION['_csrf'])) \$_SESSION['_csrf'] = bin2hex(random_bytes(16));
        return \$_SESSION['_csrf'];
    }
    public static function verify(Request \$req, callable \$next) {
        if (in_array(strtoupper(\$req->method), ['POST','PUT','PATCH','DELETE'])) {
            \$sent = \$req->input('_csrf', '') ?: (\$req->headers['x-csrf-token'] ?? '');
            if (session_status() !== PHP_SESSION_ACTIVE) session_start();
            \$stored = \$_SESSION['_csrf'] ?? '';
            if (!is_string(\$sent) || !hash_equals((string)\$stored, (string)\$sent)) {
                return Response::json(['error'=>'CSRF token mismatch'], 403);
            }
        }
        return \$next(\$req);
    }
}
PHP

cat > app/middleware/RateLimit.php <<'PHP'
<?php
namespace App\Middleware;
use App\Core\Request;
use App\Core\Response;

class RateLimit {
    private static array \$attempts = [];
    public static function limit(Request \$req, callable \$next, int \$max=60, int \$decay=60) {
        \$ip = \$_SERVER['REMOTE_ADDR'] ?? 'unknown';
        \$key = md5(\$ip . '|' . \$req->path);
        \$now = time();
        self::\$attempts[\$key] = array_filter(self::\$attempts[\$key] ?? [], fn(\$t)=> \$t > \$now - \$decay);
        if (count(self::\$attempts[\$key]) >= \$max) {
            return Response::json(['error'=>'Too many requests'], 429);
        }
        self::\$attempts[\$key][] = \$now;
        return \$next(\$req);
    }
}
PHP

cat > app/middleware/Auth.php <<'PHP'
<?php
namespace App\Middleware;
use App\Core\Request;
use App\Core\Response;
use App\Models\User;
use Firebase\JWT\JWT;

class Auth {
    public static function guard(Request \$req, callable \$next) {
        \$token = \$_COOKIE['access'] ?? (\$req->headers['authorization'] ?? '');
        if (str_starts_with((string)\$token,'Bearer ')) \$token = substr((string)\$token,7);
        if (!\$token) return Response::json(['error'=>'Unauthorized'], 401);
        try {
            \$secret = env('JWT_SECRET', '');
            \$payload = (array) JWT::decode(\$token, \$secret, ['HS256']);
            // attach user
            \$user = User::find((int)\$payload['sub']);
            if (!\$user) return Response::json(['error'=>'Unauthorized'], 401);
            \$req->meta['user'] = \$user;
            return \$next(\$req);
        } catch (\\Throwable \$e) {
            return Response::json(['error'=>'Invalid token'], 401);
        }
    }
}
PHP

cat > app/middleware/AdminOnly.php <<'PHP'
<?php
namespace App\Middleware;
use App\Core\Request;
use App\Core\Response;

class AdminOnly {
    public static function handle(Request \$req, callable \$next) {
        \$user = \$req->meta['user'] ?? null;
        if (!\$user || (\$user['role'] ?? '') !== 'admin') {
            return Response::json(['error'=>'Forbidden'], 403);
        }
        return \$next(\$req);
    }
}
PHP

####################
# Router with layout resolver + API /page dispatch
####################
cat > app/core/Router.php <<'PHP'
<?php
namespace App\Core;

use App\Core\Request;
use App\Core\Response;

class Router {
    private string \$appDir;
    public function __construct(string \$appDir) {
        \$this->appDir = rtrim(\$appDir, '/');
    }

    private function resolveWithParams(string \$uri): array {
        \$segs = (\$uri === '' || \$uri === '/') ? [] : explode('/', trim(\$uri,'/'));
        \$curr = \$this->appDir;
        \$params = [];
        foreach (\$segs as \$seg) {
            \$direct = \$curr . '/' . \$seg;
            if (is_dir(\$direct)) { \$curr = \$direct; continue; }
            // try dynamic folder [id]
            \$found = false;
            foreach (glob(\$curr . '/*', GLOB_ONLYDIR) as \$d) {
                if (preg_match('/^\\[(.+)\\]$/', basename(\$d), \$m)) {
                    \$params[\$m[1]] = \$seg;
                    \$curr = \$d;
                    \$found = true;
                    break;
                }
            }
            if (!\$found) return [null, []];
        }
        return [\$curr, \$params];
    }

    private function resolveLayoutsFor(string \$pagePath): array {
        \$layouts = [];
        \$dir = dirname(\$pagePath);
        while (\$dir !== dirname(\$dir)) {
            \$layoutFile = \$dir . '/layout.php';
            if (file_exists(\$layoutFile)) \$layouts[] = \$layoutFile;
            \$dir = dirname(\$dir);
        }
        // root app/layout.php
        \$rootLayout = \$this->appDir . '/layout.php';
        if (file_exists(\$rootLayout)) \$layouts[] = \$rootLayout;
        return array_reverse(\$layouts);
    }

    private function renderFile(string \$file, array \$vars = []): string {
        extract(\$vars, EXTR_SKIP);
        ob_start(); include \$file; return ob_get_clean();
    }

    public function dispatch(Request \$req) {
        // Attempt API route resolution first
        [\$path, \$params] = \$this->resolveWithParams(\$req->path);
        if (!\$path) return Response::abort(404);

        \$req->meta['params'] = \$params;

        // API: +server.php exists?
        \$serverFile = \$path . '/+server.php';
        if (file_exists(\$serverFile)) {
            \$handler = require \$serverFile;
            if (is_callable(\$handler)) {
                return \$handler(\$req);
            } elseif (is_array(\$handler)) {
                \$method = strtolower(\$req->method);
                if (isset(\$handler[\$method]) && is_callable(\$handler[\$method])) {
                    return \$handler[\$method](\$req);
                } else {
                    return Response::json(['error'=>'Method not allowed'], 405);
                }
            } else {
                return Response::json(['error'=>'Invalid server handler'], 500);
            }
        }

        // Page dispatch
        \$pageFile = \$path . '/page.php';
        if (!file_exists(\$pageFile)) return Response::abort(404);

        // Render page via DV
        \$content = DV::render(\$pageFile, ['params'=>\$params, 'nonce'=> \$req->meta['csp_nonce'] ?? '']);
        // Resolve layouts
        \$layouts = \$this->resolveLayoutsFor(\$pageFile);
        foreach (\$layouts as \$layout) {
            \$content = DV::render(\$layout, ['children' => \$content, 'params'=>\$params, 'nonce'=> \$req->meta['csp_nonce'] ?? '']);
        }
        // Output
        echo \$content;
    }
}
PHP

####################
# Example pages, layouts, partials, errors, and htmx usage
####################
# Root layout (app/layout.php)
cat > app/layout.php <<'PHP'
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title><?= e($title ?? 'Bastion') ?></title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/css/app.css">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="p-4 bg-white shadow-sm">
    <div class="max-w-6xl mx-auto">
      <a href="/">Bastion</a>
    </div>
  </header>
  <main class="max-w-6xl mx-auto p-6">
    <?= $children ?>
  </main>
  <footer class="p-4 text-center text-sm text-gray-500">© <?= date('Y') ?> Bastion</footer>
</body>
</html>
PHP

# Admin layout (app/admin/layout.php)
cat > app/admin/layout.php <<'PHP'
<div class="grid grid-cols-6 gap-6">
  <aside class="col-span-1 bg-white p-4 rounded">Admin Menu<br/><a href="/admin">Dashboard</a></aside>
  <section class="col-span-5">
    <?= $children ?>
  </section>
</div>
PHP

# Home page (app/page.php)
cat > app/page.php <<'PHP'
<?php \App\Core\DV::set('title','Welcome'); ?>
<h1 class="text-3xl font-bold mb-4">Welcome to Bastion PHP</h1>
<p>Start building — pages are file-based. Try <a href="/admin">/admin</a>.</p>
PHP

# Admin page
cat > app/admin/page.php <<'PHP'
<?php \App\Core\DV::set('title','Admin Home'); ?>
<h2 class="text-2xl font-bold">Admin Home</h2>
<p>Protected area example (use middleware to protect).</p>
PHP

# Error pages
cat > app/views/errors/404.php <<'PHP'
<!doctype html><html><head><meta charset="utf-8"><title>404</title></head><body><h1>404 Not Found</h1><p>La página no existe.</p></body></html>
PHP
cat > app/views/errors/500.php <<'PHP'
<!doctype html><html><head><meta charset="utf-8"><title>500</title></head><body><h1>Server error</h1><p>Hubo un error interno.</p></body></html>
PHP

####################
# API examples (+server.php)
####################
cat > app/api/auth/+server.php <<'PHP'
<?php
use App\Core\Response;
use App\Models\User;
use Firebase\JWT\JWT;

return [
  'post' => function($req){
    \$email = \$req->input('email');
    \$pass = \$req->input('password');
    \$user = User::findByEmail(\$email);
    if (!\$user || !password_verify(\$pass, \$user['password'])) {
        return Response::json(['error'=>'Invalid credentials'], 401);
    }
    \$secret = env('JWT_SECRET', '');
    \$payload = ['sub' => (int)\$user['id'], 'iat' => time(), 'exp' => time() + (int)env('JWT_ACCESS_EXP',900)];
    \$access = JWT::encode(\$payload, \$secret, 'HS256');
    \$refresh = bin2hex(random_bytes(32));
    // store refresh token logic omitted for brevity
    setcookie('access', \$access, ['httponly'=>false,'samesite'=>'Lax','path'=>'/']);
    setcookie('refresh', \$refresh, ['httponly'=>true,'samesite'=>'Lax','path'=>'/']);
    return Response::json(['access' => \$access, 'refresh' => \$refresh]);
  }
];
PHP

cat > app/api/users/+server.php <<'PHP'
<?php
use App\Core\Response;
use App\Models\User;

return [
  'get' => function($req) {
      return Response::json(User::all());
  },
  'post' => function($req) {
      \$data = \$req->json();
      if (empty(\$data['email']) || empty(\$data['password'])) {
          return Response::json(['error'=>'email/password required'], 422);
      }
      \$data['password'] = password_hash(\$data['password'], PASSWORD_DEFAULT);
      \$data['created_at'] = time();
      \$id = User::create(\$data);
      return Response::json(['id'=>\$id], 201);
  }
];
PHP

####################
# Migration example
####################
cat > database/migrations/001_create_users.php <<'PHP'
<?php
\$db = new PDO('sqlite:' . __DIR__ . '/../..' . '/storage/db/app.db');
\$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
\$db->exec('CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, email TEXT UNIQUE, password TEXT, role TEXT DEFAULT "user", created_at INTEGER)');
PHP

####################
# Seeder
####################
cat > database/seeds/001_users.php <<'PHP'
<?php
\$db = new PDO('sqlite:' . __DIR__ . '/../..' . '/storage/db/app.db');
\$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
\$exists = \$db->query(\"SELECT count(1) as c FROM sqlite_master WHERE type='table' AND name='users'\")->fetch();
if (!\$exists) {
    // migration will create table
}
\$stmt = \$db->prepare('INSERT OR IGNORE INTO users (id,name,email,password,role,created_at) VALUES (?,?,?,?,?,?)');
\$stmt->execute([1,'Admin','admin@example.com', password_hash('password', PASSWORD_DEFAULT),'admin', time()]);
\$stmt->execute([2,'User','user@example.com', password_hash('password', PASSWORD_DEFAULT),'user', time()]);
PHP

####################
# CLI: artisan (php) and bastion (bash)
####################
cat > artisan <<'BASH'
#!/usr/bin/env php
<?php
require __DIR__ . '/vendor/autoload.php';
\$cmd = \$argv[1] ?? 'help';
if (\$cmd === 'migrate') {
    foreach (glob(__DIR__ . '/database/migrations/*.php') as \$m) {
        echo \"Running {\$m}\\n\";
        require \$m;
    }
    echo \"Migrations done\\n\";
} elseif (\$cmd === 'db:seed') {
    foreach (glob(__DIR__ . '/database/seeds/*.php') as \$s) {
        echo \"Seeding {\$s}\\n\";
        require \$s;
    }
    echo \"Seeding done\\n\";
} elseif (\$cmd === 'serve') {
    \$host = \$argv[2] ?? '127.0.0.1';
    \$port = \$argv[3] ?? '9876';
    echo \"Serving on http://{\$host}:{\$port}\\n\";
    passthru(PHP_BINARY . \" -S {\$host}:{\$port} -t public\");
} elseif (\$cmd === 'key:generate') {
    \$k = base64_encode(random_bytes(32));
    file_put_contents(__DIR__ . '/.env', str_replace(\"APP_KEY=\", \"APP_KEY={$k}\", file_get_contents(__DIR__ . '/.env')));
    echo \"Generated APP_KEY\\n\";
} else {
    echo \"Usage: php artisan [migrate|db:seed|serve|key:generate]\\n\";
}
PHP
chmod +x artisan || true

cat > bastion <<'BASH'
#!/usr/bin/env bash
CMD="$1"
if [ "$CMD" = "run-dev" ]; then
  echo "Starting dev: php server + tailwind watcher"
  php artisan serve 127.0.0.1 9876 &
  npx tailwindcss -i ./resources/css/app.css -o ./public/css/app.css --watch &
  wait
elif [ "$CMD" = "run-build" ]; then
  npx tailwindcss -i ./resources/css/app.css -o ./public/css/app.css --minify
elif [ "$CMD" = "migrate" ]; then
  php artisan migrate
elif [ "$CMD" = "db:seed" ]; then
  php artisan db:seed
else
  echo "Usage: ./bastion [run-dev|run-build|migrate|db:seed]"
fi
BASH
chmod +x bastion || true

####################
# Autoloader hint (composer will generate)
####################
mkdir -p vendor
echo "<?php // placeholder for composer autoload ?>" > vendor/autoload.php

####################
# Final messages
####################
success "Scaffold complete."
echo ""
echo "Next steps:"
echo "  cd $APP_NAME"
echo "  composer install   # requires composer"
echo "  npm install        # requires node"
echo "  ./artisan migrate"
echo "  ./artisan db:seed"
echo "  ./bastion run-dev"
echo ""
echo "Default credentials: admin@example.com / password"
