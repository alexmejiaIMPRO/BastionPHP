#!/usr/bin/env bash
#==============================================================================
# Bastion PHP Framework Generator v0.1.0
# "The Fortress for your Internal Tools"
#
# Architecture:
# - File-based Routing (+server.php / page.php)
# - DV (Data View) State Engine
# - Functional Components
# - SQLite WAL Mode / MySQL / Postgres
# - Native JWT Auth
#==============================================================================

set -euo pipefail

#------------------------------------------------------------------------------
# UI Helpers
#------------------------------------------------------------------------------
BOLD='\033[1m'
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
NC='\033[0m'

logo() {
    echo -e "${BLUE}"
    echo "  ____              _   _              "
    echo " |  _ \            | | (_)             "
    echo " | |_) | __ _  ___ | |_ _  ___  _ __   "
    echo " |  _ < / _\` |/ __|| __| |/ _ \| '_ \  "
    echo " | |_) | (_| | (__ | |_| | (_) | | | | "
    echo " |____/ \__,_|\___| \__|_|\___/|_| |_| "
    echo -e "${NC}  ${BOLD}Bastion PHP Framework v0.1.0${NC}"
    echo -e "  ${CYAN}Security-First â€¢ API-Centric â€¢ Modern DX${NC}"
    echo ""
}

info() { echo -e "${BLUE}â„¹${NC} $1"; }
step() { echo -e "${PURPLE}âžœ${NC} $1"; }
success() { echo -e "${GREEN}âœ”${NC} $1"; }
error() { echo -e "${RED}âœ–${NC} $1"; exit 1; }

#------------------------------------------------------------------------------
# Input Validation
#------------------------------------------------------------------------------
if [ "$#" -lt 1 ]; then
    logo
    echo "Usage: $0 <project-name>"
    echo ""
    echo "Example:"
    echo "  $0 my-internal-tool"
    exit 1
fi

PROJECT_NAME=$1
ROOT_DIR="$(pwd)/$PROJECT_NAME"

logo
step "Initializing new Bastion project: ${BOLD}$PROJECT_NAME${NC}"

#------------------------------------------------------------------------------
# Pre-flight Checks
#------------------------------------------------------------------------------
if [ -d "$ROOT_DIR" ]; then
    error "Directory $PROJECT_NAME already exists."
fi

if ! command -v php >/dev/null 2>&1; then
    error "PHP is not installed. PHP 8.1+ is required."
fi

if ! command -v composer >/dev/null 2>&1; then
    error "Composer is not installed."
fi

if ! command -v npm >/dev/null 2>&1; then
    error "Node.js/NPM is not installed (required for Tailwind)."
fi

#------------------------------------------------------------------------------
# Directory Structure (The "Bastion Standard")
#------------------------------------------------------------------------------
step "Constructing Fortress Architecture..."

mkdir -p "$ROOT_DIR"
cd "$ROOT_DIR"

# Root level
mkdir -p app config database public resources storage tests vendor

# App Structure
mkdir -p app/api                # API Routes (+server.php)
mkdir -p app/components         # Functional UI Components
mkdir -p app/core               # Framework Kernel
mkdir -p app/middleware         # HTTP Middleware
mkdir -p app/models             # Database Models
mkdir -p app/services           # Business Logic
mkdir -p app/views/errors       # Error Templates

# Database Structure
mkdir -p database/migrations
mkdir -p database/seeds

# Storage Structure (with protections)
mkdir -p storage/db
mkdir -p storage/logs
mkdir -p storage/cache
mkdir -p storage/uploads

touch storage/db/.gitkeep
touch storage/logs/.gitkeep
touch storage/cache/.gitkeep

#------------------------------------------------------------------------------
# Dependency Management
#------------------------------------------------------------------------------
step "Defining Dependencies..."

# 1. Composer.json
cat > composer.json <<JSON
{
    "name": "bastion/app",
    "description": "A Bastion PHP Application",
    "type": "project",
    "license": "MIT",
    "require": {
        "php": "^8.1",
        "ext-pdo": "*",
        "ext-json": "*",
        "firebase/php-jwt": "^6.10",
        "vlucas/phpdotenv": "^5.6"
    },
    "require-dev": {
        "phpunit/phpunit": "^10.5",
        "symfony/var-dumper": "^6.4"
    },
    "autoload": {
        "psr-4": {
            "App\\": "app/"
        },
        "files": [
            "app/core/helpers.php"
        ]
    },
    "autoload-dev": {
        "psr-4": {
            "Tests\\": "tests/"
        }
    },
    "config": {
        "optimize-autoloader": true,
        "preferred-install": "dist",
        "sort-packages": true
    },
    "scripts": {
        "test": "phpunit",
        "start": "php bastion serve"
    }
}
JSON

# 2. Package.json (Modern Tailwind Setup)
cat > package.json <<JSON
{
    "private": true,
    "type": "module",
    "scripts": {
        "dev": "tailwindcss -i ./resources/css/app.css -o ./public/css/app.css --watch",
        "build": "tailwindcss -i ./resources/css/app.css -o ./public/css/app.css --minify"
    },
    "devDependencies": {
        "tailwindcss": "^3.4.1",
        "autoprefixer": "^10.4.17",
        "postcss": "^8.4.35"
    }
}
JSON

#------------------------------------------------------------------------------
# Configuration Files
#------------------------------------------------------------------------------
step "Generating Configuration..."

# 1. Environment (.env)
APP_KEY=$(openssl rand -base64 32 2>/dev/null || echo "base64:$(date +%s%N | base64)")
JWT_SECRET=$(openssl rand -hex 32 2>/dev/null || echo "hex:$(date +%s%N | md5sum | head -c 32)")

cat > .env <<ENV
#--- Application ---
APP_NAME="$PROJECT_NAME"
APP_ENV=local
APP_DEBUG=true
APP_KEY=$APP_KEY
APP_URL=http://localhost:9000

#--- Database ---
# Options: sqlite, mysql, pgsql
DB_CONNECTION=sqlite
# For SQLite
DB_PATH=storage/db/database.sqlite
# For MySQL/PgSQL
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=bastion
DB_USERNAME=root
DB_PASSWORD=

#--- Authentication ---
JWT_SECRET=$JWT_SECRET
JWT_ALGO=HS256
JWT_TTL=3600            # Access Token: 1 hour
JWT_REFRESH_TTL=604800  # Refresh Token: 7 days

#--- Security ---
CORS_ALLOWED_ORIGINS=*
CSRF_ENABLED=true
SECURE_COOKIES=false    # Set true in production (HTTPS)

#--- Logging ---
LOG_CHANNEL=daily
LOG_LEVEL=debug
ENV

cp .env .env.example

# 2. Config Files (PHP)

cat > config/app.php <<PHP
<?php

return [
    'name' => env('APP_NAME', 'Bastion'),
    'env' => env('APP_ENV', 'production'),
    'debug' => (bool) env('APP_DEBUG', false),
    'url' => env('APP_URL', 'http://localhost'),
    'timezone' => 'UTC',
    'locale' => 'en',
    
    // Core Service Providers / Singletons to boot
    'providers' => [
        App\Core\Auth::class,
        App\Core\DB::class,
    ],
];
PHP

cat > config/database.php <<PHP
<?php

return [
    'default' => env('DB_CONNECTION', 'sqlite'),

    'connections' => [
        'sqlite' => [
            'driver' => 'sqlite',
            'database' => env('DB_PATH', __DIR__ . '/../storage/db/database.sqlite'),
            'foreign_key_constraints' => true,
            'wal_mode' => true, // High performance
        ],
        'mysql' => [
            'driver' => 'mysql',
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'forge'),
            'username' => env('DB_USERNAME', 'forge'),
            'password' => env('DB_PASSWORD', ''),
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
            'prefix' => '',
            'strict' => true,
        ],
    ],
];
PHP
#------------------------------------------------------------------------------
# Core Framework Kernel
#------------------------------------------------------------------------------
step "Forging Core Engine..."

# 1. App.php (The Container)
cat > app/core/App.php <<PHP
<?php

namespace App\Core;

class App
{
    private static App \$instance;
    private Router \$router;
    private array \$config = [];
    public string \$basePath;

    public function __construct(string \$basePath)
    {
        self::\$instance = \$this;
        \$this->basePath = \$basePath;
        \$this->loadConfig();
        \$this->router = new Router();
    }

    public static function getInstance(): App
    {
        return self::\$instance;
    }

    private function loadConfig(): void
    {
        // Simple config caching
        foreach (glob(\$this->basePath . '/config/*.php') as \$file) {
            \$key = basename(\$file, '.php');
            \$this->config[\$key] = require \$file;
        }
    }

    public function config(string \$key, mixed \$default = null): mixed
    {
        \$keys = explode('.', \$key);
        \$value = \$this->config;

        foreach (\$keys as \$k) {
            if (!isset(\$value[\$k])) {
                return \$default;
            }
            \$value = \$value[\$k];
        }

        return \$value;
    }

    public function run(): void
    {
        // Global Error Handling
        set_exception_handler([Handler::class, 'handleException']);
        set_error_handler([Handler::class, 'handleError']);

        // Boot Database
        DB::connect();

        // Dispatch Request
        \$request = new Request();
        \$response = \$this->router->dispatch(\$request);

        \$response->send();
    }
}
PHP

# 2. Router.php (The Navigation System - Refactored for +server.php)
cat > app/core/Router.php <<PHP
<?php

namespace App\Core;

class Router
{
    /**
     * The main dispatch loop.
     * Strategies:
     * 1. Check for API Endpoint (+server.php)
     * 2. Check for Page View (page.php)
     * 3. Handle Dynamic Params [id]
     */
    public function dispatch(Request \$request): Response
    {
        \$path = trim(\$request->path(), '/');
        \$segments = \$path === '' ? [] : explode('/', \$path);
        \$appPath = App::getInstance()->basePath . '/app';
        
        // Strategy: Walk the directory structure
        \$currentDir = \$appPath;
        \$params = [];
        
        foreach (\$segments as \$segment) {
            \$nextDir = \$currentDir . '/' . \$segment;
            
            // 1. Direct match
            if (is_dir(\$nextDir)) {
                \$currentDir = \$nextDir;
                continue;
            }
            
            // 2. Dynamic parameter match (e.g., [id])
            \$found = false;
            foreach (glob(\$currentDir . '/*', GLOB_ONLYDIR) as \$dir) {
                \$dirname = basename(\$dir);
                if (preg_match('/^\[(.+)\]\$/', \$dirname, \$matches)) {
                    \$paramName = \$matches[1];
                    \$params[\$paramName] = \$segment;
                    \$currentDir = \$dir;
                    \$found = true;
                    break;
                }
            }
            
            if (!\$found) {
                return Response::error(404, 'Route not found');
            }
        }

        // Store parsed params in Request
        \$request->setRouteParams(\$params);

        // Check for +server.php (API/Backend Logic)
        \$serverFile = \$currentDir . '/+server.php';
        if (file_exists(\$serverFile)) {
            return \$this->handleApi(\$serverFile, \$request);
        }

        // Check for page.php (Frontend Logic)
        \$pageFile = \$currentDir . '/page.php';
        if (file_exists(\$pageFile)) {
            return \$this->handlePage(\$pageFile, \$request, \$currentDir);
        }

        return Response::error(404, 'Endpoint not found');
    }

    private function handleApi(string \$file, Request \$request): Response
    {
        \$handlers = require \$file;
        \$method = strtolower(\$request->method());

        if (!isset(\$handlers[\$method])) {
            return Response::json(['error' => 'Method Not Allowed'], 405);
        }

        // Execute middleware defined in +server.php if any (Advanced feature)
        // ...

        \$result = call_user_func(\$handlers[\$method], \$request);

        if (\$result instanceof Response) {
            return \$result;
        }

        return Response::json(\$result);
    }

    private function handlePage(string \$file, Request \$request, string \$dir): Response
    {
        // 1. Initialize DV (Data View) Engine
        DV::init();

        // 2. Execute Page Logic (The Controller part of page.php)
        // This file should populates DV::set() and return HTML or void
        ob_start();
        \$returned = require \$file;
        \$content = ob_get_clean();

        // If page returned a Response object (e.g. redirect), return it immediately
        if (\$returned instanceof Response) {
            return \$returned;
        }

        // 3. Resolve Layout Tree
        // Look for layout.php in current dir and all parents up to app/
        \$layouts = \$this->findLayouts(\$dir);
        
        // 4. Render (Inner -> Outer)
        // The page content is the inner-most content
        foreach (\$layouts as \$layout) {
            ob_start();
            require \$layout; // Layout uses \$content variable
            \$content = ob_get_clean();
        }

        return Response::html(\$content);
    }

    private function findLayouts(string \$currentDir): array
    {
        \$root = App::getInstance()->basePath . '/app';
        \$layouts = [];
        
        while (true) {
            if (file_exists(\$currentDir . '/layout.php')) {
                // Prepend because we render inside-out, but need to wrap outside-in
                array_unshift(\$layouts, \$currentDir . '/layout.php');
            }
            
            if (\$currentDir === \$root) break;
            \$currentDir = dirname(\$currentDir);
            // Safety break
            if (strlen(\$currentDir) < strlen(\$root)) break; 
        }
        
        return \$layouts; // [app/layout.php, app/sub/layout.php]
    }
}
PHP
#------------------------------------------------------------------------------
# HTTP Layer & State Management
#------------------------------------------------------------------------------
step "Constructing Communication Layers..."

# 1. Request.php
cat > app/core/Request.php <<PHP
<?php

namespace App\Core;

class Request
{
    private array \$routeParams = [];
    private ?array \$jsonBody = null;

    public function method(): string
    {
        return \$_SERVER['REQUEST_METHOD'];
    }

    public function path(): string
    {
        \$uri = parse_url(\$_SERVER['REQUEST_URI'], PHP_URL_PATH);
        return \$uri;
    }

    public function input(string \$key, mixed \$default = null): mixed
    {
        // Check JSON first if Content-Type is json
        if (\$this->isJson()) {
            \$json = \$this->json();
            return \$json[\$key] ?? \$default;
        }
        return \$_REQUEST[\$key] ?? \$default;
    }

    public function json(): array
    {
        if (\$this->jsonBody !== null) return \$this->jsonBody;
        
        \$input = file_get_contents('php://input');
        \$this->jsonBody = json_decode(\$input, true) ?? [];
        return \$this->jsonBody;
    }

    public function isJson(): bool
    {
        return str_contains(\$_SERVER['CONTENT_TYPE'] ?? '', 'application/json');
    }

    public function setRouteParams(array \$params): void
    {
        \$this->routeParams = \$params;
    }

    public function param(string \$key): ?string
    {
        return \$this->routeParams[\$key] ?? null;
    }

    public function validate(array \$rules): array
    {
        \$errors = [];
        \$data = [];

        foreach (\$rules as \$field => \$ruleStr) {
            \$value = \$this->input(\$field);
            \$rulesArr = explode('|', \$ruleStr);
            
            foreach (\$rulesArr as \$rule) {
                if (\$rule === 'required' && empty(\$value)) {
                    \$errors[\$field] = "\$field is required";
                }
                // Add more validation logic here (email, min, max, etc.)
            }
            \$data[\$field] = \$value;
        }

        if (!empty(\$errors)) {
            if (\$this->isJson()) {
                Response::json(['errors' => \$errors], 422)->send();
                exit;
            }
            // Flash errors to session for HTML forms
            DV::flash('errors', \$errors);
            DV::flash('old', \$this->input('')); // Flash all input
            Response::redirect(\$_SERVER['HTTP_REFERER'])->send();
            exit;
        }

        return \$data;
    }
}
PHP

# 2. Response.php
cat > app/core/Response.php <<PHP
<?php

namespace App\Core;

class Response
{
    private string \$content;
    private int \$status;
    private array \$headers;

    public function __construct(string \$content = '', int \$status = 200, array \$headers = [])
    {
        \$this->content = \$content;
        \$this->status = \$status;
        \$this->headers = \$headers;
    }

    public static function json(mixed \$data, int \$status = 200): self
    {
        return new self(json_encode(\$data), \$status, ['Content-Type' => 'application/json']);
    }

    public static function html(string \$html, int \$status = 200): self
    {
        return new self(\$html, \$status, ['Content-Type' => 'text/html']);
    }

    public static function error(int \$status, string \$message): self
    {
        // Try to render a custom error view
        \$viewPath = App::getInstance()->basePath . "/app/views/errors/\$status.php";
        if (file_exists(\$viewPath)) {
            ob_start();
            require \$viewPath;
            \$html = ob_get_clean();
            return new self(\$html, \$status, ['Content-Type' => 'text/html']);
        }
        
        // Fallback
        if (request()->isJson()) {
             return self::json(['error' => \$message], \$status);
        }
        return new self("<h1>Error \$status</h1><p>\$message</p>", \$status);
    }

    public static function redirect(string \$url): self
    {
        return new self('', 302, ['Location' => \$url]);
    }

    public function send(): void
    {
        http_response_code(\$this->status);
        foreach (\$this->headers as \$k => \$v) {
            header("\$k: \$v");
        }
        echo \$this->content;
    }
}
PHP

# 3. DV.php (The Data View Engine - New!)
cat > app/core/DV.php <<PHP
<?php

namespace App\Core;

/**
 * DV (Data View) Engine
 * Manages state transfer between Controllers (+server.php/page.php) and Views (layouts).
 */
class DV
{
    private static array \$data = [];
    private static array \$flashed = [];

    public static function init(): void
    {
        if (session_status() === PHP_SESSION_NONE) session_start();
        
        // Load flashed data from previous request
        if (isset(\$_SESSION['dv_flash'])) {
            self::\$flashed = \$_SESSION['dv_flash'];
            unset(\$_SESSION['dv_flash']);
        }
    }

    /**
     * Set data for the current request cycle
     */
    public static function set(string \$key, mixed \$value): void
    {
        self::\$data[\$key] = \$value;
    }

    /**
     * Get data (checks current request, then flashed data, then default)
     */
    public static function get(string \$key, mixed \$default = null): mixed
    {
        return self::\$data[\$key] ?? self::\$flashed[\$key] ?? \$default;
    }

    /**
     * Flash data to the next request (stored in session)
     */
    public static function flash(string \$key, mixed \$value): void
    {
        \$_SESSION['dv_flash'][\$key] = \$value;
    }

    public static function all(): array
    {
        return array_merge(self::\$flashed, self::\$data);
    }
}
PHP

# 4. Helpers (Global Functions)
cat > app/core/helpers.php <<PHP
<?php

use App\Core\App;
use App\Core\Response;
use App\Core\Request;
use App\Core\DV;

if (!function_exists('env')) {
    function env(\$key, \$default = null) {
        return \$_ENV[\$key] ?? \$default;
    }
}

if (!function_exists('app')) {
    function app(): App {
        return App::getInstance();
    }
}

if (!function_exists('config')) {
    function config(\$key, \$default = null) {
        return app()->config(\$key, \$default);
    }
}

if (!function_exists('request')) {
    function request(): Request {
        static \$req;
        if (!\$req) \$req = new Request();
        return \$req;
    }
}

if (!function_exists('e')) {
    function e(\$string): string {
        return htmlspecialchars((string)\$string, ENT_QUOTES, 'UTF-8');
    }
}

if (!function_exists('csrf_token')) {
    function csrf_token(): string {
        if (session_status() === PHP_SESSION_NONE) session_start();
        if (empty(\$_SESSION['csrf_token'])) {
            \$_SESSION['csrf_token'] = bin2hex(random_bytes(32));
        }
        return \$_SESSION['csrf_token'];
    }
}

if (!function_exists('csrf_field')) {
    function csrf_field(): string {
        \$token = csrf_token();
        return '<input type="hidden" name="_token" value="' . \$token . '">';
    }
}

if (!function_exists('component')) {
    function component(string \$name, array \$props = []): string {
        \$class = "App\\\\Components\\\\" . \$name;
        if (!function_exists(\$class)) {
            // Check if file exists to autoload/include function file
            \$file = app()->basePath . "/app/components/\$name.php";
            if (file_exists(\$file)) require_once \$file;
        }
        
        // Assuming functional components are simple functions in the global or App\Components namespace
        // For simplicity in this v0.1.0, we will require the file and call the function matching the filename
        if (function_exists(\$name)) {
            return \$name(...\$props);
        }
        
        return "";
    }
}
PHP
#------------------------------------------------------------------------------
# Data & Security Layers
#------------------------------------------------------------------------------
step "Fortifying Data Vaults..."

# 1. DB.php (PDO Wrapper & Query Builder Factory)
cat > app/core/DB.php <<PHP
<?php

namespace App\Core;

use PDO;
use PDOException;

class DB
{
    private static ?PDO \$pdo = null;

    public static function connect(): void
    {
        if (self::\$pdo) return;

        \$config = config('database.connections.' . config('database.default'));
        
        try {
            if (\$config['driver'] === 'sqlite') {
                \$dsn = "sqlite:" . \$config['database'];
            } else {
                \$dsn = "mysql:host={\$config['host']};port={\$config['port']};dbname={\$config['database']};charset={\$config['charset']}";
            }

            self::\$pdo = new PDO(\$dsn, \$config['username'] ?? null, \$config['password'] ?? null);
            self::\$pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            self::\$pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);

            if (\$config['driver'] === 'sqlite' && (\$config['wal_mode'] ?? false)) {
                self::\$pdo->exec('PRAGMA journal_mode = WAL;');
            }

        } catch (PDOException \$e) {
            die("Database connection failed: " . \$e->getMessage());
        }
    }

    public static function pdo(): PDO
    {
        return self::\$pdo;
    }

    public static function table(string \$table): QueryBuilder
    {
        return new QueryBuilder(self::\$pdo, \$table);
    }

    public static function query(string \$sql, array \$params = []): array
    {
        \$stmt = self::\$pdo->prepare(\$sql);
        \$stmt->execute(\$params);
        return \$stmt->fetchAll();
    }
}
PHP

# 2. QueryBuilder.php (Fluent Interface)
cat > app/core/QueryBuilder.php <<PHP
<?php

namespace App\Core;

use PDO;

class QueryBuilder
{
    protected PDO \$pdo;
    protected string \$table;
    protected array \$bindings = [];
    protected array \$wheres = [];
    protected array \$orders = [];
    protected ?int \$limit = null;
    protected ?int \$offset = null;

    public function __construct(PDO \$pdo, string \$table)
    {
        \$this->pdo = \$pdo;
        \$this->table = \$table;
    }

    public function where(string \$column, string \$operator, mixed \$value = null): self
    {
        if (\$value === null) {
            \$value = \$operator;
            \$operator = '=';
        }
        \$this->wheres[] = "\$column \$operator ?";
        \$this->bindings[] = \$value;
        return \$this;
    }

    public function orderBy(string \$column, string \$direction = 'ASC'): self
    {
        \$this->orders[] = "\$column \$direction";
        return \$this;
    }

    public function limit(int \$limit): self
    {
        \$this->limit = \$limit;
        return \$this;
    }

    public function get(): array
    {
        \$sql = "SELECT * FROM {\$this->table}";
        if (!empty(\$this->wheres)) \$sql .= " WHERE " . implode(' AND ', \$this->wheres);
        if (!empty(\$this->orders)) \$sql .= " ORDER BY " . implode(', ', \$this->orders);
        if (\$this->limit) \$sql .= " LIMIT {\$this->limit}";

        \$stmt = \$this->pdo->prepare(\$sql);
        \$stmt->execute(\$this->bindings);
        return \$stmt->fetchAll();
    }

    public function first()
    {
        \$this->limit(1);
        \$result = \$this->get();
        return \$result[0] ?? null;
    }

    public function insert(array \$data): string|false
    {
        \$keys = array_keys(\$data);
        \$placeholders = array_fill(0, count(\$keys), '?');
        
        \$sql = "INSERT INTO {\$this->table} (" . implode(',', \$keys) . ") VALUES (" . implode(',', \$placeholders) . ")";
        
        \$stmt = \$this->pdo->prepare(\$sql);
        \$stmt->execute(array_values(\$data));
        return \$this->pdo->lastInsertId();
    }

    public function update(array \$data): bool
    {
        \$sets = [];
        \$values = [];
        foreach (\$data as \$k => \$v) {
            \$sets[] = "\$k = ?";
            \$values[] = \$v;
        }
        
        \$sql = "UPDATE {\$this->table} SET " . implode(', ', \$sets);
        if (!empty(\$this->wheres)) {
            \$sql .= " WHERE " . implode(' AND ', \$this->wheres);
            \$values = array_merge(\$values, \$this->bindings);
        }
        
        \$stmt = \$this->pdo->prepare(\$sql);
        return \$stmt->execute(\$values);
    }
    
    public function delete(): bool
    {
        \$sql = "DELETE FROM {\$this->table}";
        if (!empty(\$this->wheres)) {
            \$sql .= " WHERE " . implode(' AND ', \$this->wheres);
        }
        \$stmt = \$this->pdo->prepare(\$sql);
        return \$stmt->execute(\$this->bindings);
    }
}
PHP

# 3. Auth.php (JWT Implementation)
cat > app/core/Auth.php <<PHP
<?php

namespace App\Core;

use Firebase\JWT\JWT;
use Firebase\JWT\Key;

class Auth
{
    public static function attempt(string \$email, string \$password): bool
    {
        \$user = DB::table('users')->where('email', \$email)->first();
        
        if (!\$user || !password_verify(\$password, \$user['password'])) {
            return false;
        }

        self::login(\$user);
        return true;
    }

    public static function login(array \$user): void
    {
        \$payload = [
            'iss' => env('APP_NAME'),
            'sub' => \$user['id'],
            'iat' => time(),
            'exp' => time() + (int) env('JWT_TTL', 3600),
            'role' => \$user['role'] ?? 'user'
        ];

        \$jwt = JWT::encode(\$payload, env('JWT_SECRET'), 'HS256');

        // Store in HttpOnly Cookie
        setcookie('auth_token', \$jwt, [
            'expires' => time() + env('JWT_TTL', 3600),
            'path' => '/',
            'httponly' => true,
            'secure' => env('SECURE_COOKIES', false),
            'samesite' => 'Lax'
        ]);
        
        // Update last login
        DB::table('users')->where('id', \$user['id'])->update(['last_login' => date('Y-m-d H:i:s')]);
    }

    public static function user(): ?array
    {
        if (!isset(\$_COOKIE['auth_token'])) return null;

        try {
            \$decoded = JWT::decode(\$_COOKIE['auth_token'], new Key(env('JWT_SECRET'), 'HS256'));
            // Optional: Fetch fresh user from DB to verify active status
            return (array) \$decoded;
        } catch (\Exception \$e) {
            return null;
        }
    }

    public static function check(): bool
    {
        return self::user() !== null;
    }
    
    public static function logout(): void
    {
        setcookie('auth_token', '', time() - 3600, '/');
    }
}
PHP
#------------------------------------------------------------------------------
# Middleware & Base Models
#------------------------------------------------------------------------------
step "Establishing Perimeter Defenses..."

# 1. Base Model
cat > app/core/Model.php <<PHP
<?php

namespace App\Core;

abstract class Model
{
    protected static string \$table;

    public static function query(): QueryBuilder
    {
        return DB::table(static::\$table);
    }

    public static function all(): array
    {
        return self::query()->get();
    }

    public static function find(\$id)
    {
        return self::query()->where('id', \$id)->first();
    }
    
    public static function create(array \$data)
    {
        return self::query()->insert(\$data);
    }
}
PHP

# 2. CSRF Middleware
cat > app/middleware/CsrfMiddleware.php <<PHP
<?php

namespace App\Middleware;

use App\Core\Request;
use App\Core\Response;

class CsrfMiddleware
{
    public function handle(Request \$request, callable \$next)
    {
        if (!config('security.csrf_enabled', true)) return \$next(\$request);
        
        \$method = \$request->method();
        if (in_array(\$method, ['GET', 'HEAD', 'OPTIONS'])) {
            return \$next(\$request);
        }

        \$token = \$request->input('_token') ?? \$_SERVER['HTTP_X_CSRF_TOKEN'] ?? null;
        
        if (!\$token || \$token !== \$_SESSION['csrf_token']) {
            if (\$request->isJson()) {
                return Response::json(['error' => 'CSRF Token Mismatch'], 419);
            }
            return Response::error(419, 'Page Expired');
        }

        return \$next(\$request);
    }
}
PHP

# 3. Auth Middleware
cat > app/middleware/AuthMiddleware.php <<PHP
<?php

namespace App\Middleware;

use App\Core\Auth;
use App\Core\Response;

class AuthMiddleware
{
    public function handle(\$request, callable \$next)
    {
        if (!Auth::check()) {
            if (\$request->isJson()) {
                return Response::json(['error' => 'Unauthorized'], 401);
            }
            return Response::redirect('/login');
        }
        return \$next(\$request);
    }
}
PHP

# 4. Error Handler
cat > app/core/Handler.php <<PHP
<?php

namespace App\Core;

class Handler
{
    public static function handleException(\$e)
    {
        \$debug = config('app.debug');
        
        if (request()->isJson()) {
            Response::json([
                'error' => \$e->getMessage(),
                'trace' => \$debug ? \$e->getTrace() : null
            ], 500)->send();
            exit;
        }

        \$status = 500;
        \$message = \$debug ? \$e->getMessage() : 'Internal Server Error';
        \$file = \$e->getFile();
        \$line = \$e->getLine();
        
        // Simple error view
        echo "<html><body style='font-family:sans-serif; background:#111; color:#eee; padding:2rem;'>";
        echo "<h1 style='color:#ef4444'>Bastion Application Error</h1>";
        echo "<h3>\$message</h3>";
        if (\$debug) {
            echo "<p style='color:#888'>In \$file on line \$line</p>";
            echo "<pre style='background:#222; padding:1rem; overflow:auto'>" . \$e->getTraceAsString() . "</pre>";
        }
        echo "</body></html>";
        exit;
    }

    public static function handleError(\$errno, \$errstr, \$errfile, \$errline)
    {
        throw new \ErrorException(\$errstr, 0, \$errno, \$errfile, \$errline);
    }
}
PHP

# 5. User Model
cat > app/models/User.php <<PHP
<?php

namespace App\Models;

use App\Core\Model;

class User extends Model
{
    protected static string \$table = 'users';
}
PHP

# 6. Global Bootstrap (bootstrap.php)
cat > app/bootstrap.php <<PHP
<?php

require_once __DIR__ . '/../vendor/autoload.php';

use Dotenv\Dotenv;

// Load Environment
\$dotenv = Dotenv::createImmutable(__DIR__ . '/../');
\$dotenv->safeLoad();

// Initialize App Container
\$app = new App\Core\App(dirname(__DIR__));
PHP

# 7. Public Entry Point
cat > public/index.php <<PHP
<?php

/**
 * Bastion PHP - Front Controller
 */

require __DIR__ . '/../app/bootstrap.php';

// Run Application
\$app->run();
PHP
#------------------------------------------------------------------------------
# The Bastion CLI Tool (Replacement for Artisan)
#------------------------------------------------------------------------------
step "Forging the Bastion CLI..."

cat > bastion <<PHP
#!/usr/bin/env php
<?php

// Bastion CLI
// The command center for your framework

if (php_sapi_name() !== 'cli') {
    exit;
}

require __DIR__ . '/app/bootstrap.php';

use App\Core\DB;

\$command = \$argv[1] ?? 'help';
\$args = array_slice(\$argv, 2);

echo "\n\033[1;34mBastion CLI v0.1.0\033[0m\n\n";

switch (\$command) {
    case 'serve':
        \$port = \$args[0] ?? 9000;
        echo "\033[32mStarting development server on http://localhost:\$port\033[0m\n";
        echo "Press Ctrl+C to stop.\n";
        passthru("php -S localhost:\$port -t public/");
        break;

    case 'migrate':
        echo "Running migrations...\n";
        DB::connect();
        \$files = glob(__DIR__ . '/database/migrations/*.sql');
        foreach (\$files as \$file) {
            \$sql = file_get_contents(\$file);
            echo "Migrating: " . basename(\$file) . "\n";
            try {
                DB::pdo()->exec(\$sql);
                echo "\033[32m  DONE\033[0m\n";
            } catch (Exception \$e) {
                echo "\033[31m  ERROR: " . \$e->getMessage() . "\033[0m\n";
            }
        }
        break;
        
    case 'seed':
        echo "Seeding database...\n";
        DB::connect();
        \$files = glob(__DIR__ . '/database/seeds/*.php');
        foreach (\$files as \$file) {
             echo "Seeding: " . basename(\$file) . "\n";
             require \$file;
        }
        echo "\033[32mSeeds complete.\033[0m\n";
        break;

    case 'make:page':
        \$name = \$args[0] ?? null;
        if (!\$name) die("\033[31mError: Name required\033[0m\n");
        \$dir = __DIR__ . "/app/\$name";
        if (!is_dir(\$dir)) mkdir(\$dir, 0755, true);
        
        file_put_contents("\$dir/page.php", "<?php\n\nDV::set('title', 'New Page');\n?>\n\n<h1 class=\"text-2xl\">New Page</h1>");
        echo "\033[32mPage created at app/\$name/page.php\033[0m\n";
        break;
        
    case 'make:api':
        \$name = \$args[0] ?? null;
        if (!\$name) die("\033[31mError: Name required\033[0m\n");
        \$dir = __DIR__ . "/app/\$name";
        if (!is_dir(\$dir)) mkdir(\$dir, 0755, true);
        
        \$content = "<?php\n\nuse App\Core\Response;\n\nreturn [\n    'get' => function(\$req) {\n        return ['message' => 'Hello API'];\n    }\n];";
        file_put_contents("\$dir/+server.php", \$content);
        echo "\033[32mAPI created at app/\$name/+server.php\033[0m\n";
        break;

    case 'help':
    default:
        echo "Available commands:\n";
        echo "  serve [port]     Start dev server\n";
        echo "  migrate          Run SQL migrations\n";
        echo "  seed             Run database seeds\n";
        echo "  make:page <name> Create new page route\n";
        echo "  make:api <name>  Create new API endpoint\n";
        break;
}
echo "\n";
PHP

chmod +x bastion

# 2. Initial Migration (Users)
cat > database/migrations/001_init.sql <<SQL
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    password TEXT NOT NULL,
    role TEXT DEFAULT 'user',
    last_login DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
SQL

# 3. Initial Seeder
cat > database/seeds/DatabaseSeeder.php <<PHP
<?php
use App\Core\DB;

// Create Admin
try {
    DB::table('users')->insert([
        'name' => 'Admin User',
        'email' => 'admin@example.com',
        'password' => password_hash('password', PASSWORD_DEFAULT),
        'role' => 'admin'
    ]);
    echo "  Admin created: admin@example.com / password\n";
} catch (Exception \$e) {
    echo "  Admin already exists.\n";
}
PHP
#------------------------------------------------------------------------------
# Frontend Boilerplate (Views, Components, CSS)
#------------------------------------------------------------------------------
step "Painting the Walls..."

# 1. Main CSS (Tailwind Input)
mkdir -p resources/css
cat > resources/css/app.css <<CSS
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  body {
    @apply bg-slate-900 text-slate-100 antialiased;
  }
}
CSS

# 2. Functional Components
cat > app/components/Button.php <<PHP
<?php

function Button(string \$text, string \$type = 'button', string \$class = ''): string
{
    return <<<HTML
    <button type="\$type" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-white font-medium transition-colors \$class">
        \$text
    </button>
    HTML;
}
PHP

cat > app/components/Input.php <<PHP
<?php

function Input(string \$name, string \$label, string \$type = 'text', string \$value = ''): string
{
    return <<<HTML
    <div class="mb-4">
        <label class="block text-slate-400 text-sm font-bold mb-2" for="\$name">
            \$label
        </label>
        <input class="shadow appearance-none border border-slate-700 bg-slate-800 rounded w-full py-2 px-3 text-slate-100 leading-tight focus:outline-none focus:border-indigo-500" 
               id="\$name" name="\$name" type="\$type" value="\$value">
    </div>
    HTML;
}
PHP

# 3. Root Layout (Uses DV Engine)
cat > app/layout.php <<PHP
<?php
use App\Core\DV;

\$title = DV::get('title', 'Bastion App');
\$user = App\Core\Auth::user();
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= \$title ?></title>
    <link href="/css/app.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-slate-900 text-slate-200">

    <nav class="border-b border-slate-800 bg-slate-950/50 backdrop-blur fixed w-full z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="font-bold text-xl text-indigo-500">Bastion</a>
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="/" class="hover:text-white px-3 py-2 rounded-md text-sm font-medium">Home</a>
                        <a href="/dashboard" class="hover:text-white px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                    </div>
                </div>
                <div>
                    <?php if(\$user): ?>
                        <span class="text-sm mr-4">Hi, <?= \$user['role'] ?></span>
                        <a href="/auth/logout" class="text-slate-400 hover:text-white text-sm">Logout</a>
                    <?php else: ?>
                        <a href="/auth/login" class="text-indigo-400 hover:text-indigo-300 text-sm">Login</a>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-12 px-4 max-w-7xl mx-auto">
        <?php if(DV::get('errors')): ?>
            <div class="bg-red-900/50 border border-red-800 text-red-200 px-4 py-3 rounded relative mb-6">
                <strong class="font-bold">Error!</strong>
                <ul>
                    <?php foreach(DV::get('errors') as \$err): ?>
                        <li><?= \$err ?></li>
                    <?php endforeach; ?>
                </ul>
            </div>
        <?php endif; ?>

        <?= \$content ?>
    </main>

</body>
</html>
PHP

# 4. Home Page
cat > app/page.php <<PHP
<?php
use App\Core\DV;

DV::set('title', 'Welcome to Bastion');
?>

<div class="text-center py-20">
    <h1 class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 mb-6">
        Bastion PHP
    </h1>
    <p class="text-xl text-slate-400 mb-10 max-w-2xl mx-auto">
        The fortress for your internal tools. Secure, fast, and opinionated.
    </p>
    
    <div class="flex justify-center gap-4">
        <a href="https://github.com/alexmejiaImpro/BastionPHP" class="px-6 py-3 bg-slate-800 hover:bg-slate-700 rounded-lg font-semibold transition">
            Documentation
        </a>
        <button hx-post="/api/health" hx-swap="outerHTML" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-semibold transition">
            Check API Health
        </button>
    </div>
</div>
PHP

# 5. Dashboard (Protected)
mkdir -p app/dashboard
cat > app/dashboard/page.php <<PHP
<?php
use App\Core\DV;
use App\Core\Auth;
use App\Core\Response;

if (!Auth::check()) {
    return Response::redirect('/auth/login');
}

DV::set('title', 'Dashboard');
\$user = Auth::user();
?>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-slate-800 p-6 rounded-lg border border-slate-700">
        <h3 class="text-lg font-bold text-slate-100 mb-2">User Stats</h3>
        <p class="text-3xl font-mono text-indigo-400">1</p>
        <p class="text-sm text-slate-500">Active Users</p>
    </div>
    
    <div class="bg-slate-800 p-6 rounded-lg border border-slate-700">
        <h3 class="text-lg font-bold text-slate-100 mb-2">System Status</h3>
        <div class="flex items-center gap-2">
            <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
            <span class="text-green-400">Operational</span>
        </div>
    </div>
</div>
PHP
#------------------------------------------------------------------------------
# API, Auth Routes & Installation
#------------------------------------------------------------------------------
step "Wiring Circuits..."

# 1. Health Check API
mkdir -p app/api
cat > app/api/health/+server.php <<PHP
<?php
// app/api/health/+server.php
return [
    'post' => function(\$req) {
        return ['status' => 'ok', 'timestamp' => time(), 'message' => 'System Operational'];
    }
];
PHP

# 2. Auth Routes (Login/Logout)
mkdir -p app/auth/login
mkdir -p app/auth/logout

# Login GET/POST
cat > app/auth/login/+server.php <<PHP
<?php

use App\Core\Response;
use App\Core\Auth;
use App\Core\DV;
use App\Core\Request;

require_once __DIR__ . '/../../components/Input.php';
require_once __DIR__ . '/../../components/Button.php';

return [
    'get' => function(Request \$req) {
        if (Auth::check()) return Response::redirect('/dashboard');
        
        // This is a hybrid route: GET returns HTML via page logic mechanism simulation
        // In a real scenario, the Router handles this separation cleaner, 
        // but here we manually render the view for the GET request inside the handler if we want strictly one file,
        // OR we let the Router fall through to page.php if +server.php doesn't handle GET.
        // For Bastion v0.1.0, let's look for page.php if this returns null or let Router handle it.
        // But to demonstrate +server power, we return a redirect.
    },
    
    'post' => function(Request \$req) {
        \$data = \$req->validate([
            'email' => 'required',
            'password' => 'required'
        ]);
        
        if (Auth::attempt(\$data['email'], \$data['password'])) {
            return Response::redirect('/dashboard');
        }
        
        DV::flash('errors', ['auth' => 'Invalid credentials']);
        return Response::redirect('/auth/login');
    }
];
PHP

cat > app/auth/login/page.php <<PHP
<?php
use App\Core\DV;
require_once __DIR__ . '/../../components/Input.php';
require_once __DIR__ . '/../../components/Button.php';

DV::set('title', 'Login');
?>

<div class="max-w-md mx-auto mt-20 bg-slate-800 p-8 rounded-lg border border-slate-700">
    <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
    
    <form method="POST" action="/auth/login">
        <?= csrf_field() ?>
        
        <?= Input('email', 'Email Address', 'email') ?>
        <?= Input('password', 'Password', 'password') ?>
        
        <div class="mt-6">
            <?= Button('Sign In', 'submit', 'w-full') ?>
        </div>
    </form>
</div>
PHP

# Logout
cat > app/auth/logout/+server.php <<PHP
<?php
use App\Core\Auth;
use App\Core\Response;

return [
    'get' => function(\$req) {
        Auth::logout();
        return Response::redirect('/');
    }
];
PHP

#------------------------------------------------------------------------------
# Final Installation & Build
#------------------------------------------------------------------------------
step "Finalizing Installation..."

# 1. Install Composer Deps
echo "Installing PHP Dependencies..."
composer install --quiet

# 2. Install NPM Deps
echo "Installing Frontend Dependencies..."
npm install --silent

# 3. Build CSS
echo "Building Tailwind Assets..."
npm run build --silent

# 4. Migrate Database
echo "Migrating Database..."
php bastion migrate
php bastion seed

# 5. Git Init
git init -q
cat > .gitignore <<GIT
/vendor
/node_modules
/storage/db/*.sqlite
/storage/logs/*.log
.env
.DS_Store
public/css/app.css
GIT

#------------------------------------------------------------------------------
# Success Message
#------------------------------------------------------------------------------
echo ""
echo -e "${GREEN}====================================================${NC}"
echo -e "${BOLD}   Bastion PHP Framework v0.1.0 Installed! ðŸ°${NC}"
echo -e "${GREEN}====================================================${NC}"
echo ""
echo -e "Your fortress is ready at: ${BOLD}$ROOT_DIR${NC}"
echo ""
echo -e "${CYAN}Next Steps:${NC}"
echo -e "  1. cd $PROJECT_NAME"
echo -e "  2. php bastion serve"
echo -e "  3. Visit http://localhost:9000"
echo ""
echo -e "${PURPLE}Default Admin:${NC} admin@example.com / password"
echo ""
