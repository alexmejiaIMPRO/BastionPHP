#!/usr/bin/env bash
#==============================================================================
# Bastion PHP Framework Generator - v0.1.0 (Ultra Secure Edition)
# Non-interactive generator: creates a secure, opinionated project scaffold.
# Usage: ./create-php-app.sh <project-name> [--no-tailwind] [--no-composer] [--force]
#==============================================================================

set -euo pipefail
IFS=$'\n\t'

# small helpers for color output
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; BLUE='\033[0;34m'; NC='\033[0m'
info(){ echo -e "${BLUE}ℹ${NC} $*"; }
success(){ echo -e "${GREEN}✓${NC} $*"; }
warn(){ echo -e "${YELLOW}⚠${NC} $*"; }
fatal(){ echo -e "${RED}✗${NC} $*"; exit 1; }

if [ "$#" -lt 1 ]; then
  cat <<EOF
Usage: $0 <project-name> [--no-tailwind] [--no-composer] [--force]
Generates Bastion PHP v0.1.0 project (secure defaults).
EOF
  exit 1
fi

PROJECT="$1"; shift
NO_TAILWIND=false; NO_COMPOSER=false; FORCE=false
while [ "$#" -gt 0 ]; do
  case "$1" in
    --no-tailwind) NO_TAILWIND=true; shift ;;
    --no-composer) NO_COMPOSER=true; shift ;;
    --force) FORCE=true; shift ;;
    *) fatal "Unknown option: $1" ;;
  esac
done

ROOT="$(pwd)/$PROJECT"
if [ -e "$ROOT" ] && [ "$FORCE" != "true" ]; then
  fatal "Directory $ROOT exists. Use --force to overwrite."
fi

# checks
command -v php >/dev/null 2>&1 || fatal "PHP 8.0+ required."
PHP_VERSION=$(php -r 'echo PHP_VERSION;' 2>/dev/null || echo "0")
if [ "$(printf '%s\n' "8.0" "$PHP_VERSION" | sort -V | head -n1)" != "8.0" ]; then
  fatal "PHP 8.0+ required. Current: $PHP_VERSION"
fi
command -v openssl >/dev/null 2>&1 || warn "openssl not found; using urandom fallback for keys."

info "Creating project $PROJECT"
rm -rf "$ROOT"
mkdir -p "$ROOT"
cd "$ROOT"

generate_key(){
  if command -v openssl >/dev/null 2>&1; then
    openssl rand -base64 32 | tr -d '\n'
  else
    head -c 32 /dev/urandom | base64 | tr -d '\n'
  fi
}

APP_KEY=$(generate_key)
JWT_SECRET=$(generate_key)

# directories
info "Creating directories..."
mkdir -p public app/pages app/components app/layouts api/routers app/core app/middleware app/models app/views config resources/css storage/db storage/logs storage/cache tests vendor

# .gitignore
cat > .gitignore <<'GITIGNORE'
/vendor/
/node_modules/
/storage/db/*.db
/storage/logs/*.log
/public/css/
.env
.env.local
composer.lock
package-lock.json
.DS_Store
GITIGNORE

# .env
cat > .env <<ENV
APP_NAME="Bastion PHP"
APP_ENV=development
APP_DEBUG=true
APP_URL=http://127.0.0.1:9876
APP_KEY=$APP_KEY

DB_CONNECTION=sqlite
DB_PATH=storage/db/app.db

JWT_SECRET=$JWT_SECRET
JWT_ACCESS_EXP=900
JWT_REFRESH_EXP=604800

CSRF_ENABLED=true
SECURE_COOKIES=false

LOG_LEVEL=debug
LOG_FILE=storage/logs/bastion.log
ENV

# composer.json
cat > composer.json <<'JSON'
{
  "name": "bastionphp/app",
  "description": "Bastion PHP - Secure file-based framework",
  "require": {
    "php": "^8.0",
    "firebase/php-jwt": "^6.10"
  },
  "require-dev": {
    "phpunit/phpunit": "^10.0"
  },
  "autoload": {
    "classmap": ["app/core/", "app/middleware/", "app/models/"],
    "files": ["app/core/helpers.php"]
  }
}
JSON

# config files
cat > config/style.php <<'PHP'
<?php
return [
  'useTailwind' => true,
  'tailwindMode' => 'build',
  'fallbackCss' => '/css/fallback.css',
];
PHP

cat > config/app.php <<'PHP'
<?php
return [
  'name' => env('APP_NAME','Bastion PHP'),
  'env' => env('APP_ENV','production'),
  'debug' => env('APP_DEBUG', false),
  'url' => env('APP_URL','http://127.0.0.1:9876'),
  'port' => 9876,
];
PHP

# bootstrap loader
cat > app/bootstrap.php <<'PHP'
<?php
if (getenv('APP_ENV') === 'production') {
    error_reporting(0); ini_set('display_errors','0');
} else {
    error_reporting(E_ALL); ini_set('display_errors','1');
}
$envFile = __DIR__ . '/../.env';
if (file_exists($envFile)) {
    $lines = file($envFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    foreach ($lines as $line) {
        $line = trim($line);
        if ($line === '' || strpos($line,'#') === 0) continue;
        if (strpos($line,'=') !== false) {
            list($k,$v) = explode('=',$line,2);
            $v = trim($v);
            if (preg_match('/^(["\'])(.*)\1$/',$v,$m)) $v = $m[2];
            putenv("$k=$v"); $_ENV[$k] = $v;
        }
    }
}
if (session_status() === PHP_SESSION_NONE && PHP_SAPI !== 'cli') {
    session_start([
        'cookie_httponly' => true,
        'cookie_samesite' => 'Lax',
        'cookie_secure' => getenv('SECURE_COOKIES') === 'true'
    ]);
}
date_default_timezone_set(env('APP_TIMEZONE','UTC'));
PHP

# helpers
cat > app/core/helpers.php <<'PHP'
<?php
if (!function_exists('env')) {
    function env(string $k, $d=null) {
        $v = getenv($k); if ($v === false) return $d;
        if (in_array(strtolower($v), ['true','false'], true)) return $v === 'true';
        return $v;
    }
}
function e($v){ return htmlspecialchars((string)$v, ENT_QUOTES, 'UTF-8'); }
function config($key,$default=null){ static $c=[]; $p=explode('.',$key,2); $file=$p[0]; $k=$p[1]??null; if(!isset($c[$file])){ $path=__DIR__.'/../../config/'.$file.'.php'; $c[$file]=file_exists($path)?require $path:[]; } return $k?($c[$file][$k] ?? $default):($c[$file] ?? $default); }
function logger(){ static $l; if(!$l) $l = new \App\Core\Logger(); return $l; }
PHP

# Error handler
cat > app/core/ErrorHandler.php <<'PHP'
<?php
namespace App\Core;
class ErrorHandler {
    public static function register(): void {
        ini_set('display_errors', env('APP_DEBUG', true) ? '1' : '0');
        error_reporting(E_ALL);
        set_exception_handler([self::class,'handleException']);
        set_error_handler([self::class,'handleError']);
        register_shutdown_function([self::class,'handleShutdown']);
    }
    public static function handleException(\Throwable $e){ self::log($e); if(env('APP_DEBUG',true)){ http_response_code(500); echo "<h1>Exception</h1><pre>".htmlspecialchars($e->__toString())."</pre>"; } else { http_response_code(500); echo "Internal Server Error"; } exit; }
    public static function handleError($no,$str,$file,$line){ $e = new \ErrorException($str,0,$no,$file,$line); self::log($e); if(env('APP_DEBUG',true)){ echo '<pre>'.htmlspecialchars($e->__toString()).'</pre>'; } return true; }
    public static function handleShutdown(){ $err = error_get_last(); if($err){ $e = new \ErrorException($err['message'],0,$err['type'],$err['file'],$err['line']); self::log($e); if(env('APP_DEBUG',true)){ echo '<pre>'.htmlspecialchars($e->__toString()).'</pre>'; } } }
    private static function log(\Throwable $e){ $path = __DIR__ . '/../../' . env('LOG_FILE','storage/logs/bastion.log'); @mkdir(dirname($path),0755,true); $line = '['.date('c').'] '.get_class($e).': '.$e->getMessage().' in '.$e->getFile().':'.$e->getLine()."\n".$e->getTraceAsString()."\n\n"; @file_put_contents($path,$line,FILE_APPEND|LOCK_EX); }
}
PHP

# core (DB, QueryBuilder, Request, Response, Logger)
cat > app/core/DB.php <<'PHP'
<?php
namespace App\Core;
use PDO;
class DB {
    private static ?PDO $pdo = null;
    public static function pdo(): PDO {
        if(self::$pdo) return self::$pdo;
        $conn = env('DB_CONNECTION','sqlite');
        if($conn === 'sqlite'){
            $p = __DIR__ . '/../../' . env('DB_PATH','storage/db/app.db');
            $dsn = "sqlite:$p";
            self::$pdo = new PDO($dsn);
            self::$pdo->exec('PRAGMA journal_mode=WAL');
            self::$pdo->exec('PRAGMA synchronous=NORMAL');
        } else { throw new \RuntimeException('Only sqlite supported in this generator'); }
        self::$pdo->setAttribute(PDO::ATTR_ERRMODE,PDO::ERRMODE_EXCEPTION);
        self::$pdo->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE,PDO::FETCH_ASSOC);
        return self::$pdo;
    }
    public static function table(string $t){ return new QueryBuilder($t); }
}
class QueryBuilder {
    private string $table; private array $w=[]; private array $b=[]; private ?int $l=null;
    public function __construct(string $t){ $this->table=$t; }
    public function where(string $c,$v){ $this->w[] = "$c = ?"; $this->b[] = $v; return $this; }
    public function limit(int $n){ $this->l = $n; return $this; }
    public function get(): array {
        $sql = "SELECT * FROM {$this->table}";
        if($this->w) $sql .= " WHERE " . implode(' AND ',$this->w);
        if($this->l) $sql .= " LIMIT {$this->l}";
        $stmt = DB::pdo()->prepare($sql); $stmt->execute($this->b); return $stmt->fetchAll();
    }
    public function first(): ?array { $r = $this->limit(1)->get(); return $r[0] ?? null; }
    public function insert(array $data): int {
        $cols = array_keys($data); $ph = array_fill(0,count($cols),'?');
        $sql = "INSERT INTO {$this->table} (".implode(', ',$cols).") VALUES (".implode(', ',$ph).")";
        $stmt = DB::pdo()->prepare($sql); $stmt->execute(array_values($data)); return (int)DB::pdo()->lastInsertId();
    }
}
PHP

cat > app/core/Request.php <<'PHP'
<?php
namespace App\Core;
class Request {
    public string $method; public string $path; public array $query; public array $body; public array $headers; public array $cookies; public array $files; public array $meta=[];
    private ?array $json=null;
    public function __construct(){
        $this->method = $_SERVER['REQUEST_METHOD'] ?? 'GET';
        $this->path = trim(parse_url($_SERVER['REQUEST_URI'] ?? '/','path'),'/');
        $this->query = $_GET; $this->body = $_POST; $this->headers = $this->getHeaders(); $this->cookies = $_COOKIE; $this->files = $_FILES;
    }
    private function getHeaders(): array {
        if(function_exists('getallheaders')) return getallheaders() ?: [];
        $h=[]; foreach($_SERVER as $k=>$v) if(strpos($k,'HTTP_')===0) { $key = str_replace(' ','-',ucwords(str_replace('_',' ',strtolower(substr($k,5))))); $h[$key]=$v; } return $h;
    }
    public function json(): array {
        if($this->json!==null) return $this->json;
        $ct = $this->headers['Content-Type'] ?? '';
        if(stripos($ct,'application/json')!==false) $this->json = json_decode(file_get_contents('php://input'), true) ?? [];
        else $this->json = [];
        return $this->json;
    }
    public function input(string $k,$d=null){ return $this->body[$k] ?? $this->json()[$k] ?? $d; }
    public function isJson(): bool { return stripos($this->headers['Content-Type'] ?? '','application/json') !== false; }
}
PHP

cat > app/core/Response.php <<'PHP'
<?php
namespace App\Core;
class Response {
    public static function json($d,int $c=200){ http_response_code($c); header('Content-Type: application/json'); echo json_encode($d); exit; }
    public static function html(string $s,int $c=200){ http_response_code($c); header('Content-Type: text/html; charset=UTF-8'); echo $s; exit; }
    public static function redirect(string $u,int $c=302){ $u = str_replace(["\r","\n"],'',$u); header("Location: $u", true, $c); exit; }
}
PHP

cat > app/core/Logger.php <<'PHP'
<?php
namespace App\Core;
class Logger {
    private string $file; private string $level;
    private const LV = ['debug'=>0,'info'=>1,'warning'=>2,'error'=>3];
    public function __construct(){ $this->file = __DIR__ . '/../../' . env('LOG_FILE','storage/logs/bastion.log'); $this->level = env('LOG_LEVEL','info'); }
    private function write($lvl,$msg,$ctx=[]){ if(self::LV[$lvl] < self::LV[$this->level]) return; $t=date('Y-m-d H:i:s'); $s = "[$t] ".strtoupper($lvl).": $msg".(!empty($ctx)?' '.json_encode($ctx):'')."\n"; @mkdir(dirname($this->file),0755,true); @file_put_contents($this->file,$s,FILE_APPEND|LOCK_EX); }
    public function debug($m,$c=[]) { $this->write('debug',$m,$c); } public function info($m,$c=[]) { $this->write('info',$m,$c); } public function warning($m,$c=[]) { $this->write('warning',$m,$c); } public function error($m,$c=[]) { $this->write('error',$m,$c); }
}
PHP

# ApiRouter (FastAPI-style)
cat > api/ApiRouter.php <<'PHP'
<?php
namespace Api;
use App\Core\Request;
class ApiRouter {
    private array $routes = [];
    public function include(string $file, string $prefix = '', array $tags = []) {
        if (!file_exists($file)) throw new \RuntimeException("Router not found: $file");
        $map = require $file;
        foreach ($map as $def => $handler) {
            [$method, $path] = explode(' ', $def, 2);
            $method = strtoupper(trim($method));
            $path = rtrim('/'.trim($prefix,'/').'/'.trim($path,'/'), '/');
            if ($path === '') $path = '/';
            $this->routes[] = ['method'=>$method,'path'=>$path,'handler'=>$handler,'tags'=>$tags];
        }
    }
    public function dispatch(\App\Core\Request $req) {
        $rpath = '/'.trim($req->path,'/');
        foreach ($this->routes as $route) {
            if ($route['method'] !== $req->method) continue;
            $pattern = preg_replace('/\{([^\/]+)\}/','([^/]+)',$route['path']);
            $pattern = "#^" . $pattern . "$#";
            if (preg_match($pattern, $rpath, $matches)) {
                array_shift($matches);
                return call_user_func_array($route['handler'], array_merge([$req], $matches));
            }
        }
        return ['error'=>'API route not found','status'=>404];
    }
    public function routes(): array { return $this->routes; }
}
PHP

cat > api/main.php <<'PHP'
<?php
use Api\ApiRouter;
$api = new ApiRouter();
$api->include(__DIR__ . '/routers/users.php','/users',['users']);
$api->include(__DIR__ . '/routers/products.php','/products',['products']);
$api->include(__DIR__ . '/routers/auth.php','/auth',['auth']);
return $api;
PHP

# sample routers
cat > api/routers/users.php <<'PHP'
<?php
use App\Core\DB; use App\Core\Response;
return [
  'GET /' => function($req){ return DB::table('users')->get(); },
  'POST /' => function($req){ $d = $req->json(); if(empty($d['email'])||empty($d['password'])) return Response::json(['error'=>'email/password required'],400); $id = DB::table('users')->insert(['email'=>$d['email'],'password'=>password_hash($d['password'],PASSWORD_DEFAULT),'name'=>$d['name']??'','created_at'=>time()]); return ['id'=>$id]; },
  'GET /{id}' => function($req,$id){ $u = DB::table('users')->where('id',$id)->first(); return $u ?: Response::json(['error'=>'not found'],404); },
  'PUT /{id}' => function($req,$id){ $d = $req->json(); DB::pdo()->prepare('UPDATE users SET email=?, name=? WHERE id=?')->execute([$d['email'],$d['name'],$id]); return ['updated'=>true]; },
  'DELETE /{id}' => function($req,$id){ DB::pdo()->prepare('DELETE FROM users WHERE id=?')->execute([$id]); return ['deleted'=>true]; },
];
PHP

cat > api/routers/products.php <<'PHP'
<?php
use App\Core\DB; use App\Core\Response;
return [
  'GET /' => fn($req)=>DB::table('products')->get(),
  'POST /' => function($req){ $d=$req->json(); $id=DB::table('products')->insert($d); return ['id'=>$id]; },
  'GET /{id}' => function($req,$id){ $p=DB::table('products')->where('id',$id)->first(); return $p?:Response::json(['error'=>'not found'],404); }
];
PHP

cat > api/routers/auth.php <<'PHP'
<?php
use App\Core\DB; use App\Core\Response;
return [
  'POST /login' => function($req){
    $d = $req->json(); $u = DB::table('users')->where('email',$d['email'] ?? '')->first();
    if(!$u || !password_verify($d['password'] ?? '', $u['password'] ?? '')) return Response::json(['error'=>'invalid'],401);
    return ['token' => base64_encode(random_bytes(32))];
  }
];
PHP

# PageRouter
cat > app/core/PageRouter.php <<'PHP'
<?php
namespace App\Core;
class PageRouter {
    public function dispatch(Request $req){
        $path = trim($req->path,'/');
        $base = __DIR__ . '/../../app/pages';
        if ($path === '' || $path === '/') $candidate = $base . '/index/page.php';
        else $candidate = $base . '/' . $path . '/page.php';
        if (file_exists($candidate)) return $this->renderFile($candidate, $req);
        $segments = $path === '' ? [] : explode('/',$path);
        $current = $base; $params = [];
        foreach ($segments as $seg){
            $direct = "$current/$seg";
            if (is_dir($direct)) { $current = $direct; continue; }
            $found=false;
            foreach (glob("$current/*", GLOB_ONLYDIR) as $dir) {
                if (preg_match('/^\[(.+)\]$/',basename($dir),$m)){ $params[$m[1]]=$seg; $current=$dir; $found=true; break; }
            }
            if(!$found) return $this->render404();
        }
        $page = $current . '/page.php';
        if(file_exists($page)) return $this->renderFile($page,$req,$params);
        return $this->render404();
    }
    private function renderFile($file,$req,$params=[]){ extract(['req'=>$req,'params'=>$params], EXTR_SKIP); ob_start(); include $file; return ob_get_clean(); }
    private function render404(){ http_response_code(404); return '<h1>404 - Page not found</h1>'; }
}
PHP

# public front controller
cat > public/index.php <<'PHP'
<?php
require_once __DIR__ . '/../vendor/autoload.php';
require_once __DIR__ . '/../app/bootstrap.php';
\App\Core\ErrorHandler::register();
use App\Core\Request; use App\Core\Response; use App\Core\PageRouter;
$req = new Request();
if (strpos('/'.trim($req->path,'/'), 'api') === 0 || strpos($req->path,'api/') === 0) {
    $req->path = preg_replace('#^/?api#', '', $req->path);
    $req->path = ltrim($req->path, '/');
    $api = require __DIR__ . '/../api/main.php';
    $res = $api->dispatch($req);
    if (is_array($res)) { Response::json($res, $res['status'] ?? 200); } else { Response::json($res); }
    exit;
}
$pr = new PageRouter(); echo $pr->dispatch($req);
PHP

# minimal layout + example page
cat > app/layouts/layout.php <<'PHP'
<?php $title = $title ?? 'Bastion App'; ?>
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title><?= e($title) ?></title><?php if(config('style.useTailwind',true) && config('style.tailwindMode')==='build'): ?><link rel="stylesheet" href="/css/app.css"><?php else: ?><link rel="stylesheet" href="/css/fallback.css"><?php endif; ?></head><body><?= $content ?></body></html>
PHP

mkdir -p app/pages/index
cat > app/pages/index/page.php <<'PHP'
<?php $title = 'Welcome'; ob_start(); ?>
<h1>Welcome to Bastion PHP</h1>
<p>Basic page generated by create-php-app.sh v0.1.0</p>
<?php $content = ob_get_clean(); require __DIR__ . '/../../layouts/layout.php'; ?>
PHP

# fallback CSS and resources
mkdir -p public/css resources/css
cat > public/css/fallback.css <<'CSS'
body { font-family: system-ui, sans-serif; padding: 2rem; background:#f8fafc; color:#0f172a; }
h1{ font-size:2rem; margin-bottom:1rem; }
CSS

cat > resources/css/app.css <<'CSS'
@tailwind base;
@tailwind components;
@tailwind utilities;
CSS

# .htaccess
cat > public/.htaccess <<'HTA'
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^ index.php [QSA,L]
HTA

# sqlite initial tables
touch storage/db/app.db
php -r "require 'app/bootstrap.php'; \$db = new PDO('sqlite:'.__DIR__.'/storage/db/app.db'); \$db->exec('CREATE TABLE IF NOT EXISTS users (id INTEGER PRIMARY KEY AUTOINCREMENT, email TEXT UNIQUE, password TEXT, name TEXT, created_at INTEGER)'); \$db->exec('CREATE TABLE IF NOT EXISTS products (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, price INTEGER)'); \$db->exec('CREATE TABLE IF NOT EXISTS refresh_tokens (id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER, selector TEXT, validator_hash TEXT, expires_at INTEGER)');"

# CLI 'bastion'
cat > bastion <<'BASH'
#!/usr/bin/env bash
ROOT="$(cd "$(dirname "$0")" && pwd)"
PHP_BIN="${PHP_BIN:-php}"
NPX="${NPX:-npx}"
BS="$(command -v browser-sync || true)"
cd "$ROOT"
case "$1" in
  run-dev)
    echo "Starting PHP dev server on 127.0.0.1:8000..."
    $PHP_BIN -S 127.0.0.1:8000 -t public >/dev/null 2>&1 &
    PHP_PID=$!
    echo "PHP pid: $PHP_PID"
    echo "Starting Tailwind watch..."
    $NPX tailwindcss -i ./resources/css/app.css -o ./public/css/app.css --watch >/dev/null 2>&1 &
    TW_PID=$!
    if [ -n "$BS" ]; then
      echo "Starting browser-sync proxy :9876..."
      browser-sync start --proxy "127.0.0.1:8000" --port 9876 --files "public/css/*.css, public/*.php, app/**/*.php" --no-ui --no-notify >/dev/null 2>&1 &
      BS_PID=$!
      echo "Browsersync pid: $BS_PID"
    else
      echo "browser-sync not found; use 'npm i -g browser-sync' or install via npm"
    fi
    trap 'kill $PHP_PID $TW_PID ${BS_PID:-} 2>/dev/null; exit' SIGINT SIGTERM
    wait
    ;;
  run-build)
    echo "Building assets..."
    $NPX tailwindcss -i ./resources/css/app.css -o ./public/css/app.css --minify
    echo "Build complete."
    ;;
  make:api)
    name="$2"
    if [ -z "$name" ]; then echo "Usage: bastion make:api <name>"; exit 1; fi
    file="api/routers/${name}.php"
    if [ -e "$file" ]; then echo "Router exists: $file"; exit 1; fi
    cat > "$file" <<'PHP'
<?php
use App\Core\DB; use App\Core\Response;
return [
  'GET /' => fn($req)=>DB::table('PLACEHOLDER')->get()
];
PHP
    perl -0777 -pe "s|(\$api->include\\(__DIR__ . '/routers/users.php'.*?\\);)|\$1\n\$api->include(__DIR__ . '/routers/${name}.php','/${name}', ['${name}']);|s" -i api/main.php
    echo "Created $file and registered."
    ;;
  make:page)
    path="$2"
    if [ -z "$path" ]; then echo "Usage: bastion make:page <path>"; exit 1; fi
    dir="app/pages/$path"
    mkdir -p "$dir"
    file="$dir/page.php"
    if [ -e "$file" ]; then echo "Page exists: $file"; exit 1; fi
    cat > "$file" <<'PHP'
<?php ob_start(); ?>
<h1>Generated page</h1>
<p>Path: <?= e($_SERVER['REQUEST_URI'] ?? '/') ?></p>
<?php $content = ob_get_clean(); require __DIR__ . '/../../layouts/layout.php'; ?>
PHP
    echo "Created page $file"
    ;;
  test)
    if [ -x vendor/bin/phpunit ]; then vendor/bin/phpunit || exit 1; else echo "phpunit not installed"; exit 1; fi
    ;;
  *)
    echo "Usage: bastion {run-dev|run-build|make:api|make:page|test}"
    ;;
esac
BASH
chmod +x bastion

# phpunit config and a tiny test
cat > phpunit.xml <<'XML'
<?xml version="1.0" encoding="UTF-8"?>
<phpunit bootstrap="tests/bootstrap.php" colors="true">
  <testsuites>
    <testsuite name="Unit">
      <directory>tests</directory>
    </testsuite>
  </testsuites>
</phpunit>
XML

cat > tests/bootstrap.php <<'PHP'
<?php
require __DIR__ . '/../vendor/autoload.php';
require __DIR__ . '/../app/bootstrap.php';
PHP

cat > tests/DBTest.php <<'PHP'
<?php
use PHPUnit\Framework\TestCase;
class DBTest extends TestCase {
    public function testPdo() {
        $pdo = \App\Core\DB::pdo();
        $this->assertInstanceOf(PDO::class,$pdo);
    }
}
PHP

# Node scaffold if tailwind requested
if [ "$NO_TAILWIND" = false ]; then
  if [ ! -f package.json ]; then
    cat > package.json <<'JSON'
{
  "name": "bastion-app",
  "private": true,
  "devDependencies": {
    "tailwindcss": "^3.4.0",
    "browser-sync": "^2.27.10"
  },
  "scripts": {
    "dev": "tailwindcss -i ./resources/css/app.css -o ./public/css/app.css --watch",
    "build": "tailwindcss -i ./resources/css/app.css -o ./public/css/app.css --minify"
  }
}
JSON
    success "package.json created (run npm install to install dev deps)"
  fi
fi

# Composer
if [ "$NO_COMPOSER" = false ]; then
  if command -v composer >/dev/null 2>&1; then
    info "Running composer install..."
    composer install --no-interaction --prefer-dist
    success "Composer installed"
  else
    warn "composer not found; run 'composer install' later"
  fi
else
  info "Skipping composer install"
fi

success "Bastion PHP v0.1.0 scaffold created at $ROOT"
echo ""
echo "Next steps:"
echo "  cd $PROJECT"
echo "  chmod +x bastion"
echo "  ./bastion run-dev      # dev server + tailwind watch + browsersync"
echo "  ./bastion run-build    # build assets for production"
echo ""
echo "Security notes:"
echo " - Set APP_ENV=production and SECURE_COOKIES=true for production."
echo " - Keep JWT_SECRET and APP_KEY secret & out of VCS."
echo ""

    TW_PID=$!
    if [ -n "$BS" ]; then
      echo "Starting browser-sync proxy :9876..."
      browser-sync start --pro