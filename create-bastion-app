#!/usr/bin/env bash
#==============================================================================
# Bastion PHP Framework Generator (v0.1.3)
#
# This script scaffolds a *Bastion PHP* project including:
#
#  - filesystem-based routing (Next.js style: app/layout.php, app/page.php)
#  - nested layouts per folder (app/admin/layout.php, etc.)
#  - DV Engine (Data View) to push state from page.php → layout.php
#  - FastAPI-style API endpoints via app/api/.../+server.php
#  - dynamic routes via [id] folders (e.g. /api/users/[id]/+server.php)
#  - QueryBuilder on top of PDO (SQLite by default)
#  - config()/env() helpers and config/*.php
#  - security middleware: SecurityHeaders + CSRF middleware
#  - session+role based Auth (admin/user) with login/logout
#  - global helpers: e(), csrf_field(), csrf_token(), env(), config(), logger()
#  - Tailwind v4 (CLI) dev/build with resources/css/app.css → public/css/app.css
#  - bastion CLI: run-dev, migrate, seed, build (BrowserSync proxy :9876)
#
# Philosophy:
#  - Internal tools, but with production-grade security by default.
#  - Junior-friendly but senior-tweakable in config and src/Core.
#==============================================================================

set -euo pipefail

#------------------------------------------------------------------------------
# COLORS & LOG FUNCTIONS
#------------------------------------------------------------------------------
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[0;33m'
NC='\033[0m'

info()    { echo -e "${BLUE}ℹ${NC} $1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
warn()    { echo -e "${YELLOW}!${NC} $1"; }
error()   { echo -e "${RED}✗${NC} $1"; exit 1; }

#------------------------------------------------------------------------------
# PROJECT NAME
#------------------------------------------------------------------------------
PROJECT="${1:-bastion-demo}"

if [[ -e "$PROJECT" ]]; then
  error "Target directory '$PROJECT' already exists. Choose another name or remove it."
fi

info "Scaffolding Bastion PHP project in ./$PROJECT"
mkdir -p "$PROJECT"
cd "$PROJECT"

PROJECT_ROOT="$(pwd)"

#==============================================================================
# 1. DIRECTORY STRUCTURE
#==============================================================================

info "Creating directory tree..."

mkdir -p app
mkdir -p app/admin app/login app/logout app/api app/components
mkdir -p config
mkdir -p database/migrations database/seeds
mkdir -p public
mkdir -p src/Core src/Middleware src/Models src/Services
mkdir -p storage/db storage/logs
mkdir -p resources/css resources/js

#==============================================================================
# 2. COMPOSER & .ENV
#==============================================================================

info "Writing composer.json..."

cat > composer.json <<'JSON'
{
  "name": "company/bastion-app",
  "description": "Bastion PHP internal tool",
  "type": "project",
  "require": {
    "php": ">=8.1",
    "vlucas/phpdotenv": "^5.6",
    "firebase/php-jwt": "^6.0"
  },
  "autoload": {
    "psr-4": {
      "App\\": "src/"
    },
    "files": [
      "src/Core/helpers.php"
    ]
  }
}
JSON

info "Creating .env example..."

cat > .env <<'ENV'
APP_NAME="Bastion App"
APP_ENV=local
APP_DEBUG=true
APP_TIMEZONE="UTC"

DB_CONNECTION=sqlite
DB_PATH="storage/db/app.db"

# For MySQL (optional)
DB_HOST="127.0.0.1"
DB_DATABASE="bastion"
DB_USERNAME="root"
DB_PASSWORD=""

# Security
CSRF_ENABLED=true
SECURE_COOKIES=false
SAME_SITE="Lax"
ENV

#==============================================================================
# 3. CONFIG FILES (app, database, security)
#==============================================================================

info "Creating config files..."

cat > config/app.php <<'PHP'
<?php

return [
    'name'     => env('APP_NAME', 'Bastion App'),
    'env'      => env('APP_ENV', 'local'),
    'debug'    => (bool) env('APP_DEBUG', false),
    'timezone' => env('APP_TIMEZONE', 'UTC'),
];
PHP

cat > config/database.php <<'PHP'
<?php

return [
    'default' => env('DB_CONNECTION', 'sqlite'),

    'connections' => [
        'sqlite' => [
            'driver' => 'sqlite',
            'path'   => env('DB_PATH', 'storage/db/app.db'),
        ],
        'mysql' => [
            'driver'   => 'mysql',
            'host'     => env('DB_HOST', '127.0.0.1'),
            'database' => env('DB_DATABASE', 'bastion'),
            'username' => env('DB_USERNAME', 'root'),
            'password' => env('DB_PASSWORD', ''),
        ],
    ],
];
PHP

cat > config/security.php <<'PHP'
<?php

return [
    'csrf_enabled'    => (bool) env('CSRF_ENABLED', true),
    'secure_cookies'  => (bool) env('SECURE_COOKIES', false),
    'same_site'       => env('SAME_SITE', 'Lax'),

    // CSP script-src: in this Tailwind v4 setup we do NOT use CDN tailwindcss.com
    'csp_script_src'  => [
        "'self'",
    ],
];
PHP

#==============================================================================
# 4. CORE: ENV & CONFIG & LOGGER & HELPERS
#==============================================================================

info "Creating Core utility classes..."

cat > src/Core/Env.php <<'PHP'
<?php
namespace App\Core;

class Env
{
    protected static bool $loaded = false;

    public static function load(string $basePath): void
    {
        if (self::$loaded) {
            return;
        }

        $envFile = $basePath . '/.env';
        if (!is_file($envFile)) {
            self::$loaded = true;
            return;
        }

        $lines = file($envFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
        foreach ($lines as $line) {
            if (str_starts_with(trim($line), '#')) {
                continue;
            }
            if (!str_contains($line, '=')) {
                continue;
            }
            [$key, $value] = explode('=', $line, 2);
            $key   = trim($key);
            $value = trim($value);

            // Strip quotes if present
            if (
                (str_starts_with($value, '"') && str_ends_with($value, '"')) ||
                (str_starts_with($value, "'") && str_ends_with($value, "'"))
            ) {
                $value = substr($value, 1, -1);
            }

            if (!array_key_exists($key, $_ENV) && !array_key_exists($key, $_SERVER)) {
                putenv("$key=$value");
                $_ENV[$key] = $value;
            }
        }

        self::$loaded = true;
    }

    public static function get(string $key, mixed $default = null): mixed
    {
        $val = $_ENV[$key] ?? $_SERVER[$key] ?? getenv($key);
        return $val === false || $val === null ? $default : $val;
    }
}
PHP

cat > src/Core/Config.php <<'PHP'
<?php
namespace App\Core;

class Config
{
    protected static array $cache = [];

    public static function get(string $key, mixed $default = null): mixed
    {
        [$file, $path] = array_pad(explode('.', $key, 2), 2, null);
        if (!$file) {
            return $default;
        }

        if (!isset(self::$cache[$file])) {
            $base = defined('BASTION_BASE_PATH') ? BASTION_BASE_PATH : dirname(__DIR__, 2);
            $filePath = $base . '/config/' . $file . '.php';
            if (!is_file($filePath)) {
                return $default;
            }
            self::$cache[$file] = require $filePath;
        }

        if ($path === null) {
            return self::$cache[$file] ?? $default;
        }

        $value = self::$cache[$file];
        foreach (explode('.', $path) as $segment) {
            if (!is_array($value) || !array_key_exists($segment, $value)) {
                return $default;
            }
            $value = $value[$segment];
        }

        return $value;
    }
}
PHP

cat > src/Core/Logger.php <<'PHP'
<?php
namespace App\Core;

class Logger
{
    public static function log(string $level, string $message, array $context = []): void
    {
        $base = defined('BASTION_BASE_PATH') ? BASTION_BASE_PATH : dirname(__DIR__, 2);
        $logDir = $base . '/storage/logs';

        if (!is_dir($logDir)) {
            @mkdir($logDir, 0777, true);
        }

        $file = $logDir . '/app.log';

        $line = sprintf(
            "[%s] %s: %s %s\n",
            date('Y-m-d H:i:s'),
            strtoupper($level),
            $message,
            $context ? json_encode($context, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES) : ''
        );

        @file_put_contents($file, $line, FILE_APPEND);
    }

    public static function info(string $message, array $context = []): void
    {
        self::log('info', $message, $context);
    }

    public static function error(string $message, array $context = []): void
    {
        self::log('error', $message, $context);
    }
}
PHP

cat > src/Core/helpers.php <<'PHP'
<?php

use App\Core\Env;
use App\Core\Config;
use App\Core\Logger;
use App\Core\DV;
use App\Middleware\CsrfMiddleware;

/**
 * Escape HTML safely (mandatory when echoing user data).
 */
function e(?string $value): string
{
    return htmlspecialchars($value ?? '', ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
}

/**
 * Read environment variable, falling back to default.
 */
function env(string $key, mixed $default = null): mixed
{
    return Env::get($key, $default);
}

/**
 * Read config/app.php etc with dot notation.
 */
function config(string $key, mixed $default = null): mixed
{
    return Config::get($key, $default);
}

/**
 * Minimal logger helper.
 */
function logger(): Logger
{
    // just return class name as a “facade-like” shim
    return new class {
        public function info(string $msg, array $ctx = []): void
        {
            \App\Core\Logger::info($msg, $ctx);
        }
        public function error(string $msg, array $ctx = []): void
        {
            \App\Core\Logger::error($msg, $ctx);
        }
    };
}

/**
 * DV Engine helpers.
 */
function dv_set(string $key, mixed $value): void
{
    DV::set($key, $value);
}

function dv_get(string $key, mixed $default = null): mixed
{
    return DV::get($key, $default);
}

/**
 * CSRF helpers (for forms and JS).
 */
function csrf_token(): string
{
    return CsrfMiddleware::token();
}

function csrf_field(): string
{
    $token = csrf_token();
    return '<input type="hidden" name="_token" value="' . e($token) . '">';
}
PHP
cat > src/Core/DV.php <<'PHP'
<?php
namespace App\Core;

/**
 * DV (Data View) Engine
 *
 * Used to push "view state" from page.php → layout.php, or even
 * between nested layouts. Example use cases:
 *
 *  - Dynamic page titles
 *  - Breadcrumb arrays
 *  - Layout flags (show_sidebar, full_width, etc.)
 *  - Script/style injection per page
 */
class DV
{
    protected static array $bag = [];

    public static function set(string $key, mixed $value): void
    {
        self::$bag[$key] = $value;
    }

    public static function get(string $key, mixed $default = null): mixed
    {
        return self::$bag[$key] ?? $default;
    }

    public static function all(): array
    {
        return self::$bag;
    }

    public static function merge(array $data): void
    {
        self::$bag = array_merge(self::$bag, $data);
    }
}
PHP

cat > src/Core/Request.php <<'PHP'
<?php
namespace App\Core;

/**
 * Normalized HTTP Request object for Bastion.
 *
 * Syntax Explanation:
 *  - $method: HTTP verb (GET, POST, etc.)
 *  - $path: normalized path ("/", "/admin", "/api/users/1")
 *  - $query: GET parameters
 *  - $body: POST/JSON payload
 */
class Request
{
    public string $method;
    public string $path;
    public array $query;
    public array $body;
    public array $files;
    public array $server;
    public array $cookies;
    public array $headers;

    // Path params like /api/users/123 → $req->path_param_id = 123
    public ?int $path_param_id = null;

    public function __construct()
    {
        $this->server  = $_SERVER;
        $this->method  = strtoupper($this->server['REQUEST_METHOD'] ?? 'GET');
        $this->cookies = $_COOKIE;
        $this->headers = $this->collectHeaders();

        $uri  = $this->server['REQUEST_URI'] ?? '/';
        $path = parse_url($uri, PHP_URL_PATH) ?: '/';
        $this->path = rtrim($path, '/') ?: '/';

        $this->query = $_GET;

        $raw = file_get_contents('php://input');
        $this->body = $_POST;

        if ($raw && empty($_POST) && $this->isJson()) {
            $json = json_decode($raw, true);
            if (json_last_error() === JSON_ERROR_NONE && is_array($json)) {
                $this->body = $json;
            }
        }

        $this->files = $_FILES;
    }

    protected function collectHeaders(): array
    {
        $headers = [];
        foreach ($this->server as $key => $value) {
            if (str_starts_with($key, 'HTTP_')) {
                $hName = str_replace('_', '-', substr($key, 5));
                $headers[$hName] = $value;
            }
        }

        if (isset($this->server['CONTENT_TYPE'])) {
            $headers['Content-Type'] = $this->server['CONTENT_TYPE'];
        }

        return $headers;
    }

    public function isJson(): bool
    {
        $ct = $this->headers['Content-Type'] ?? '';
        return str_contains($ct, 'application/json');
    }

    public function input(string $key, mixed $default = null): mixed
    {
        return $this->body[$key] ?? $this->query[$key] ?? $default;
    }

    public function all(): array
    {
        return array_merge($this->query, $this->body);
    }
}
PHP

cat > src/Core/Response.php <<'PHP'
<?php
namespace App\Core;

class Response
{
    public static function json(mixed $data, int $status = 200): void
    {
        http_response_code($status);
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode($data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
        exit;
    }

    public static function redirect(string $location, int $status = 302): void
    {
        http_response_code($status);
        header('Location: ' . $location);
        exit;
    }

    public static function abort(int $status = 404, string $message = 'Not found'): void
    {
        http_response_code($status);
        header('Content-Type: text/plain; charset=utf-8');
        echo $message;
        exit;
    }
}
PHP

cat > src/Core/DB.php <<'PHP'
<?php
namespace App\Core;

use PDO;
use PDOException;

/**
 * Database facade + QueryBuilder.
 *
 * - Supports SQLite out of the box, but config/database.php allows MySQL.
 * - Uses WAL mode for SQLite to support concurrent writes.
 */
class DB
{
    protected static ?PDO $pdo = null;

    public static function conn(): PDO
    {
        if (self::$pdo) {
            return self::$pdo;
        }

        $base = defined('BASTION_BASE_PATH') ? BASTION_BASE_PATH : dirname(__DIR__, 2);
        $driver = config('database.default', 'sqlite');

        $connections = config('database.connections', []);
        $cfg = $connections[$driver] ?? null;

        if (!$cfg) {
            throw new \RuntimeException("Database config for driver '$driver' not found.");
        }

        try {
            if ($driver === 'sqlite') {
                $path = $cfg['path'] ?? ($base . '/storage/db/app.db');
                if (!is_dir(dirname($path))) {
                    @mkdir(dirname($path), 0777, true);
                }
                $dsn = 'sqlite:' . $path;
                $pdo = new PDO($dsn);
                $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
                $pdo->exec('PRAGMA journal_mode=WAL;');
                $pdo->exec('PRAGMA foreign_keys = ON;');
            } elseif ($driver === 'mysql') {
                $host = $cfg['host'] ?? '127.0.0.1';
                $db   = $cfg['database'] ?? 'bastion';
                $user = $cfg['username'] ?? 'root';
                $pass = $cfg['password'] ?? '';
                $dsn  = "mysql:host=$host;dbname=$db;charset=utf8mb4";
                $pdo  = new PDO($dsn, $user, $pass);
                $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            } else {
                throw new \RuntimeException("Unsupported DB driver '$driver'.");
            }
        } catch (PDOException $e) {
            Logger::error('DB connection failed', ['error' => $e->getMessage()]);
            throw $e;
        }

        self::$pdo = $pdo;
        return self::$pdo;
    }

    public static function table(string $table): QueryBuilder
    {
        return new QueryBuilder(self::conn(), $table);
    }
}

/**
 * QueryBuilder – syntax inspired by your docs.
 *
 * Examples:
 *   DB::table('users')->where('role', 'admin')->orderBy('created_at','DESC')->limit(10)->get();
 *   DB::table('logs')->insert([...]);
 *   DB::table('users')->where('id',1)->update(['active'=>1]);
 */
class QueryBuilder
{
    protected PDO $pdo;
    protected string $table;
    protected array $wheres = [];
    protected array $bindings = [];
    protected ?int $limit = null;
    protected ?int $offset = null;
    protected array $orderBys = [];

    public function __construct(PDO $pdo, string $table)
    {
        $this->pdo   = $pdo;
        $this->table = $table;
    }

    public function where(string $column, string $operator, mixed $value = null): self
    {
        if ($value === null) {
            $value    = $operator;
            $operator = '=';
        }
        $this->wheres[]   = [$column, $operator, $value];
        $this->bindings[] = $value;
        return $this;
    }

    public function limit(int $limit): self
    {
        $this->limit = $limit;
        return $this;
    }

    public function offset(int $offset): self
    {
        $this->offset = $offset;
        return $this;
    }

    public function orderBy(string $column, string $direction = 'ASC'): self
    {
        $this->orderBys[] = [$column, strtoupper($direction)];
        return $this;
    }

    protected function buildSelect(): string
    {
        $sql = "SELECT * FROM {$this->table}";

        if ($this->wheres) {
            $parts = [];
            foreach ($this->wheres as [$col, $op, $val]) {
                $parts[] = "$col $op ?";
            }
            $sql .= ' WHERE ' . implode(' AND ', $parts);
        }

        if ($this->orderBys) {
            $parts = [];
            foreach ($this->orderBys as [$col, $dir]) {
                $parts[] = "$col $dir";
            }
            $sql .= ' ORDER BY ' . implode(', ', $parts);
        }

        if ($this->limit !== null) {
            $sql .= ' LIMIT ' . $this->limit;
        }

        if ($this->offset !== null) {
            $sql .= ' OFFSET ' . $this->offset;
        }

        return $sql;
    }

    public function get(): array
    {
        $sql  = $this->buildSelect();
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute($this->bindings);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }

    public function first(): ?array
    {
        $this->limit(1);
        $rows = $this->get();
        return $rows[0] ?? null;
    }

    public function insert(array $data): int
    {
        $columns = array_keys($data);
        $place   = implode(', ', array_fill(0, count($columns), '?'));
        $colSql  = implode(', ', $columns);

        $sql  = "INSERT INTO {$this->table} ({$colSql}) VALUES ({$place})";
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute(array_values($data));

        return (int) $this->pdo->lastInsertId();
    }

    public function update(array $data): int
    {
        $setParts = [];
        $values   = [];

        foreach ($data as $col => $val) {
            $setParts[] = "$col = ?";
            $values[]   = $val;
        }

        $sql = "UPDATE {$this->table} SET " . implode(', ', $setParts);

        if ($this->wheres) {
            $whereParts = [];
            foreach ($this->wheres as [$col, $op, $val]) {
                $whereParts[] = "$col $op ?";
                $values[]     = $val;
            }
            $sql .= ' WHERE ' . implode(' AND ', $whereParts);
        }

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute($values);

        return $stmt->rowCount();
    }

    public function delete(): int
    {
        $sql    = "DELETE FROM {$this->table}";
        $values = [];

        if ($this->wheres) {
            $whereParts = [];
            foreach ($this->wheres as [$col, $op, $val]) {
                $whereParts[] = "$col $op ?";
                $values[]     = $val;
            }
            $sql .= ' WHERE ' . implode(' AND ', $whereParts);
        }

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute($values);

        return $stmt->rowCount();
    }
}
PHP

cat > src/Core/Auth.php <<'PHP'
<?php
namespace App\Core;

/**
 * Simple session-based Auth with role support.
 */
class Auth
{
    public static function startSession(): void
    {
        if (session_status() === PHP_SESSION_ACTIVE) {
            return;
        }

        $secure   = (bool) config('security.secure_cookies', false);
        $sameSite = config('security.same_site', 'Lax');

        session_set_cookie_params([
            'secure'   => $secure,
            'httponly' => true,
            'samesite' => $sameSite,
        ]);

        session_start();
    }

    public static function login(int $id, string $email, string $role = 'user'): void
    {
        $_SESSION['user'] = [
            'id'    => $id,
            'email' => $email,
            'role'  => $role,
        ];
    }

    public static function user(): ?array
    {
        return $_SESSION['user'] ?? null;
    }

    public static function id(): ?int
    {
        return $_SESSION['user']['id'] ?? null;
    }

    public static function check(): bool
    {
        return isset($_SESSION['user']);
    }

    public static function isAdmin(): bool
    {
        return ($_SESSION['user']['role'] ?? null) === 'admin';
    }

    public static function logout(): void
    {
        unset($_SESSION['user']);
    }
}
PHP

cat > src/Middleware/CsrfMiddleware.php <<'PHP'
<?php
namespace App\Middleware;

use App\Core\Request;
use App\Core\Response;

/**
 * CSRF middleware integrating with helpers csrf_token() / csrf_field().
 */
class CsrfMiddleware
{
    protected static string $sessionKey = '_bastion_csrf';

    public static function handle(Request $req, callable $next): void
    {
        $enabled = (bool) config('security.csrf_enabled', true);

        if (!isset($_SESSION[self::$sessionKey])) {
            $_SESSION[self::$sessionKey] = bin2hex(random_bytes(32));
        }

        if (!$enabled) {
            $next($req);
            return;
        }

        $unsafe = in_array($req->method, ['POST', 'PUT', 'PATCH', 'DELETE'], true);
        if (!$unsafe) {
            $next($req);
            return;
        }

        $token = $req->body['_token'] ?? $req->headers['X-CSRF-TOKEN'] ?? null;
        $valid = is_string($token)
            && hash_equals($_SESSION[self::$sessionKey], $token);

        if (!$valid) {
            Response::abort(419, 'CSRF token mismatch');
        }

        $next($req);
    }

    public static function token(): string
    {
        if (!isset($_SESSION[self::$sessionKey])) {
            $_SESSION[self::$sessionKey] = bin2hex(random_bytes(32));
        }
        return $_SESSION[self::$sessionKey];
    }
}
PHP

cat > src/Middleware/SecurityHeaders.php <<'PHP'
<?php
namespace App\Middleware;

use App\Core\Request;

/**
 * SecurityHeaders
 *
 * Sets X-Frame-Options, X-Content-Type-Options, Referrer-Policy and
 * builds a CSP with nonce for inline <script nonce="..."> blocks.
 */
class SecurityHeaders
{
    public static function handle(Request $req, callable $next): void
    {
        $nonce = base64_encode(random_bytes(16));
        $req->cspNonce = $nonce;

        header('X-Frame-Options: SAMEORIGIN');
        header('X-Content-Type-Options: nosniff');
        header('Referrer-Policy: strict-origin-when-cross-origin');
        header('X-XSS-Protection: 1; mode=block');

        $sources = config('security.csp_script_src', ["'self'"]);
        $sources[] = "'nonce-$nonce'";
        $scriptSrc = implode(' ', array_unique($sources));

        $csp = "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src $scriptSrc; connect-src 'self';";
        header("Content-Security-Policy: $csp");

        $next($req);
    }
}
PHP
info "Creating Router & App core..."

cat > src/Core/Router.php <<'PHP'
<?php
namespace App\Core;

use App\Core\Request;
use App\Core\Response;
use App\Middleware\SecurityHeaders;
use App\Middleware\CsrfMiddleware;

/**
 * File-based router similar to Next.js + FastAPI.
 *
 * PAGES:
 *   /               → app/page.php
 *   /admin          → app/admin/page.php
 *   /admin/users    → app/admin/users/page.php
 *
 * API:
 *   /api/users      → app/api/users/+server.php
 *   /api/users/123  → app/api/users/[id]/+server.php  (req->path_param_id = 123)
 */
class Router
{
    protected function appBase(): string
    {
        if (defined('BASTION_BASE_PATH')) {
            return BASTION_BASE_PATH . '/app';
        }
        return dirname(__DIR__, 2) . '/app';
    }

    public function dispatch(Request $req): void
    {
        SecurityHeaders::handle($req, function (Request $req) {
            CsrfMiddleware::handle($req, function (Request $req) {
                if (str_starts_with($req->path, '/api/')) {
                    $this->dispatchApi($req);
                } else {
                    $this->dispatchPage($req);
                }
            });
        });
    }

    protected function dispatchApi(Request $req): void
    {
        $segments = explode('/', trim($req->path, '/')); // ["api","users","123"]
        array_shift($segments); // drop "api"

        $base = $this->appBase() . '/api';

        if (count($segments) === 1) {
            $file = $base . '/' . $segments[0] . '/+server.php';
        } else {
            $first  = $segments[0];
            $second = $segments[1] ?? null;

            if ($second !== null && ctype_digit($second)) {
                // /api/users/123 → app/api/users/[id]/+server.php
                $file = $base . '/' . $first . '/[id]/+server.php';
                $req->path_param_id = (int) $second;
            } else {
                $file = $base . '/' . implode('/', $segments) . '/+server.php';
            }
        }

        if (!isset($file) || !is_file($file)) {
            Response::abort(404, 'API endpoint not found');
        }

        /** @var array<string, callable> $handlers */
        $handlers = require $file;
        $method   = strtolower($req->method);

        if (!isset($handlers[$method])) {
            Response::abort(405, 'Method Not Allowed');
        }

        $handler = $handlers[$method];
        $handler($req);
    }

    protected function dispatchPage(Request $req): void
    {
        $base = $this->appBase();

        $path     = $req->path === '/' ? '/page.php' : $req->path . '/page.php';
        $viewFile = $base . $path;

        if (!is_file($viewFile)) {
            Response::abort(404, 'Page not found');
        }

        $rootLayout = $base . '/layout.php';
        $dir        = dirname($viewFile);
        $nested     = $dir . '/layout.php';
        $hasNested  = is_file($nested) && $nested !== $rootLayout;

        $request = $req;

        $content = function () use ($viewFile, $request) {
            $req = $request;
            require $viewFile;
        };

        if ($hasNested) {
            $inner   = $content;
            $nestedLayout = $nested;
            $content = function () use ($nestedLayout, $inner, $request) {
                $req = $request;
                $content = $inner;
                require $nestedLayout;
            };
        }

        require $rootLayout;
    }
}
PHP

cat > src/Core/App.php <<'PHP'
<?php
namespace App\Core;

class App
{
    public function run(): void
    {
        $req = new Request();
        $router = new Router();
        $router->dispatch($req);
    }
}
PHP

info "Creating public/index.php..."

cat > public/index.php <<'PHP'
<?php
// public/index.php – Front controller for Bastion PHP.
// All HTTP requests end up here when using:
//   php -S 127.0.0.1:8000 -t public public/index.php

if (!defined('BASTION_BASE_PATH')) {
    define('BASTION_BASE_PATH', dirname(__DIR__));
}

require BASTION_BASE_PATH . '/vendor/autoload.php';

use App\Core\Env;
use App\Core\Auth;
use App\Core\App;

// Load environment vars from .env
Env::load(BASTION_BASE_PATH);

// Start secure session for Auth + CSRF
Auth::startSession();

$app = new App();
$app->run();
PHP

#------------------------------------------------------------------------------
# LAYOUT & PAGES
#------------------------------------------------------------------------------

info "Creating root layout and base pages..."

cat > app/layout.php <<'PHP'
<?php

use App\Core\DV;

/** @var callable $content */
/**
 * Anatomy:
 *  - DV::get('title') – page-defined title
 *  - DV::get('show_sidebar') – flag to hide sidebar (e.g., on login)
 *  - DV::get('scripts') – array of external scripts per-page
 */
$title   = DV::get('title', config('app.name', 'Bastion'));
$sidebar = DV::get('show_sidebar', true);
$scripts = DV::get('scripts', []);
?>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title><?= e($title) ?></title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind v4 output -->
  <link rel="stylesheet" href="/css/app.css">
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
  <header class="border-b border-slate-800 bg-slate-900/80 px-4 py-3 sticky top-0 z-40 backdrop-blur">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <a href="/" class="flex items-center gap-2">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-blue-500/40 bg-blue-500/10 text-xs font-semibold text-blue-400">
          BP
        </span>
        <span class="flex flex-col">
          <span class="text-sm font-semibold"><?= e(config('app.name')) ?></span>
          <span class="text-[10px] text-slate-400">Secure internal tools in plain PHP</span>
        </span>
      </a>
      <nav class="flex items-center gap-4 text-xs text-slate-400">
        <a href="/" class="hover:text-blue-300">Docs Home</a>
        <a href="/admin" class="hover:text-blue-300">Admin</a>
        <?php if (!empty($_SESSION['user'])): ?>
          <span class="hidden sm:inline text-slate-500">
            <?= e($_SESSION['user']['email'] ?? '') ?>
          </span>
          <a href="/logout" class="hover:text-red-300">Logout</a>
        <?php else: ?>
          <a href="/login" class="hover:text-blue-300">Login</a>
        <?php endif; ?>
      </nav>
    </div>
  </header>

  <div class="max-w-6xl mx-auto px-4 py-6 flex gap-6">
    <?php if ($sidebar): ?>
      <aside class="hidden md:block w-64 shrink-0">
        <div class="sticky top-20 space-y-4 text-xs text-slate-300">
          <div>
            <p class="font-semibold text-slate-200 mb-2">Getting Started</p>
            <ul class="space-y-1">
              <li><a href="/" class="hover:text-blue-300">Introduction</a></li>
              <li><a href="#quickstart" class="hover:text-blue-300">Quick Start</a></li>
              <li><a href="#structure" class="hover:text-blue-300">Directory Structure</a></li>
            </ul>
          </div>
          <div>
            <p class="font-semibold text-slate-200 mb-2">Core Engine</p>
            <ul class="space-y-1">
              <li><a href="#routing" class="hover:text-blue-300">Routing</a></li>
              <li><a href="#dv-engine" class="hover:text-blue-300">DV Engine</a></li>
              <li><a href="#api" class="hover:text-blue-300">API & +server.php</a></li>
              <li><a href="#db" class="hover:text-blue-300">QueryBuilder</a></li>
            </ul>
          </div>
          <div>
            <p class="font-semibold text-slate-200 mb-2">Security & Tools</p>
            <ul class="space-y-1">
              <li><a href="#security" class="hover:text-blue-300">Security Policies</a></li>
              <li><a href="#helpers" class="hover:text-blue-300">Global Helpers</a></li>
              <li><a href="#cli" class="hover:text-blue-300">CLI Reference</a></li>
            </ul>
          </div>
        </div>
      </aside>
    <?php endif; ?>

    <main class="flex-1 min-w-0">
      <?php $content(); ?>

      <?php if ($scripts): ?>
        <?php foreach ($scripts as $src): ?>
          <script src="<?= e($src) ?>"></script>
        <?php endforeach; ?>
      <?php endif; ?>
    </main>
  </div>
</body>
</html>
PHP

cat > app/page.php <<'PHP'
<?php

use App\Core\DV;

// Quickstart-focused home, junior-friendly.
DV::set('title', 'Bastion PHP – Quick Start');
DV::set('breadcrumbs', [
    ['label' => 'Home', 'url' => '/'],
]);
?>

<section class="space-y-6">
  <header class="space-y-2">
    <p class="text-xs uppercase tracking-[0.2em] text-blue-400/80">Docs · v0.1.3</p>
    <h1 class="text-3xl sm:text-4xl font-bold">Bastion PHP – The Secure Internal Tools Framework</h1>
    <p class="text-sm text-slate-300 max-w-2xl">
      Bastion gives you Next.js routing, FastAPI-style endpoints, and a minimal ORM-like
      QueryBuilder – all in pure PHP. It is designed so a junior developer can ship features
      safely, while seniors can customize every layer.
    </p>
  </header>

  <section id="quickstart" class="space-y-3">
    <h2 class="text-2xl font-semibold">Quick Start</h2>
    <p class="text-sm text-slate-300">
      All you need is PHP 8.1+, Composer, Node.js and npm. The generator will build a full
      project including layouts, admin, login, API endpoints and Tailwind v4 integration.
    </p>
    <pre class="bg-slate-950/70 border border-slate-800 rounded-xl p-4 text-xs overflow-x-auto"><code># 1. Generate project
bash create-bastion-app MyInternalTool
cd MyInternalTool

# 2. Install PHP dependencies
composer install

# 3. Install Node dependencies (Tailwind v4 + BrowserSync)
npm install

# 4. Setup DB & default admin
./bastion migrate
./bastion seed

# 5. Start full dev stack
./bastion run-dev</code></pre>
    <p class="text-xs text-slate-400">
      Default admin credentials: <code>admin@example.com</code> / <code>password</code>.
    </p>
  </section>

  <section id="structure" class="space-y-3">
    <h2 class="text-2xl font-semibold">Directory Structure</h2>
    <p class="text-sm text-slate-300">
      Bastion organizes your app by <strong>features</strong> instead of file types.
      This matches how Next.js and other meta-frameworks think about routing.
    </p>
    <pre class="bg-slate-950/70 border border-slate-800 rounded-xl p-4 text-xs overflow-x-auto"><code>app/
  admin/               → admin routes (/admin)
  api/                 → API endpoints (/api/*, FastAPI style)
  components/          → UI fragments (PHP components)
  layout.php           → root layout wrapper
  page.php             → home page ("/")

config/
  app.php              → app name, env, debug, timezone
  database.php         → sqlite/mysql connection definitions
  security.php         → csrf, cookies, CSP sources

public/
  index.php            → front controller
  css/app.css          → Tailwind v4 compiled stylesheet

src/
  Core/                → Router, Request, Response, DV, DB, Auth, etc.
  Middleware/          → SecurityHeaders, CsrfMiddleware
  Models/              → domain models (User, etc.)

storage/
  db/app.db            → SQLite database (created after migrate)
  logs/app.log         → log file

resources/
  css/app.css          → Tailwind v4 input file
  js/                  → optional JS entrypoints</code></pre>
  </section>
</section>
PHP

# Login, logout, admin pages
cat > app/login/page.php <<'PHP'
<?php

use App\Core\DV;

DV::set('title', 'Login · Bastion');
DV::set('show_sidebar', false);
?>
<section class="max-w-md mx-auto mt-10 space-y-6">
  <h1 class="text-2xl font-bold">Sign in to Bastion</h1>
  <p class="text-sm text-slate-400">
    Use the seeded admin credentials on your first login:
    <code>admin@example.com</code> / <code>password</code>.
  </p>

  <form method="POST" action="/api/auth/login" class="space-y-4 bg-slate-900/60 border border-slate-800 rounded-xl p-4 text-sm">
    <?= csrf_field() ?>

    <div class="space-y-1">
      <label for="email" class="block text-slate-200">Email</label>
      <input id="email" type="email" name="email" required
             class="w-full rounded-md bg-slate-950 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-500/40">
    </div>

    <div class="space-y-1">
      <label for="password" class="block text-slate-200">Password</label>
      <input id="password" type="password" name="password" required
             class="w-full rounded-md bg-slate-950 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:ring focus:ring-blue-500/40">
    </div>

    <button type="submit"
            class="w-full rounded-md bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 text-sm">
      Sign in
    </button>
  </form>
</section>
PHP

cat > app/logout/page.php <<'PHP'
<?php

use App\Core\Auth;
use App\Core\Response;

Auth::logout();
Response::redirect('/');
PHP

cat > app/admin/layout.php <<'PHP'
<?php

use App\Core\DV;

/** @var callable $content */
DV::set('title', DV::get('title', 'Admin · Bastion'));
$crumbs = DV::get('breadcrumbs', [
    ['label' => 'Admin', 'url' => '/admin'],
]);
?>
<section class="space-y-6">
  <header class="flex items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold"><?= e(DV::get('title')) ?></h1>
      <nav class="mt-1 text-xs text-slate-400 flex flex-wrap gap-1">
        <?php foreach ($crumbs as $i => $c): ?>
          <?php if (!empty($c['url']) && empty($c['active'])): ?>
            <a href="<?= e($c['url']) ?>" class="hover:text-blue-300"><?= e($c['label']) ?></a>
          <?php else: ?>
            <span class="<?= !empty($c['active']) ? 'text-blue-300 font-semibold' : '' ?>">
              <?= e($c['label']) ?>
            </span>
          <?php endif; ?>
          <?php if ($i < count($crumbs) - 1): ?>
            <span>/</span>
          <?php endif; ?>
        <?php endforeach; ?>
      </nav>
    </div>
    <a href="/" class="text-xs text-blue-300 hover:text-blue-200">← Back to docs</a>
  </header>

  <div class="border border-slate-800 bg-slate-900/60 rounded-xl p-4">
    <?php $content(); ?>
  </div>
</section>
PHP

cat > app/admin/page.php <<'PHP'
<?php

use App\Core\DV;
use App\Core\Auth;
use App\Core\Response;
use App\Core\DB;

if (!Auth::check() || !Auth::isAdmin()) {
    Response::redirect('/login');
}

DV::set('title', 'Admin · Dashboard');
DV::set('breadcrumbs', [
    ['label' => 'Admin', 'url' => '/admin'],
    ['label' => 'Dashboard', 'active' => true],
]);

$users = DB::table('users')->orderBy('id', 'ASC')->limit(5)->get();
?>
<div class="space-y-4 text-sm">
  <p class="text-slate-300">
    You are logged in as
    <strong><?= e(Auth::user()['email'] ?? 'admin') ?></strong>.
  </p>

  <div class="space-y-2">
    <h2 class="font-semibold text-slate-200">Last 5 users</h2>
    <?php if ($users): ?>
      <ul class="space-y-1">
        <?php foreach ($users as $u): ?>
          <li class="flex justify-between border border-slate-800/70 bg-slate-950/50 rounded-md px-3 py-2">
            <span><?= e($u['email']) ?></span>
            <span class="text-xs text-slate-500">role: <?= e($u['role']) ?></span>
          </li>
        <?php endforeach; ?>
      </ul>
    <?php else: ?>
      <p class="text-xs text-slate-500">No users yet. Try running seeder.</p>
    <?php endif; ?>
  </div>
</div>
PHP

# API endpoints
info "Creating API endpoints..."

mkdir -p app/api/auth app/api/users app/api/users/[id] app/api/products

cat > app/api/auth/+server.php <<'PHP'
<?php

use App\Core\Request;
use App\Core\Response;
use App\Core\DB;
use App\Core\Auth;

/**
 * POST /api/auth/login
 * Body: email, password
 */
return [
    'post' => function (Request $req): void {
        $email    = $req->input('email');
        $password = $req->input('password');

        if (!$email || !$password) {
            Response::json(['error' => 'Missing credentials'], 422);
        }

        $user = DB::table('users')->where('email', $email)->first();
        if (!$user || !password_verify($password, $user['password'])) {
            Response::json(['error' => 'Invalid credentials'], 401);
        }

        Auth::login((int)$user['id'], $user['email'], $user['role'] ?? 'user');

        Response::json([
            'message' => 'Logged in',
            'user' => [
                'id'    => (int)$user['id'],
                'email' => $user['email'],
                'role'  => $user['role'] ?? 'user',
            ],
        ]);
    },
];
PHP

cat > app/api/users/+server.php <<'PHP'
<?php

use App\Core\Request;
use App\Core\Response;
use App\Core\DB;
use App\Core\Auth;

/**
 * Simple collection endpoint:
 *
 *   GET /api/users       → list users
 *   POST /api/users      → create basic user (email/password)
 */
return [
    'get' => function (Request $req): void {
        if (!Auth::check()) {
            Response::json(['error' => 'Unauthorized'], 401);
        }

        $users = DB::table('users')->orderBy('id', 'ASC')->get();
        Response::json(['data' => $users]);
    },

    'post' => function (Request $req): void {
        if (!Auth::check() || !Auth::isAdmin()) {
            Response::json(['error' => 'Forbidden'], 403);
        }

        $email    = (string) $req->input('email', '');
        $password = (string) $req->input('password', '');
        $role     = (string) $req->input('role', 'user');

        if ($email === '' || $password === '') {
            Response::json(['error' => 'email and password are required'], 422);
        }

        $id = DB::table('users')->insert([
            'email'    => $email,
            'password' => password_hash($password, PASSWORD_DEFAULT),
            'role'     => $role,
        ]);

        Response::json(['id' => $id], 201);
    },
];
PHP

cat > app/api/users/[id]/+server.php <<'PHP'
<?php

use App\Core\Request;
use App\Core\Response;
use App\Core\DB;
use App\Core\Auth;

/**
 * Dynamic route for /api/users/{id}
 *
 *   GET    → fetch user
 *   DELETE → delete user
 */
return [
    'get' => function (Request $req): void {
        if (!Auth::check()) {
            Response::json(['error' => 'Unauthorized'], 401);
        }

        $id = $req->path_param_id;
        $user = DB::table('users')->where('id', $id)->first();
        if (!$user) {
            Response::json(['error' => 'Not found'], 404);
        }

        Response::json(['data' => $user]);
    },

    'delete' => function (Request $req): void {
        if (!Auth::check() || !Auth::isAdmin()) {
            Response::json(['error' => 'Forbidden'], 403);
        }

        $id = $req->path_param_id;
        DB::table('users')->where('id', $id)->delete();

        Response::json(['success' => true]);
    },
];
PHP

cat > app/api/products/+server.php <<'PHP'
<?php

use App\Core\Request;
use App\Core\Response;

/**
 * Example external REST API proxy.
 *
 * Syntax: GET /api/products?limit=5
 *
 * Here we pretend to call some external service and return JSON from PHP.
 * In real life you would use curl or a HTTP client.
 */
return [
    'get' => function (Request $req): void {
        $limit = (int) $req->input('limit', 5);

        // Example: simulated products array (replace with real HTTP call).
        $data = [];
        for ($i = 1; $i <= $limit; $i++) {
            $data[] = [
                'id'   => $i,
                'name' => "Demo product #$i",
                'price' => 9.99 + $i,
            ];
        }

        Response::json(['data' => $data]);
    },
];
PHP
#==============================================================================
# 9. DATABASE MIGRATIONS & SEEDS
#==============================================================================

info "Creating migrations and seeders..."

cat > database/migrations/001_create_users.sql <<'SQL'
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT NOT NULL UNIQUE,
  password TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'admin',
  created_at INTEGER DEFAULT (strftime('%s','now'))
);
SQL

cat > database/seeds/001_seed_admin.php <<'PHP'
<?php

use App\Core\DB;

$existing = DB::table('users')->where('email', 'admin@example.com')->first();
if ($existing) {
    return;
}

DB::table('users')->insert([
    'email'    => 'admin@example.com',
    'password' => password_hash('password', PASSWORD_DEFAULT),
    'role'     => 'admin',
]);
PHP

#==============================================================================
# 10. TAILWIND V4 INPUT & PACKAGE.JSON
#==============================================================================

info "Creating Tailwind v4 input CSS..."

cat > resources/css/app.css <<'CSS'
@import "tailwindcss/preflight";
@import "tailwindcss/utilities";

/* Bastion specific components */
@layer components {
  .badge {
    @apply inline-flex items-center rounded-full border border-slate-700 px-2 py-0.5 text-[10px] uppercase tracking-[0.16em] text-slate-300;
  }

  .card {
    @apply border border-slate-800 bg-slate-900/60 rounded-xl p-4;
  }

  .btn {
    @apply inline-flex items-center justify-center rounded-md border border-slate-700 bg-slate-900 px-3 py-1.5 text-xs font-semibold text-slate-100 hover:bg-slate-800;
  }
}
CSS

info "Creating package.json..."

cat > package.json <<'JSON'
{
  "name": "bastion-app",
  "version": "0.1.3",
  "private": true,
  "scripts": {
    "dev": "npx @tailwindcss/cli -i ./resources/css/app.css -o ./public/css/app.css --watch",
    "build": "npx @tailwindcss/cli -i ./resources/css/app.css -o ./public/css/app.css --minify"
  },
  "devDependencies": {
    "@tailwindcss/cli": "latest",
    "browser-sync": "^3.0.0"
  }
}
JSON

#==============================================================================
# 11. BASTION CLI
#==============================================================================

info "Creating bastion CLI..."

cat > bastion <<'PHP'
#!/usr/bin/env php
<?php
/**
 * Bastion CLI v0.1.3
 */

if (!defined('BASTION_BASE_PATH')) {
    define('BASTION_BASE_PATH', __DIR__);
}

require __DIR__ . '/vendor/autoload.php';

use App\Core\DB;

$argv = $_SERVER['argv'] ?? [];
$cmd  = $argv[1] ?? null;

function bastion_help(): void {
    echo "Bastion CLI 0.1.3\n";
    echo "Commands:\n";
    echo "  run-dev     Start dev stack (Tailwind v4 watch + PHP :8000 + BrowserSync :9876)\n";
    echo "  migrate     Run all SQL migrations\n";
    echo "  seed        Run basic seeders\n";
    echo "  build       Build Tailwind v4 CSS to public/css/app.css\n";
    echo "\n";
}

function run_cmd(string $cmd): int {
    passthru($cmd, $exit);
    return (int)$exit;
}

if ($cmd === null) {
    bastion_help();
    exit(0);
}

switch ($cmd) {
    case 'run-dev':
        echo "Starting Bastion dev stack...\n";
        echo "  PHP backend : 127.0.0.1:8000\n";
        echo "  CSS dev     : Tailwind v4 watch (resources/css/app.css → public/css/app.css)\n";
        echo "  BrowserSync : 127.0.0.1:9876 (proxy)\n\n";

        if (stripos(PHP_OS_FAMILY, 'Windows') !== false) {
            echo "[windows] Please run the following in separate terminals:\n\n";
            echo "  npm run dev\n";
            echo "  php -S 127.0.0.1:8000 -t public public/index.php\n";
            echo "  npx browser-sync start --proxy \"127.0.0.1:8000\" --port 9876 --files \"app/**/*.php,src/**/*.php,public/**/*.css,public/**/*.js\"\n\n";
            exit(0);
        }

        @mkdir('public/css', 0777, true);

        $tw = 'npm run dev';
        $phpServer = PHP_BINARY . ' -S 127.0.0.1:8000 -t public public/index.php';
        $bs = 'npx browser-sync start --proxy "127.0.0.1:8000" --port 9876 --files "app/**/*.php,src/**/*.php,public/**/*.css,public/**/*.js"';

        $pid1 = pcntl_fork();
        if ($pid1 === 0) {
            exit(run_cmd($tw));
        }

        $pid2 = pcntl_fork();
        if ($pid2 === 0) {
            exit(run_cmd($phpServer));
        }

        $pid3 = pcntl_fork();
        if ($pid3 === 0) {
            exit(run_cmd($bs));
        }

        echo "Tailwind watch PID: $pid1\n";
        echo "PHP dev server PID: $pid2\n";
        echo "BrowserSync PID  : $pid3\n";

        pcntl_wait($status);
        break;

    case 'migrate':
        echo "Running migrations...\n";
        $pdo = DB::conn();

        $files = glob(__DIR__ . '/database/migrations/*.sql');
        sort($files);

        foreach ($files as $file) {
            $name = basename($file);
            echo "  > $name\n";
            $sql = file_get_contents($file);
            $pdo->exec($sql);
        }

        echo "Done.\n";
        break;

    case 'seed':
        echo "Running seeders...\n";
        $files = glob(__DIR__ . '/database/seeds/*.php');
        sort($files);

        foreach ($files as $file) {
            $name = basename($file);
            echo "  > $name\n";
            require $file;
        }

        echo "Done.\n";
        break;

    case 'build':
        echo "Building Tailwind CSS...\n";
        @mkdir('public/css', 0777, true);
        $exit = run_cmd('npm run build');
        if ($exit === 0) {
            echo "CSS built to public/css/app.css\n";
        }
        break;

    default:
        echo "Unknown command: $cmd\n";
        bastion_help();
        exit(1);
}
PHP

chmod +x bastion

#==============================================================================
# 12. REPORT.md
#==============================================================================

info "Creating REPORT.md..."

cat > REPORT.md <<REPORT
# Bastion PHP v0.1.3 – Generation Report

Generated at: $(date)
Project root: $PROJECT_ROOT

## Summary

- Routing: file-based (Next.js style) with nested layouts and +server.php
- API: FastAPI-style handlers (get/post/delete) in app/api
- DB: SQLite via PDO + QueryBuilder, MySQL ready via config
- Security: CSP nonces, CSRF middleware, cookie settings from config/security.php
- Auth: session-based login with role="admin|user"
- CSS: Tailwind v4 via CLI (npm run dev / npm run build)
- Dev: ./bastion run-dev → PHP :8000, Tailwind watch, BrowserSync :9876

## Approx. sizes (on generation)

- PHP src+app: ~$(find "$PROJECT_ROOT/src" "$PROJECT_ROOT/app" -type f -name '*.php' -print0 | wc -c | awk '{printf "%.1f",$1/1024}') KB
- Assets: ~$(find "$PROJECT_ROOT/public" -type f -name '*.css' -print0 | wc -c | awk '{printf "%.1f",$1/1024}') KB

## Next Steps

1. \`cd <?= basename("$PROJECT_ROOT") ?>\`
2. \`composer install\`
3. \`npm install\`
4. \`./bastion migrate\`
5. \`./bastion seed\`
6. \`./bastion run-dev\`

Open the BrowserSync URL (http://localhost:9876) in your browser.

REPORT

#==============================================================================
# DONE
#==============================================================================

success "Bastion PHP project generated in ./$PROJECT"
echo
echo "Next steps:"
echo "  cd $PROJECT"
echo "  composer install"
echo "  npm install"
echo "  ./bastion migrate"
echo "  ./bastion seed"
echo "  ./bastion run-dev"
echo
echo "Dev URLs:"
echo "  PHP backend : http://127.0.0.1:8000"
echo "  Proxy (BS)  : http://127.0.0.1:9876"