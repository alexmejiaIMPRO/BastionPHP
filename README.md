# Bastion PHP — README & Architectural Connections

This README explains how the pieces generated by `create-php-app.sh` are connected, how the installer and CLI integrate with the framework runtime, and the recommended workflows for local development and production deployment.

Read the full docu in `docu/` (generated):  
- `docu/01-getting-started.md` — quick start  
- `docu/02-guides.md` — common workflows and examples  
- `docu/03-config.md` — environment and config details  
- `docu/04-api.md` — API overview and core classes  
- `docu/REFERENCE.md` — exhaustive symbol reference  
- `docu/CHANGELOG.md`, `docu/CHEATSHEET.md` — changelog and cheatsheet

---

## High-level overview (how pieces connect)

- `create-php-app.sh`
  - Installer / project generator.
  - Scaffolds directory layout, writes `.env` (with generated `APP_KEY` and `JWT_SECRET`), creates `bastion` CLI, basic templates, composer/package manifests, migrations and seeders.
  - After generation you should have a working project ready for `./bastion migrate && ./bastion db:seed`.

- `bastion` (replaces `artisan`)
  - Primary developer CLI.
  - Commands: `run-dev`, `run-build`, `migrate`, `db:seed`, `serve`, `key:generate`.
  - Coordinates dev server, Tailwind builds, BrowserSync and migration/seeding operations.

- `public/index.php`
  - Front controller executed for every HTTP request.
  - Requires Composer autoload, runs `app/bootstrap.php`, instantiates `App` and `Request`.
  - Registers global middleware (SecurityHeaders, CSRF, Auth::loadUser).
  - Applies `AdminOnly` middleware conditionally for `/admin` paths.
  - Delegates routing and rendering to `App` and `Router`.

- `app/bootstrap.php`
  - Reads `.env` into environment (`putenv`, `$_ENV`).
  - Starts session with secure defaults (httponly, samesite= Lax, cookie_secure controlled by env).
  - Sets timezone and environment-specific PHP settings.

- `app/core/` — core runtime components
  - `Container.php` — tiny DI container used to bind singletons and resolve services.
  - `App.php` — application class, extends container, registers core services and runs middleware + router.
  - `Router.php` (scans `app/` directory) — file-based router, supports dynamic segments (`[param]`) and API `+server.php` endpoints.
  - `Request.php` — wraps incoming request, provides `input()`, `json()`, `isJson()`, `validate()` helpers.
  - `Response.php` — helper methods for JSON, HTML, redirect responses.
  - `DB.php` — returns PDO connection and exposes `QueryBuilder` for simple fluent queries.
  - `Auth.php` — JWT handling (issue, validate), refresh token storage and validation.
  - `CSRF.php` — token generator + middleware verification.
  - `Logger.php` — file logger (log levels controlled by `.env`).
  - `DV.php` — minimal view engine (rendering PHP templates from `resources/views/`).

- `app/middleware/`
  - `SecurityHeaders.php` — sets security headers and generates a CSP nonce per request (available via `$req->meta['csp_nonce']`).
  - `RateLimit.php` — in-memory limiter (development only).
  - `AdminOnly.php` — restricts admin-only routes.

- `app/models/`
  - `User.php` — user model with `find`, `findByEmail`, `all`, `create`, `update`, `delete`.
  - Models use `DB::pdo()` / `DB::table()` for database operations.

- `database/migrations/` & `database/seeds/`
  - Migrations create necessary tables (users, migrations, refresh_tokens).
  - `UserSeeder.php` seeds admin and demo accounts for convenience (change before production).

- `config/style.php` and Global Styling System
  - Controls Tailwind vs fallback CSS and Tailwind mode (`cdn` or `build`).
  - Layout auto-injects Tailwind or fallback CSS based on these settings — you do not manually include CSS in every page.

---

## Typical developer workflow

1. Generate project:
   ```bash
   bash create-php-app.sh my-app
   cd my-app
   ```

2. Install dependencies if needed:
   ```bash
   composer install
   npm install
   ```

3. Prepare DB and seed:
   ```bash
   ./bastion migrate
   ./bastion db:seed
   ```

4. Start dev environment:
   ```bash
   ./bastion run-dev     # PHP server, Tailwind watch, BrowserSync
   ```

5. Create a page:
   - `app/about/page.php` -> accessible at `/about`.

6. Add API endpoint:
   - `app/api/example/+server.php` with methods keyed by `get`, `post`, etc.

---

## Production deployment checklist

- Set secure env values in `.env`:
  - `APP_ENV=production`
  - `APP_DEBUG=false`
  - `APP_KEY` and `JWT_SECRET` must be unique, secure.
  - `SECURE_COOKIES=true`
  - Use `DB_CONNECTION=mysql` or `pgsql` with proper DB credentials.

- Build assets:
  ```bash
  ./bastion run-build
  ```

- Install optimized composer autoload:
  ```bash
  composer install --no-dev --optimize-autoloader
  ```

- Run migrations on production DB:
  ```bash
  ./bastion migrate
  ```

- Make sure web server points to `public/` and `public/.htaccess` or Nginx config denies access to `.env`.

- Set file permissions:
  ```bash
  chmod -R 755 storage
  chmod 664 storage/db/app.db || true
  chmod 644 .env
  ```

---

## Security notes & secrets management

- Do NOT commit `.env`.
- Always rotate `APP_KEY` and `JWT_SECRET` when cloning or before deploying.
- Refresh tokens: stored hashed in DB; refresh endpoints invalidate selectors after use.
- Set `SECURE_COOKIES=true` only when serving over HTTPS.
- Replace in-memory `RateLimit` with Redis or Memcached for multi-process production.

---

## Troubleshooting & quick checks

- If JWT features fail, verify `JWT_SECRET` exists:
  ```bash
  php -r "echo getenv('JWT_SECRET') ?: 'JWT_SECRET missing';"
  ```

- Check that `public/index.php` is reachable:
  ```bash
  curl -I http://localhost:9876/
  ```

- Verify built CSS:
  ```bash
  ls -la public/css/app.css
  ```

- Inspect logs:
  ```bash
  tail -n 200 storage/logs/app.log
  ```

---

## Contributing & customizations

- Add services to `app/Services/` and register in `App::registerCoreServices` or call `App::getInstance()->singleton(...)`.
- Add shared modules in a dedicated repo and copy into `app/` then run migrations.
- Replace `RateLimit` with a Redis-backed implementation for production.

---

## Where to find documentation

Full docu are generated under `docu/` and an HTML entrypoint `index.html` was created at the project root. Key docu:
- `docu/REFERENCE.md` — exhaustive file/class/function reference (machine-friendly).
- `docu/01-getting-started.md` & `docu/02-guides.md` — developer tutorials.

---

## License & support

- License: MIT (see repository root LICENSE if present).
- For issues or support, open an issue on the repository or contact the maintainers listed in repository metadata.

---

If you want, I can:
- Produce a one-page ASCII architecture diagram showing the runtime flow (Request → public/index.php → App → middleware → Router → +server.php/page.php → Response).
- Add example Nginx/Apache configuration files into `deploy/` for copy/paste.
- Replace `artisan` calls in CI/CD manifests with `./bastion` across the repo (create a compatibility shim or automated script).

```
