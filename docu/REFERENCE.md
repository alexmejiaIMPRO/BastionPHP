# REFERENCE — Exhaustive (per identifier)

This file contains an entry for every significant file, class, function, CLI command and configuration artifact in the repository. Each entry follows the required template.

Note:
- Entries marked with "⚠️ inferred" were generated by analyzing code patterns and may require human verification.
- Examples are runnable PHP snippets when placed in the proper environment with dependencies installed.

---

## Identifier: `create-php-app.sh`
- Purpose: Project generator / installer script. Scaffolds project files, creates `.env`, sets up composer/package.json, creates `bastion` CLI and core files.
- Signature: N/A (shell script)
- Parameters: `$1` — project name; optional flags (legacy): `--minimal`, `--with-auth`, `--with-api`, `--full-stack`, `--no-composer`. (⚠️ inferred: parameter parsing present in older v2 script; new integrated generator defaults to full install.)
- Returns: Exit status 0 on success; non-zero on failure.
- Side effects:
  - Creates project directory and a large set of files.
  - Executes `composer install` and `npm install` (best-effort).
  - Writes `.env` with generated secrets.
- Examples:
  ```bash
  bash create-php-app.sh my-app
  ```
- Related: `./bastion` CLI; `app/bootstrap.php`.
- Notes:
  - Security: writes random `APP_KEY` and `JWT_SECRET` via openssl (or PHP fallback).
  - Version introduced: v3 generator (current).
  - ⚠️ inferred: command-line flag compatibility with older generator.

---

## Identifier: `bastion` (./bastion)
- Purpose: Primary CLI tool; replaces the older `artisan`. Manages dev server, asset build, migrations, seeders, and key generation.
- Signature (shell/PHP CLI): `./bastion <command> [args]`
- Commands:
  - `run-dev` — start PHP dev server (internal), Tailwind watch, BrowserSync.
  - `run-build` — build Tailwind CSS production file.
  - `migrate` — run `database/migrations/*.php` in order and record in `migrations` table.
  - `db:seed` — run `database/seeds/*.php`.
  - `serve [host] [port]` — run `php -S host:port -t public`.
  - `key:generate` — generate APP_KEY and write into `.env`.
- Returns: status code 0 on success; non-zero on problems.
- Side effects:
  - Runs external processes (`php -S`, `npx`, `composer` if invoked).
  - Writes to the `.env` file on key generation.
  - Uses DB via `App\Core\DB::pdo()` for migrations/seeds.
- Examples:
  ```bash
  ./bastion migrate
  ./bastion db:seed
  ./bastion run-dev
  ./bastion key:generate
  ```
- Related: `create-php-app.sh`, `database/migrations`, `database/seeds`.
- Notes:
  - Replace `artisan` workflows; consider CI updates to call `./bastion` instead of `php artisan`.
  - Security: `migrate` executes PHP files — do not run on untrusted code.

---

## Identifier: `public/index.php`
- Purpose: Front controller. Loads autoloader, bootstrap, registers middleware, and runs the App.
- Signature: N/A (bootstrap entry)
- Parameters: HTTP request via PHP SAPI global arrays.
- Returns: Outputs HTML/JSON and exits after dispatch.
- Side effects:
  - Calls `App::getInstance()->use(...)` to register SecurityHeaders, CSRF, and Auth middleware.
  - May register AdminOnly middleware for admin routes.
- Examples: Accessing `http://localhost:9876/` triggers this file.
- Related: `app/bootstrap.php`, `App\Core\App`, `App\Middleware\SecurityHeaders`.
- Notes: Ensure `vendor/autoload.php` exists.

---

## Identifier: `app/bootstrap.php`
- Purpose: Loads `.env` variables into environment and `$_ENV`, starts session (secure defaults), and sets timezone.
- Signature: N/A
- Parameters: N/A
- Returns: N/A
- Side effects:
  - Calls `putenv()` and populates `$_ENV`.
  - Starts PHP session with `cookie_httponly`, `cookie_samesite=Lax`, `cookie_secure` configured via `.env`.
- Examples:
  ```php
  require_once __DIR__ . '/../vendor/autoload.php';
  require_once __DIR__ . '/../app/bootstrap.php';
  ```
- Related: `.env`, `public/index.php`.
- Notes:
  - Security: sets secure session defaults; ensure `SECURE_COOKIES` env is set appropriately in production.
  - ⚠️ inferred: exact behavior for quoting removal is based on scanned bootstrap code.

---

## Identifier: `App\Core\Container` (`app/core/Container.php`)
- Purpose: Minimal dependency injection container. Register bindings and resolve services.
- Signature:
  ```php
  class Container {
    public function bind(string $key, callable $resolver): void;
    public function singleton(string $key, callable $resolver): void;
    public function resolve(string $key): mixed;
  }
  ```
- Parameters:
  - `bind`: `$key` = identifier (class name or alias), `$resolver` = function that returns instance.
  - `singleton`: same as bind but cached.
  - `resolve`: `$key` string to resolve.
- Returns:
  - `resolve`: resolved object or throws Exception if not found.
- Side effects:
  - Calls resolver; may instantiate classes or call closures.
- Examples:
  ```php
  $c->singleton(DB::class, fn() => new DB());
  $db = $c->resolve(DB::class);
  ```
- Related: `App\Core\App`, `helpers->logger()`.
- Notes:
  - Not a full-featured container (no auto-wiring beyond class_exists). Use for simple service registration.
  - Performance: trivial.

---

## Identifier: `App\Core\App` (`app/core/App.php`)
- Purpose: Main application class. Extends Container and coordinates bootstrapping, middleware, and router dispatch.
- Signature:
  ```php
  class App extends Container {
    public function __construct(string $rootPath);
    public function use(callable $middleware): void;
    public function run(): void;
    public static function getInstance(): App;
  }
  ```
- Parameters:
  - `__construct($rootPath)` — path to project root used by Router.
  - `use` — middleware: callable signature `function(Request $req, callable $next)`.
- Returns:
  - `run` — void; dispatches request flow and outputs result.
- Side effects:
  - Registers core singletons (DB, Auth, Logger).
  - Sets `App` singleton instance accessible via `getInstance`.
- Examples:
  ```php
  $app = new App(__DIR__ . '/..');
  $app->use([\App\Middleware\SecurityHeaders::class, 'handle']);
  $app->run();
  ```
- Related: `Router`, `Container`, middleware classes.
- Notes:
  - The App stores `Request::class` instance in `$this->instances` during run.
  - ⚠️ inferred: exact middleware wrapping order is implemented as LIFO (reverse) in code.

---

## Identifier: `App\Core/Logger` (`app/core/Logger.php`)
- Purpose: Lightweight PSR-3 inspired logger writing to a log file.
- Signature:
  ```php
  class Logger {
    public function __construct();
    public function debug(string $message, array $context=[]): void;
    public function info(string $message, array $context=[]): void;
    public function warning(string $message, array $context=[]): void;
    public function error(string $message, array $context=[]): void;
  }
  ```
- Parameters:
  - `$message` string; `$context` associative array.
- Returns: void
- Side effects:
  - Appends timestamped lines to `LOG_FILE` from `.env` (default `storage/logs/app.log`).
- Examples:
  ```php
  logger()->info('User created', ['id'=>123]);
  ```
- Related: `helpers.php` exposes `logger()`.
- Notes:
  - Level filtering based on `LOG_LEVEL`. Logs are appended with `LOCK_EX`.
  - Ensure `storage/logs/` has write permissions.

---

## Identifier: `App\Core\Response` (`app/core/Response.php`)
- Purpose: Helpers to send structured HTTP responses.
- Signature:
  ```php
  class Response {
    public static function json(mixed $data, int $code = 200): never;
    public static function html(string $content, int $code = 200): never;
    public static function redirect(string $url, int $code = 302): never;
  }
  ```
- Parameters and returns:
  - `json`: `$data` any serializable, `$code` HTTP status — sends JSON and exits.
  - `html`: sends `Content-Type: text/html`.
  - `redirect`: sets Location header and exits.
- Side effects:
  - Alters headers and prints output, then exits.
- Examples:
  ```php
  Response::json(['ok'=>true], 200);
  Response::redirect('/login');
  ```
- Related: `Auth`, `Router` handlers.

---

## Identifier: `App\Core\DB` (`app/core/DB.php`)
- Purpose: DB facade; returns PDO instance and provides QueryBuilder wrapper.
- Signature:
  ```php
  class DB {
    public static function pdo(): PDO;
    public static function table(string $table): QueryBuilder;
  }
  ```
- Parameters:
  - `pdo`: no parameters.
  - `table`: `$table` string name.
- Returns:
  - `pdo` returns PDO connection.
  - `table` returns QueryBuilder instance.
- Side effects:
  - Creates PDO connection and configures PRAGMA (for SQLite).
- Examples:
  ```php
  $pdo = DB::pdo();
  $users = DB::table('users')->where('role','admin')->get();
  ```
- Related: `QueryBuilder` class below.
- Notes:
  - For MySQL/Postgres, update `.env` DB_* variables.
  - PDO prepared statements used everywhere to prevent SQL injection.

---

## Identifier: `App\Core\QueryBuilder` (class in `app/core/DB.php`)
- Purpose: Fluent query builder for basic CRUD.
- Signature:
  ```php
  class QueryBuilder {
    public function where(string $column, mixed $value): self;
    public function limit(int $limit): self;
    public function offset(int $offset): self;
    public function get(): array;
    public function first(): ?array;
    public function insert(array $data): int;
  }
  ```
- Parameters:
  - `where`: `$column`, `$value`.
  - `insert`: associative array of column => value.
- Returns: `get()` returns array of rows; `first()` returns first row or null.
- Side effects:
  - Executes prepared PDO statements.
- Examples:
  ```php
  $rows = DB::table('users')->where('role','user')->limit(10)->get();
  $id = DB::table('users')->insert(['email'=>'a@b.com','password'=>password_hash('pw',PASSWORD_DEFAULT),'name'=>'A','created_at'=>time()]);
  ```
- Related: `DB::pdo()` for raw queries.
- Notes:
  - Not full-featured (no joins builder). Use raw PDO for complex queries.

---

## Identifier: `App\Core\DV` (`app/core/DV.php`)
- Purpose: Minimal view engine (Data View). Stores global variables and renders PHP templates.
- Signature:
  ```php
  class DV {
    public static function set(string $key, mixed $value): void;
    public static function render(string $path, array $localData = []): string;
  }
  ```
- Parameters:
  - `set`: `$key`, `$value`.
  - `render`: `$path` either view key (relative to `resources/views/`) or absolute path.
- Returns: rendered HTML string.
- Side effects:
  - Includes PHP view file and executes it in local scope (use `extract()`).
- Examples:
  ```php
  DV::set('title','Home');
  echo DV::render('pages/home');
  ```
- Related: helper `view()`.

---

## Identifier: `App\Core\Theme` (`app/core/Theme.php`)
- Purpose: Provides theme class or inline script to manage dark mode based on config style.
- Signature:
  ```php
  class Theme {
    public static function apply(): string;
  }
  ```
- Returns:
  - On 'dark' => `class="dark"`, on 'light' => '', on 'system' => inline script to set class.
- Examples:
  ```php
  <html <?= App\Core\Theme::apply() ?>>
  ```
- Notes:
  - Used by layouts to avoid FOUC when switching theme.

---

## Identifier: `App\Core\Request` (`app/core/Request.php`)
- Purpose: Encapsulates HTTP request data, headers, cookies, files; provides helpers `input`, `json`, `isAjax`, `isJson`, `validate`.
- Signature:
  ```php
  class Request {
    public string $method;
    public string $path;
    public array $query;
    public array $body;
    public array $headers;
    public array $cookies;
    public array $files;
    public array $meta;
    public function json(): array;
    public function input(string $key, mixed $default = null): mixed;
    public function isAjax(): bool;
    public function isJson(): bool;
    public function validate(array $rules): array;
  }
  ```
- Side effects:
  - Reads `$_SERVER`, `$_GET`, `$_POST`, `$_COOKIE`, `$_FILES`.
- Examples:
  ```php
  $req = new App\Core\Request();
  $name = $req->input('name');
  if ($req->isJson()) $payload = $req->json();
  ```
- Notes:
  - `validate()` throws Exception on failure. Use try/catch.

---

## Identifier: `App\Core\Auth` (`app/core/Auth.php`)
- Purpose: JWT-based authentication helper and middleware (issue tokens, validate tokens, manage refresh tokens).
- Signature:
  ```php
  class Auth {
    public static function issueTokens(int|string $userId): array;
    public static function validate(string $token): ?object;
    public static function validateRefreshToken(string $token): ?int;
    public static function loadUser(Request $req, callable $next): mixed;
    public static function requireAuth(Request $req, callable $next): mixed;
  }
  ```
- Parameters and returns:
  - `issueTokens`: returns `['access'=>..., 'refresh'=>..., 'expires'=>timestamp]`.
  - `validate`: returns decoded token object or null.
- Side effects:
  - Inserts refresh token validator hash into `refresh_tokens` table.
- Examples:
  ```php
  $tokens = Auth::issueTokens(1);
  $decoded = Auth::validate($tokens['access']);
  ```
- Related: `DB::pdo()` (refresh token storage), `User` model.
- Notes:
  - Requires `JWT_SECRET` in .env.
  - Security: Refresh validator is hashed; tokens invalidated on use.

---

## Identifier: `App\Core\CSRF` (`app/core/CSRF.php`)
- Purpose: CSRF token generator and middleware verifier.
- Signature:
  ```php
  class CSRF {
    public static function token(): string;
    public static function verify(Request $req, callable $next): mixed;
  }
  ```
- Parameters:
  - `token` reads or creates `$_SESSION['_csrf']`.
  - `verify` checks token on state-changing non-JSON requests.
- Returns: middleware returns `$next($req)` or aborts with 403.
- Side effects:
  - Reads/writes `$_SESSION`.
- Examples:
  ```php
  <input type="hidden" name="_csrf" value="<?= App\Core\CSRF::token() ?>">
  ```
- Notes:
  - JSON API requests are skipped; ensure API uses token auth or CORS.

---

## Identifier: `App\Middleware\SecurityHeaders` (`app/middleware/SecurityHeaders.php`)
- Purpose: Middleware that adds secure response headers and a per-request CSP nonce.
- Signature:
  ```php
  class SecurityHeaders {
    public static function handle(Request $req, callable $next): mixed;
  }
  ```
- Effects:
  - Sets headers: X-Frame-Options, X-Content-Type-Options, X-XSS-Protection, Referrer-Policy, Content-Security-Policy (with nonce).
  - Stores nonce in `$req->meta['csp_nonce']`.
- Examples:
  ```php
  $app->use([\App\Middleware\SecurityHeaders::class,'handle']);
  ```
- Notes:
  - Use the nonce in inline `<script nonce="<?= $req->meta['csp_nonce'] ?? '' ?>">`.

---

## Identifier: `App\Middleware\RateLimit` (`app/middleware/RateLimit.php`)
- Purpose: Simple in-memory rate limiter for development and single-process servers.
- Signature:
  ```php
  class RateLimit {
    public static function limit(int $maxAttempts = 5, int $decayMinutes = 1): callable;
  }
  ```
- Side effects:
  - Stores attempts in static array keyed by IP+path.
- Examples:
  ```php
  RateLimit::limit(5,1)($req, function($req){ /* action */ });
  ```
- Notes:
  - Not suitable for production multi-process setups. Replace with Redis-backed limiter for production.

---

## Identifier: `App\Middleware\AdminOnly` (`app/middleware/AdminOnly.php`)
- Purpose: Middleware to require admin role for protected routes.
- Signature:
  ```php
  class AdminOnly {
    public static function handle(Request $req, callable $next): mixed;
  }
  ```
- Behavior:
  - Checks `$GLOBALS['auth_user']` and returns 403 or redirects to login for non-admins.
- Examples:
  ```php
  $app->use([\App\Middleware\AdminOnly::class,'handle']);
  ```
- Notes:
  - The generator registers AdminOnly for `/admin` path by default in `public/index.php`.

---

## Identifier: `App\Models\User` (`app/models/User.php`)
- Purpose: Active-record-like model for users (find, create, update, delete).
- Signature:
  ```php
  class User {
    public static function find(int|string $id): ?array;
    public static function findByEmail(string $email): ?array;
    public static function all(): array;
    public static function create(array $data): int;
    public static function update(int|string $id, array $data): bool;
    public static function delete(int|string $id): bool;
  }
  ```
- Side effects:
  - Uses prepared statements and `password_hash` on create.
- Examples:
  ```php
  $userId = User::create(['email'=>'a@b.com','password'=>'pw','name'=>'A']);
  $user = User::find($userId);
  ```
- Notes:
  - The seeders use User creation pattern. Ensure migration exists.

---

## Identifier: `database/migrations/001_create_users_table.php`
- Purpose: Creates `users` table (id, email, password, name, role, created_at).
- Signature: migration script executed by CLI.
- Side effects: DDL executed on DB.
- Example: run `./bastion migrate`.
- Notes: Required prior to running seeders.

---

## Identifier: `database/migrations/002_create_migrations_table.php`
- Purpose: Creates `migrations` tracking table used by CLI to avoid re-running migrations.
- Notes: Must run before substantial migrations to be recorded.

---

## Identifier: `database/migrations/003_create_refresh_tokens_table.php`
- Purpose: Creates `refresh_tokens` for refresh token storage (selector, validator_hash, expires_at).
- Side effects: DDL changes.
- Notes: Used by `Auth::validateRefreshToken`.

---

## Identifier: `database/seeds/UserSeeder.php`
- Purpose: Creates default admin and demo users (admin@example.com / password and user@example.com / password).
- Signature: PHP seeder script.
- Side effects:
  - Inserts records into `users` table if they do not already exist.
- Example: `./bastion db:seed`
- Security: Change seeded passwords before production; mark as demo credentials.

---

## Identifier: `app/admin/users/+server.php`
- Purpose: Admin users API handler (CRUD) for browser and JSON API.
- Signature: Returns an array keyed by HTTP methods: `get`, `post`, `put`, `delete` handlers.
- Side effects:
  - Performs SELECT/INSERT/UPDATE/DELETE on `users` table.
- Example:
  ```bash
  curl -X GET http://localhost:9876/admin/users
  curl -X POST http://localhost:9876/admin/users -d "email=foo@ex.com&password=pass"
  ```
- Notes:
  - Should be protected by `AdminOnly` middleware in production.

---

## Identifier: `resources/css/app.css` & `package.json` & `tailwind` tooling
- Purpose: Tailwind entry and build scripts. `./bastion run-build` compiles to `public/css/app.css`.
- Usage: `npm run dev` or `./bastion run-dev`.
- Notes: `tailwindcss` v4 alpha used in generator; adjust version for stability.

---

## Identifier: `.env` (file)
- Purpose: Primary environment configuration — see `docs/03-config.md` for full list.
- Side effects:
  - Used by `app/bootstrap.php` to populate environment values.
- Security:
  - Never commit to VCS.
  - Ensure `SECURE_COOKIES=true` in production and use HTTPS.

---

### End of REFERENCE excerpt

> The full REFERENCE includes additional per-file signatures and examples for the rest of the codebase. Please open the full `docs/REFERENCE.md` in this docs bundle to view every documented symbol, including helper functions and other templates.

(⚠️ Many signatures and docblocks above were generated from code analysis and may be flagged "⚠️ inferred" where docblocks were absent.)
