<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Bastion PHP 0.1.0 – Framework Documentation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind CSS CDN (for docs site only) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Small extra styles for scroll behavior -->
  <style>
    html, body { scroll-behavior: smooth; }
    pre, code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    details > summary::-webkit-details-marker { display: none; }
  </style>

  <!-- Docs JS (navigation, copy buttons, section highlight) -->
  <script src="main.js" defer></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">

<!-- ==================== TOP BAR ==================== -->
<header class="border-b border-slate-800 bg-slate-900/80 backdrop-blur sticky top-0 z-40">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
    <div class="h-9 w-9 rounded-xl bg-cyan-500/10 border border-cyan-400/50 flex items-center justify-center text-[0.7rem] font-bold tracking-[0.2em]">
      BP
    </div>
    <div class="flex-1">
      <h1 class="text-lg font-semibold flex items-center gap-2">
        Bastion PHP <span class="text-[0.7rem] px-2 py-[2px] rounded-full border border-slate-600 text-slate-300">v0.1.0</span>
      </h1>
      <p class="text-xs text-slate-400">
        Security-first PHP framework generator with file-based routing, DV engine and FastAPI-style endpoints.
      </p>
    </div>
    <div class="hidden sm:flex items-center gap-2">
      <a href="#quickstart" class="px-3 py-1 rounded-full text-xs font-medium bg-cyan-500 text-slate-950 hover:bg-cyan-400 transition">
        Quickstart
      </a>
      <a href="#advanced-senior" class="px-3 py-1 rounded-full text-xs border border-slate-700 text-slate-300 hover:border-cyan-400 hover:text-cyan-300 transition">
        For Senior Devs
      </a>
    </div>
  </div>
</header>

<!-- ==================== LAYOUT ==================== -->
<div class="max-w-6xl mx-auto px-4 py-6 flex gap-6">

  <!-- ========== SIDEBAR NAV ========== -->
  <aside class="hidden lg:block w-64 flex-shrink-0">
    <nav class="sticky top-[4.5rem] border border-slate-800 rounded-2xl bg-slate-900/80 backdrop-blur p-4 text-xs text-slate-400">
      <p class="uppercase tracking-[0.2em] text-slate-500 text-[0.65rem] mb-2">Docs Navigation</p>
      <ul class="space-y-1">
        <li><a href="#quickstart" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">0. Quickstart</a></li>
        <li><a href="#overview" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">1. Overview</a></li>
        <li><a href="#structure" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">2. Project Structure</a></li>
        <li><a href="#installation" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">3. Installation</a></li>
        <li><a href="#configuration" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">4. Configuration (3.x)</a></li>
        <li><a href="#title-system" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">5. Title System</a></li>
        <li><a href="#dv-engine" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">6. DV Engine</a></li>
        <li><a href="#routing" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">7. Filesystem Routing</a></li>
        <li><a href="#routing-wizard" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">8. Routing Wizard</a></li>
        <li><a href="#middleware" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">9. Middleware Pipeline</a></li>
        <li><a href="#database" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">10. Database &amp; QueryBuilder</a></li>
        <li><a href="#components" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">11. Components</a></li>
        <li><a href="#api-endpoints" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">12. REST API (+server.php)</a></li>
        <li><a href="#internal-api-dv" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">13. Internal API with DV</a></li>
        <li><a href="#php-rest-consume" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">14. REST from PHP</a></li>
        <li><a href="#auth-csrf" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">15. Auth &amp; CSRF</a></li>
        <li><a href="#cli" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">16. CLI &amp; Tailwind</a></li>
        <li><a href="#migrations-seeds" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">17. Migrations &amp; Seeds</a></li>
        <li><a href="#deployment" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">18. Deployment</a></li>
        <li><a href="#advanced-senior" class="doc-nav-link block px-2 py-1 rounded-lg hover:text-cyan-400">19. Advanced / Senior</a></li>
      </ul>
    </nav>
  </aside>

  <!-- ========== MAIN CONTENT ========== -->
  <main class="flex-1 space-y-12">

    <!-- ======================================================= -->
    <!-- 0. QUICKSTART (JUNIOR FRIENDLY)                         -->
    <!-- ======================================================= -->
    <section id="quickstart" class="doc-section space-y-6">
      <h2 class="text-3xl sm:text-4xl font-bold border-l-4 border-cyan-500 pl-3">
        0. Quickstart – from zero to “it works”
      </h2>

      <p class="text-sm sm:text-base text-slate-300">
        This section is designed for <strong>junior developers</strong> and engineers that just need
        a <strong>secure internal app running fast</strong> across plants.  
        You don’t need to know PHP in depth to follow it.
      </p>

      <ol class="list-decimal list-inside text-sm text-slate-300 space-y-1">
        <li>Clone the Bastion generator repository.</li>
        <li>Run the <code>create-bastion-app</code> script to generate a new project.</li>
        <li>Install PHP dependencies with Composer.</li>
        <li>Install Tailwind v4 + BrowserSync for the dev pipeline.</li>
        <li>Use the <code>bastion</code> CLI to run dev, migrate and seed.</li>
      </ol>

      <div class="doc-code" data-code-block>
        <div class="doc-code-header">
          <span>Terminal – generate a new Bastion project</span>
          <button type="button" class="copy-btn">Copy</button>
        </div>
<pre><code># 1) Clone the generator
git clone https://github.com/alexmejiaIMPRO/BastionPHP.git

# 2) Go into the generator repo
cd BastionPHP

# 3) Create a new app (folder "MyPlantApp")
bash create-bastion-app MyPlantApp

# 4) Move into the new app
cd MyPlantApp

# 5) Install PHP dependencies (once)
composer install

# 6) Install dev tooling for CSS & live reload (once)
npm install -D tailwindcss @tailwindcss/cli browser-sync

# 7) Run dev mode (PHP + Tailwind + BrowserSync :9876)
./bastion run-dev
</code></pre>
      </div>

      <details class="mt-2 text-xs text-slate-400 bg-slate-900/60 border border-slate-800 rounded-xl p-3">
        <summary class="cursor-pointer font-semibold text-cyan-300 text-xs">Syntax explanation – Quickstart commands</summary>
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li><code>git clone</code> downloads the repository from GitHub into your machine.</li>
          <li><code>bash create-bastion-app MyPlantApp</code> runs the generator and creates a project folder.</li>
          <li><code>composer install</code> installs PHP libraries used by the framework.</li>
          <li><code>npm install -D ...</code> installs Tailwind v4 CLI and BrowserSync for development only.</li>
          <li><code>./bastion run-dev</code> starts:
            <ul class="list-disc list-inside ml-4">
              <li>PHP dev server on <code>http://127.0.0.1:8000</code></li>
              <li>Tailwind watcher (rebuilds <code>public/css/app.css</code>)</li>
              <li>BrowserSync proxy on <code>http://127.0.0.1:9876</code> for auto-reload</li>
            </ul>
          </li>
        </ul>
      </details>
    </section>

    <!-- ======================================================= -->
    <!-- 1. OVERVIEW                                             -->
    <!-- ======================================================= -->
    <section id="overview" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">1. Overview</h2>
      <p class="text-sm sm:text-base text-slate-300">
        Bastion PHP is a <strong>framework generator + runtime</strong> focused on:
      </p>
      <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
        <li><strong>Security by default</strong>: CSP nonces, CSRF middleware, safe cookies, explicit escaping with <code>e()</code>.</li>
        <li><strong>Filesystem routing</strong> inspired by Next.js (layouts, pages, dynamic folders).</li>
        <li><strong>FastAPI-style endpoints</strong> using <code>+server.php</code> files that return method maps.</li>
        <li><strong>DV engine</strong> for sharing state between pages, layouts and internal APIs.</li>
        <li><strong>QueryBuilder</strong> wrapper around PDO for SQLite (and later, other drivers).</li>
        <li><strong>Minimal CLI</strong> for migrations, seeds, dev server and CSS builds.</li>
      </ul>
    </section>

    <!-- ======================================================= -->
    <!-- 2. PROJECT STRUCTURE                                    -->
    <!-- ======================================================= -->
    <section id="structure" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">2. Project Structure</h2>
      <p class="text-sm text-slate-300">
        The generator script creates an opinionated structure that makes routing, security and UI predictable:
      </p>

      <div class="doc-code" data-code-block>
        <div class="doc-code-header">
          <span>Generated tree (simplified)</span>
          <button type="button" class="copy-btn">Copy</button>
        </div>
<pre><code>MyPlantApp/
  app/
    layout.php                 # Root layout for all pages
    page.php                   # "/" route (home)
    login/
      page.php                 # "/login"
    admin/
      layout.php               # Layout for "/admin/*"
      page.php                 # "/admin"
      users/
        page.php               # "/admin/users"
    api/
      auth/
        +server.php            # "/api/auth/login", "/logout", "/refresh"
      users/
        +server.php            # "/api/users"
        [Id]/
          +server.php          # "/api/users/{Id}"
      products/
        +server.php            # "/api/products"
        [Id]/
          +server.php          # "/api/products/{Id}"
    components/
      UserCard.php             # Server-side UI component
      UserRow.php              # HTMX row component

  config/
    app.php                    # App name, env, debug
    database.php               # SQLite path, future drivers
    security.php               # CSRF, cookies, JWT, headers
    style.php                  # Theme + compiled CSS path

  database/
    migrations/                # SQL migrations
    seeds/                     # PHP seed files

  public/
    index.php                  # Front controller (router entrypoint)
    css/
      app.css                  # Tailwind v4 compiled CSS

  resources/
    css/
      app.css                  # Tailwind v4 source (@import "tailwindcss")

  storage/
    db/app.db                  # SQLite database file
    logs/app.log               # Log file

  bastion                      # CLI: run-dev, migrate, seed, build
</code></pre>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 3. INSTALLATION                                         -->
    <!-- ======================================================= -->
    <section id="installation" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">3. Installation</h2>

      <p class="text-sm text-slate-300">
        Requirements:
      </p>
      <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
        <li>PHP 8.1 or newer.</li>
        <li>SQLite (built-in with PHP usually is enough).</li>
        <li>Composer (PHP dependency manager).</li>
        <li>Node.js for Tailwind v4 CLI and BrowserSync (only required for dev and CSS build).</li>
      </ul>
    </section>

    <!-- ======================================================= -->
    <!-- 4. CONFIGURATION (3.x)                                  -->
    <!-- ======================================================= -->
    <section id="configuration" class="doc-section space-y-5">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">4. Configuration (3.x)</h2>

      <p class="text-sm text-slate-300">
        Bastion uses a simple <code>.env</code> + <code>config/*.php</code> configuration system.
        The generator creates sane defaults, but senior developers can customize everything.
      </p>

      <!-- .env -->
      <div class="space-y-2">
        <h3 class="text-xl font-semibold">4.1 <code>.env</code></h3>
        <div class="doc-code" data-code-block>
          <div class="doc-code-header">
            <span>.env (generated)</span>
            <button type="button" class="copy-btn">Copy</button>
          </div>
<pre><code>APP_NAME="Bastion PHP 0.1.0"
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost:8000
APP_KEY=base64:...

APP_TIMEZONE=America/Mexico_City
APP_THEME=dark

DB_CONNECTION=sqlite
DB_PATH=storage/db/app.db

JWT_SECRET=base64:...
JWT_TTL=3600
JWT_REFRESH_TTL=604800

CSRF_ENABLED=true
SECURE_COOKIES=false
SAME_SITE=Lax
</code></pre>
        </div>
        <details class="mt-2 text-xs text-slate-400 bg-slate-900/60 border border-slate-800 rounded-xl p-3">
          <summary class="cursor-pointer font-semibold text-cyan-300 text-xs">Syntax explanation – .env</summary>
          <ul class="list-disc list-inside space-y-1 mt-2">
            <li><code>APP_ENV</code> controls behavior (local vs production).</li>
            <li><code>APP_DEBUG</code> toggles verbose error output (never use <code>true</code> in production).</li>
            <li><code>DB_CONNECTION</code> is <code>sqlite</code> by default; later you can add other drivers.</li>
            <li><code>CSRF_ENABLED</code>, <code>SECURE_COOKIES</code>, <code>SAME_SITE</code> are used by the security config.</li>
          </ul>
        </details>
      </div>

      <!-- config/app.php -->
      <div class="space-y-2">
        <h3 class="text-xl font-semibold">4.2 <code>config/app.php</code></h3>
        <div class="doc-code" data-code-block>
          <div class="doc-code-header">
            <span>config/app.php</span>
            <button type="button" class="copy-btn">Copy</button>
          </div>
<pre><code>&lt;?php

return [
  'name'      =&gt; env('APP_NAME', 'Bastion App'),
  'env'       =&gt; env('APP_ENV', 'local'),
  'debug'     =&gt; (bool) env('APP_DEBUG', false),
  'url'       =&gt; env('APP_URL', 'http://localhost:8000'),
  'timezone'  =&gt; env('APP_TIMEZONE', 'UTC'),
  'locale'    =&gt; 'en',
];
</code></pre>
        </div>
      </div>

      <!-- config/style.php -->
      <div class="space-y-2">
        <h3 class="text-xl font-semibold">4.3 <code>config/style.php</code></h3>
        <div class="doc-code" data-code-block>
          <div class="doc-code-header">
            <span>config/style.php</span>
            <button type="button" class="copy-btn">Copy</button>
          </div>
<pre><code>&lt;?php

return [
  'theme'    =&gt; env('APP_THEME', 'dark'),
  'css_path' =&gt; '/css/app.css', // compiled Tailwind v4 bundle
];
</code></pre>
        </div>
      </div>

      <!-- config/security.php -->
      <div class="space-y-2">
        <h3 class="text-xl font-semibold">4.4 <code>config/security.php</code></h3>
        <div class="doc-code" data-code-block>
          <div class="doc-code-header">
            <span>config/security.php</span>
            <button type="button" class="copy-btn">Copy</button>
          </div>
<pre><code>&lt;?php

return [
  'csrf_enabled'      =&gt; (bool) env('CSRF_ENABLED', true),
  'secure_cookies'    =&gt; (bool) env('SECURE_COOKIES', false),
  'same_site'         =&gt; env('SAME_SITE', 'Lax'),
  'jwt_secret'        =&gt; env('JWT_SECRET', ''),
  'jwt_ttl'           =&gt; (int) env('JWT_TTL', 3600),
  'jwt_refresh_ttl'   =&gt; (int) env('JWT_REFRESH_TTL', 604800),
];
</code></pre>
        </div>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 5. TITLE SYSTEM                                         -->
    <!-- ======================================================= -->
    <section id="title-system" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">5. Title System</h2>

      <p class="text-sm text-slate-300">
        Bastion supports two patterns for setting the HTML <code>&lt;title&gt;</code>:
      </p>
      <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
        <li><strong>DV-based (recommended)</strong>: <code>DV::set('title', 'Admin · Users')</code>.</li>
        <li><strong>Global variable fallback</strong>: <code>$GLOBALS['title'] = 'Home'</code>.</li>
      </ul>

      <div class="doc-code" data-code-block>
        <div class="doc-code-header">
          <span>Title resolution in layout.php</span>
          <button type="button" class="copy-btn">Copy</button>
        </div>
<pre><code>&lt;?php
use App\Core\DV;

$title = DV::get('title', $GLOBALS['title'] ?? 'Bastion App');
?&gt;
&lt;title&gt;&lt;?= e($title) ?&gt;&lt;/title&gt;
</code></pre>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 6. DV ENGINE                                            -->
    <!-- ======================================================= -->
    <section id="dv-engine" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">6. DV Engine (Data View)</h2>

      <p class="text-sm text-slate-300">
        The DV engine is a static store for “view state”: titles, breadcrumbs, UI flags, or internal API data
        that should be shared between pages, layouts, and handlers.
      </p>

      <div class="doc-code" data-code-block>
        <div class="doc-code-header">
          <span>DV Engine usage</span>
          <button type="button" class="copy-btn">Copy</button>
        </div>
<pre><code>&lt;?php
// In app/admin/users/page.php
use App\Core\DV;

DV::set('title', 'Admin · Users');
DV::set('breadcrumbs', ['Admin', 'Users']);
DV::set('hideSidebar', false);

/**
 * In app/admin/layout.php:
 */
$title      = DV::get('title', 'Admin');
$crumbs     = DV::get('breadcrumbs', []);
$hideSidebar = DV::get('hideSidebar', false);
</code></pre>
      </div>

      <details class="mt-2 text-xs text-slate-400 bg-slate-900/60 border border-slate-800 rounded-xl p-3">
        <summary class="cursor-pointer font-semibold text-cyan-300 text-xs">Syntax explanation – DV</summary>
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li><code>DV::set(key, value)</code> stores values in memory for the current HTTP request.</li>
          <li><code>DV::get(key, fallback)</code> retrieves those values in any later point of the same request.</li>
          <li>Values can be scalars or arrays (e.g., breadcrumbs).</li>
        </ul>
      </details>
    </section>

    <!-- ======================================================= -->
    <!-- 7. FILESYSTEM ROUTING                                   -->
    <!-- ======================================================= -->
    <section id="routing" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">7. Filesystem Routing</h2>

      <p class="text-sm text-slate-300">
        Routing in Bastion is based on folders and file names inside <code>app/</code>:
      </p>
      <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
        <li><code>app/page.php</code> → route <code>/</code>.</li>
        <li><code>app/admin/page.php</code> → route <code>/admin</code>.</li>
        <li><code>app/admin/users/page.php</code> → route <code>/admin/users</code>.</li>
        <li><code>app/api/users/+server.php</code> → endpoint <code>/api/users</code>.</li>
        <li><code>app/api/products/[Id]/+server.php</code> → endpoint <code>/api/products/{Id}</code>.</li>
      </ul>
    </section>

    <!-- ======================================================= -->
    <!-- 8. ROUTING WIZARD                                       -->
    <!-- ======================================================= -->
    <section id="routing-wizard" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">8. Routing Wizard</h2>

      <p class="text-sm text-slate-300">
        Examples for how URLs map to files:
      </p>

      <div class="grid md:grid-cols-2 gap-4 text-xs text-slate-300">
        <div class="border border-slate-800 rounded-2xl p-3 bg-slate-900/40">
          <h3 class="font-semibold text-slate-100 mb-2">Page routes</h3>
          <ul class="space-y-1">
            <li><code>GET /</code> → <code>app/page.php</code> with <code>app/layout.php</code></li>
            <li><code>GET /admin</code> → <code>app/admin/page.php</code> + <code>app/admin/layout.php</code></li>
            <li><code>GET /admin/users</code> → <code>app/admin/users/page.php</code> + <code>app/admin/layout.php</code></li>
          </ul>
        </div>
        <div class="border border-slate-800 rounded-2xl p-3 bg-slate-900/40">
          <h3 class="font-semibold text-slate-100 mb-2">API routes</h3>
          <ul class="space-y-1">
            <li><code>GET /api/users</code> → <code>app/api/users/+server.php</code> (<code>'get'</code> handler)</li>
            <li><code>POST /api/users</code> → same file (<code>'post'</code> handler)</li>
            <li><code>GET /api/products/42</code> → <code>app/api/products/[Id]/+server.php</code></li>
          </ul>
        </div>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 9. MIDDLEWARE                                           -->
    <!-- ======================================================= -->
    <section id="middleware" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">9. Middleware Pipeline</h2>

      <p class="text-sm text-slate-300">
        Middlewares run before your route handler and enforce security and conventions:
      </p>
      <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
        <li><strong>SecurityHeaders</strong> – CSP nonce, X-Frame-Options, X-Content-Type-Options, etc.</li>
        <li><strong>CsrfMiddleware</strong> – blocks unsafe methods without valid CSRF token.</li>
        <li><strong>AuthMiddleware</strong> – attaches authenticated user (if present) to the request.</li>
        <li><strong>AdminOnly</strong> – blocks access to admin routes for non-admin users.</li>
      </ul>
    </section>

    <!-- ======================================================= -->
    <!-- 10. DATABASE & QUERYBUILDER                             -->
    <!-- ======================================================= -->
    <section id="database" class="doc-section space-y-5">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">10. Database &amp; QueryBuilder</h2>

      <p class="text-sm text-slate-300">
        Bastion wraps PDO in a simple QueryBuilder so that you can write readable CRUD code without giving up control.
      </p>

      <div class="doc-code" data-code-block>
        <div class="doc-code-header">
          <span>Basic CRUD with DB::table()</span>
          <button type="button" class="copy-btn">Copy</button>
        </div>
<pre><code>&lt;?php
use App\Core\DB;

// LIST: get last 10 users
$users = DB::table('users')
  -&gt;orderBy('id', 'DESC')
  -&gt;limit(10)
  -&gt;get();

// FIND: one user by email
$user = DB::table('users')
  -&gt;where('email', 'jane@example.com')
  -&gt;first();

// CREATE: insert new user
$id = DB::table('users')-&gt;insert([
  'email'      =&gt; 'new@plant.test',
  'password'   =&gt; password_hash('Password123', PASSWORD_BCRYPT),
  'role'       =&gt; 'inspector',
  'created_at' =&gt; time(),
]);

// UPDATE: promote to admin
DB::table('users')
  -&gt;where('id', $id)
  -&gt;update(['role' =&gt; 'admin']);

// DELETE: remove user
DB::table('users')
  -&gt;where('id', $id)
  -&gt;delete();
</code></pre>
      </div>

      <details class="mt-2 text-xs text-slate-400 bg-slate-900/60 border border-slate-800 rounded-xl p-3">
        <summary class="cursor-pointer font-semibold text-cyan-300 text-xs">Syntax explanation – QueryBuilder</summary>
        <ul class="list-disc list-inside space-y-1 mt-2">
          <li><code>DB::table('users')</code> starts a fluent chain that targets the <code>users</code> table.</li>
          <li><code>where()</code>, <code>orderBy()</code>, <code>limit()</code> add filters and sorting.</li>
          <li><code>get()</code> returns an array of rows; <code>first()</code> returns one row or <code>null</code>.</li>
          <li><code>insert()</code> returns the last inserted ID; <code>update()</code> and <code>delete()</code> return affected rows.</li>
        </ul>
      </details>
    </section>

    <!-- ======================================================= -->
    <!-- 11. COMPONENTS                                           -->
    <!-- ======================================================= -->
    <section id="components" class="doc-section space-y-5">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">11. Components</h2>

      <p class="text-sm text-slate-300">
        Components live in <code>app/components/</code> and are regular PHP functions that return HTML strings.
        All dynamic content must be escaped with <code>e()</code> before being rendered to avoid XSS.
      </p>

      <!-- UserCard -->
      <div class="space-y-2">
        <h3 class="text-xl font-semibold">11.1 Server-side UserCard</h3>
        <div class="doc-code" data-code-block>
          <div class="doc-code-header">
            <span>app/components/UserCard.php</span>
            <button type="button" class="copy-btn">Copy</button>
          </div>
<pre><code>&lt;?php
// FILE: app/components/UserCard.php
// PURPOSE: Reusable card for user info.

function UserCard(array $user): string {
  $id    = (int)($user['id'] ?? 0);
  $name  = e($user['name'] ?? '');
  $email = e($user['email'] ?? '');

  return "
  &lt;article class='p-4 rounded-xl border border-slate-800 bg-slate-900/40'&gt;
    &lt;h3 class='text-sm font-semibold'&gt;{$name}&lt;/h3&gt;
    &lt;p class='text-xs text-slate-400'&gt;{$email}&lt;/p&gt;
    &lt;p class='text-[10px] text-slate-500'&gt;ID: {$id}&lt;/p&gt;
  &lt;/article&gt;
  ";
}
</code></pre>
        </div>
      </div>

      <!-- UserRow (HTMX) -->
      <div class="space-y-2">
        <h3 class="text-xl font-semibold">11.2 HTMX-powered UserRow</h3>
        <div class="doc-code" data-code-block>
          <div class="doc-code-header">
            <span>app/components/UserRow.php</span>
            <button type="button" class="copy-btn">Copy</button>
          </div>
<pre><code>&lt;?php
// FILE: app/components/UserRow.php
// PURPOSE: Interactive &lt;tr&gt; row that can delete users via HTMX.

function UserRow(array $user): string {
  $id    = (int)($user['id'] ?? 0);
  $name  = e($user['name'] ?? '');
  $email = e($user['email'] ?? '');

  return "
  &lt;tr id='user-{$id}'&gt;
    &lt;td&gt;{$name}&lt;/td&gt;
    &lt;td&gt;{$email}&lt;/td&gt;
    &lt;td class='text-right'&gt;
      &lt;button
        hx-delete='/api/users/{$id}'
        hx-target='#user-{$id}'
        hx-swap='outerHTML'
        class='px-2 py-1 text-[11px] rounded border border-red-500/60 text-red-400 hover:bg-red-500/10'
      &gt;Delete&lt;/button&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
  ";
}
</code></pre>
        </div>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 12. REST API (+server.php)                              -->
    <!-- ======================================================= -->
    <section id="api-endpoints" class="doc-section space-y-5">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">12. REST API (+server.php)</h2>

      <p class="text-sm text-slate-300">
        API endpoints live in <code>app/api/**/+server.php</code>. Each file returns an array with HTTP methods as keys.
      </p>

      <!-- Users API -->
      <div class="space-y-2">
        <h3 class="text-xl font-semibold">12.1 <code>/api/users</code></h3>
        <div class="doc-code" data-code-block>
          <div class="doc-code-header">
            <span>app/api/users/+server.php</span>
            <button type="button" class="copy-btn">Copy</button>
          </div>
<pre><code>&lt;?php
use App\Core\DB;

return [

  // GET /api/users
  'get' =&gt; function ($req) {
    $limit = (int)($req-&gt;input('limit') ?? 20);

    $rows = DB::table('users')
      -&gt;orderBy('id', 'DESC')
      -&gt;limit($limit)
      -&gt;get();

    return res()-&gt;json([
      'success' =&gt; true,
      'count'   =&gt; count($rows),
      'data'    =&gt; $rows,
    ], 200);
  },

  // POST /api/users
  'post' =&gt; function ($req) {
    $data = $req-&gt;json();

    $email    = (string)($data['email'] ?? '');
    $password = (string)($data['password'] ?? '');

    $id = DB::table('users')-&gt;insert([
      'email'      =&gt; $email,
      'password'   =&gt; password_hash($password, PASSWORD_BCRYPT),
      'role'       =&gt; 'inspector',
      'created_at' =&gt; time(),
    ]);

    return res()-&gt;json([
      'success' =&gt; true,
      'id'      =&gt; $id,
    ], 201);
  },

];
</code></pre>
        </div>
      </div>

      <!-- Products API with dynamic Id -->
      <div class="space-y-2">
        <h3 class="text-xl font-semibold">12.2 Products API with dynamic <code>[Id]</code></h3>

        <div class="doc-code" data-code-block>
          <div class="doc-code-header">
            <span>app/api/products/+server.php</span>
            <button type="button" class="copy-btn">Copy</button>
          </div>
<pre><code>&lt;?php
// ROUTE: /api/products
use App\Core\DB;

return [
  'get' =&gt; function ($req) {
    $rows = DB::table('products')
      -&gt;orderBy('id','DESC')
      -&gt;limit(50)
      -&gt;get();

    return res()-&gt;json([
      'success' =&gt; true,
      'data'    =&gt; $rows,
    ]);
  },
];
</code></pre>
        </div>

        <div class="doc-code" data-code-block>
          <div class="doc-code-header">
            <span>app/api/products/[Id]/+server.php</span>
            <button type="button" class="copy-btn">Copy</button>
          </div>
<pre><code>&lt;?php
// ROUTE: /api/products/{Id}
use App\Core\DB;

return [
  'get' =&gt; function ($req, array $params) {
    $id = (int)($params['Id'] ?? 0);

    $product = DB::table('products')
      -&gt;where('id', $id)
      -&gt;first();

    if (! $product) {
      return res()-&gt;json(['error' =&gt; 'Not found'], 404);
    }

    return res()-&gt;json([
      'success' =&gt; true,
      'data'    =&gt; $product,
    ]);
  },
];
</code></pre>
        </div>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 13. INTERNAL API WITH DV                                -->
    <!-- ======================================================= -->
    <section id="internal-api-dv" class="doc-section space-y-5">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">13. Internal API with DV</h2>

      <p class="text-sm text-slate-300">
        Instead of calling REST endpoints with <code>file_get_contents()</code> from pages, you can preload data into DV
        from a <code>+server.php</code> and then consume it in <code>page.php</code>.
      </p>

      <div class="grid md:grid-cols-2 gap-4">
        <!-- Internal API -->
        <div class="space-y-2">
          <h3 class="text-lg font-semibold">13.1 Internal admin users API</h3>
          <div class="doc-code" data-code-block>
            <div class="doc-code-header">
              <span>app/api/admin/users/+server.php</span>
              <button type="button" class="copy-btn">Copy</button>
            </div>
<pre><code>&lt;?php
use App\Core\DB;
use App\Core\DV;

return [
  'get' =&gt; function ($req) {
    $rows = DB::table('users')
      -&gt;orderBy('id','DESC')
      -&gt;limit(50)
      -&gt;get();

    // Preload into DV for HTML rendering
    DV::set('admin_users', $rows);

    return res()-&gt;json([
      'success' =&gt; true,
      'count'   =&gt; count($rows),
    ], 200);
  },
];
</code></pre>
          </div>
        </div>

        <!-- Page consuming DV -->
        <div class="space-y-2">
          <h3 class="text-lg font-semibold">13.2 Admin users page using DV</h3>
          <div class="doc-code" data-code-block>
            <div class="doc-code-header">
              <span>app/admin/users/page.php</span>
              <button type="button" class="copy-btn">Copy</button>
            </div>
<pre><code>&lt;?php
use App\Core\DV;

DV::set('title', 'Admin · Users');

// Get data that might have been set by /api/admin/users
$users = DV::get('admin_users', []);
?&gt;

&lt;section class="space-y-2"&gt;
  &lt;h1 class="text-2xl font-bold"&gt;Admin Users&lt;/h1&gt;

  &lt;?php if (empty($users)): ?&gt;
    &lt;p class="text-sm text-slate-500"&gt;No users loaded yet.&lt;/p&gt;
  &lt;?php else: ?&gt;
    &lt;ul class="text-xs text-slate-300 space-y-1"&gt;
      &lt;?php foreach ($users as $u): ?&gt;
        &lt;li&gt;
          #&lt;?= e((string)($u['id'] ?? '')) ?&gt;
          &amp;mdash;
          &lt;?= e($u['email'] ?? '') ?&gt;
        &lt;/li&gt;
      &lt;?php endforeach; ?&gt;
    &lt;/ul&gt;
  &lt;?php endif; ?&gt;
&lt;/section&gt;
</code></pre>
          </div>
        </div>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 14. REST FROM PHP (EXTERNAL)                            -->
    <!-- ======================================================= -->
    <section id="php-rest-consume" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">14. REST from PHP (external APIs)</h2>

      <p class="text-sm text-slate-300">
        You can consume external REST APIs directly from <code>page.php</code> using <code>file_get_contents()</code> or any HTTP client.
      </p>

      <div class="doc-code" data-code-block>
        <div class="doc-code-header">
          <span>app/admin/products/page.php – consuming an external REST API</span>
          <button type="button" class="copy-btn">Copy</button>
        </div>
<pre><code>&lt;?php
use App\Core\DV;

DV::set('title', 'Admin · Products (External API)');

// 1. Call an external REST API
$json = @file_get_contents('https://api.example.com/products?limit=5');
$data = $json ? json_decode($json, true) : null;

$products = $data['data'] ?? [];
?&gt;

&lt;section class="space-y-3"&gt;
  &lt;h1 class="text-2xl font-bold"&gt;Latest Products (external)&lt;/h1&gt;

  &lt;?php if (empty($products)): ?&gt;
    &lt;p class="text-xs text-slate-500"&gt;No products received from remote API.&lt;/p&gt;
  &lt;?php else: ?&gt;
    &lt;ul class="text-xs text-slate-300 space-y-1"&gt;
      &lt;?php foreach ($products as $p): ?&gt;
        &lt;li&gt;
          #&lt;?= e((string)($p['id'] ?? '')) ?&gt;
          &amp;mdash;
          &lt;?= e($p['name'] ?? '') ?&gt;
        &lt;/li&gt;
      &lt;?php endforeach; ?&gt;
    &lt;/ul&gt;
  &lt;?php endif; ?&gt;
&lt;/section&gt;
</code></pre>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 15. AUTH & CSRF                                         -->
    <!-- ======================================================= -->
    <section id="auth-csrf" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">15. Auth &amp; CSRF</h2>

      <p class="text-sm text-slate-300">
        Bastion includes CSRF protection out of the box. Use <code>csrf_field()</code> in forms and the middleware will validate tokens.
      </p>

      <div class="doc-code" data-code-block>
        <div class="doc-code-header">
          <span>app/login/page.php – Login form (CSRF-safe)</span>
          <button type="button" class="copy-btn">Copy</button>
        </div>
<pre><code>&lt;?php
use App\Core\DV;
DV::set('title', 'Login');
?&gt;

&lt;section class="max-w-sm mx-auto space-y-4"&gt;
  &lt;h1 class="text-xl font-semibold"&gt;Sign in&lt;/h1&gt;

  &lt;form method="post" action="/api/auth/login" class="space-y-3"&gt;
    &lt;?= csrf_field() ?&gt;

    &lt;div class="space-y-1"&gt;
      &lt;label class="text-xs text-slate-300"&gt;Email&lt;/label&gt;
      &lt;input type="email" name="email" required
             class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1 text-xs"&gt;
    &lt;/div&gt;

    &lt;div class="space-y-1"&gt;
      &lt;label class="text-xs text-slate-300"&gt;Password&lt;/label&gt;
      &lt;input type="password" name="password" required
             class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1 text-xs"&gt;
    &lt;/div&gt;

    &lt;button type="submit"
            class="inline-flex items-center justify-center px-3 py-1.5 rounded bg-cyan-500 text-xs font-semibold
                   text-slate-950 hover:bg-cyan-400"&gt;
      Sign in
    &lt;/button&gt;
  &lt;/form&gt;
&lt;/section&gt;
</code></pre>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 16. CLI & TAILWIND                                      -->
    <!-- ======================================================= -->
    <section id="cli" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">16. CLI &amp; Tailwind</h2>

      <p class="text-sm text-slate-300">
        The <code>bastion</code> CLI orchestrates dev server, migrations, seeds and Tailwind v4 builds.
      </p>

      <div class="doc-code" data-code-block>
        <div class="doc-code-header">
          <span>Common CLI commands</span>
          <button type="button" class="copy-btn">Copy</button>
        </div>
<pre><code># Start dev mode (PHP + Tailwind watch + BrowserSync 9876)
./bastion run-dev

# Run migrations (database/migrations/*.sql)
./bastion migrate

# Run seeders (database/seeds/*.php)
./bastion seed

# Build Tailwind v4 CSS bundle (resources/css/app.css → public/css/app.css)
./bastion build
</code></pre>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 17. MIGRATIONS & SEEDS                                  -->
    <!-- ======================================================= -->
    <section id="migrations-seeds" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">17. Migrations &amp; Seeds</h2>

      <p class="text-sm text-slate-300">
        Migrations are plain SQL files; seeds are PHP files that call the DB layer or models to populate data.
      </p>

      <div class="doc-code" data-code-block>
        <div class="doc-code-header">
          <span>database/migrations/001_create_users.sql</span>
          <button type="button" class="copy-btn">Copy</button>
        </div>
<pre><code>CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  email TEXT NOT NULL UNIQUE,
  password TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'inspector',
  created_at INTEGER NOT NULL
);</code></pre>
      </div>
    </section>

    <!-- ======================================================= -->
    <!-- 18. DEPLOYMENT                                           -->
    <!-- ======================================================= -->
    <section id="deployment" class="doc-section space-y-4">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">18. Deployment</h2>

      <p class="text-sm text-slate-300">
        For production:
      </p>
      <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
        <li>Run <code>./bastion build</code> so <code>public/css/app.css</code> is minified.</li>
        <li>Disable debug: <code>APP_ENV=production</code>, <code>APP_DEBUG=false</code>.</li>
        <li>Serve <code>public/</code> with Nginx/Apache pointing to <code>public/index.php</code>.</li>
        <li>Ensure <code>storage/</code> is writable by the web server for logs and database.</li>
      </ul>
    </section>

    <!-- ======================================================= -->
    <!-- 19. ADVANCED / SENIOR                                   -->
    <!-- ======================================================= -->
    <section id="advanced-senior" class="doc-section space-y-4 pb-10">
      <h2 class="text-3xl font-bold border-l-4 border-slate-600 pl-3">19. Advanced – For Senior Developers</h2>

      <p class="text-sm text-slate-300">
        Senior engineers can:
      </p>
      <ul class="list-disc list-inside text-sm text-slate-300 space-y-1">
        <li>Extend <code>config/database.php</code> to support other drivers beside SQLite.</li>
        <li>Customize security defaults in <code>config/security.php</code> (cookies, JWT rotation, SameSite modes).</li>
        <li>Implement additional middlewares (rate limiting, audit logging, multi-tenant filters).</li>
        <li>Replace HTMX components with full SPAs while keeping the same REST surface.</li>
        <li>Use the DV engine for cross-cutting layout features (dynamic breadcrumbs, multi-brand theming, etc.).</li>
      </ul>
    </section>

  </main>
</div>

</body>
</html>