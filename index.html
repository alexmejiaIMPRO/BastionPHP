<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <!-- ========================================================= -->
  <!--                      FRAMEWORK DOC TITLE                  -->
  <!-- ========================================================= -->
  <!-- Static because this is the documentation website, NOT a generated Bastion app page -->
  <title>Bastion PHP 0.1.0 – Developer Documentation</title>

  <!-- Viewport for responsive UI -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind active via CDN for responsive documentation -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Smooth scrolling across the docs */
    html, body { scroll-behavior: smooth; }

    /* Monospace type for code blocks */
    pre, code { font-family: ui-monospace, monospace; }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen leading-relaxed">

<!-- ========================================================= -->
<!--                        DOCS HEADER                      -->
<!-- ========================================================= -->
<header class="border-b border-slate-800 bg-slate-900/80 px-4 py-3 sticky top-0 z-50 backdrop-blur">
  <div class="max-w-6xl mx-auto flex items-center gap-3">

    <!-- Framework branding badge -->
    <div class="h-10 w-10 flex items-center justify-center bg-cyan-500/10 border border-cyan-500/40 rounded-lg text-cyan-300 text-xs font-bold">
      BP
    </div>

    <!-- Header text -->
    <div>
      <h1 class="text-xl font-bold">Bastion PHP <span class="text-xs font-normal text-slate-400">v0.1.0</span></h1>
      <p class="text-xs text-slate-400">Ultra Secure · File Routed · Zero-Magic PHP Framework</p>
    </div>
  </div>
</header>

<!-- ========================================================= -->
<!--                       DOCUMENTATION MAIN                  -->
<!-- ========================================================= -->
<main class="max-w-6xl mx-auto px-4 py-8 space-y-24">

<!-- ========================================================= -->
<!-- 1. OVERVIEW SECTION                                      -->
<!-- ========================================================= -->
<section id="overview" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-cyan-400 pl-3">1. Framework Overview</h2>

  <!-- Human-friendly explanation -->
  <p class="text-base text-slate-300">
    BastionPHP is a <strong>company-focused PHP framework produced by a generator script</strong>, designed for building
    internal tooling that is:
  </p>

  <ul class="list-disc list-inside text-lg text-slate-400">
    <li>✔ Extremely secure (CSP, CSRF, HttpOnly, SameSite cookies)</li>
    <li>✔ Fast to develop and deploy</li>
    <li>✔ Zero "magic" – Everything is explicit</li>
    <li>✔ No frontend frameworks required</li>
  </ul>

  <p class="text-sm text-slate-500">
    The framework intentionally <strong>imitates the ergonomics</strong> of inspiring systems like:
    Next.js (routing), Django (models/admin feel), FastAPI (method-map endpoints).
  </p>

  <div class="bg-slate-900/20 border border-slate-800 rounded-xl p-4 text-xs sm:text-sm text-slate-300">
    <strong>Core Architecture Principles:</strong>
    <ul class="list-disc list-inside text-slate-400 mt-2 space-y-1">
      <li>Filesystem routing like Next.js</li>
      <li>Middleware pipeline executed before routing</li>
      <li>No templating engines, no hidden globals</li>
      <li>SQL is never abstracted away</li>
      <li>Reusable components are PHP functions</li>
      <li>Shared UI state is stored in the Data View Engine (DV::class)</li>
    </ul>
  </div>
</section>

<!-- ========================================================= -->
<!-- 2. ENVIRONMENT VARIABLES & CONFIGURATION                  -->
<!-- ========================================================= -->
<section id="env-config">
  <h2 class="text-4xl font-bold border-l-4 border-yellow-400 pl-3 mb-6">2. Environment Variables & Configuration</h2>

  <p class="text-lg text-slate-300">
    BastionPHP applications load configuration from 4 main sources at boot:
  </p>

  <ul class="list-decimal list-inside text-lg text-slate-400 mb-4">
    <li><strong>.env file</strong> → stores secrets, toggles, and driver paths</li>
    <li><strong>config/app.php</strong> → core app settings</li>
    <li><strong>config/security.php</strong> → CSRF/JWT/CSP rules</li>
    <li><strong>config/style.php</strong> → UI flags (dark mode, CDN mode, navbar, etc)</li>
  </ul>

  <p class="text-sm text-slate-500">
    Bastion <strong>never deletes or disables security by flags</strong>. Every app generated already contains all protection by default.
  </p>

  <!-- ENV FILE -->
  <h3 class="text-2xl font-bold text-cyan-300 mt-8 mb-2">Example: <code>.env</code> file</h3>
  <pre class="bg-black/80 border border-slate-900 rounded-xl p-4 text-xs overflow-auto">
# =========================================================
#            CORE ENVIRONMENT SETTINGS
# =========================================================
APP_ENV=development          # can be: development, production
APP_DEBUG=true              # enables detailed error output
APP_KEY=base64:GENERATEDKEY  # application encryption seed
TIMEZONE=UTC-6              # used for logs and sessions

# =========================================================
#            SQLITE DATABASE SETTINGS (default)
# =========================================================
DB_DRIVER=sqlite             # WAL enabled for concurrency
DB_PATH=storage/db/app.db

# =========================================================
#            JWT AUTH SETTINGS
# =========================================================
JWT_SECRET=GENERATEDJWTSECRET
JWT_TTL=900                # 900 seconds = 15 minutes
JWT_REFRESH_TTL=604800     # 7 days refresh validity

# =========================================================
#            COOKIE SECURITY
# =========================================================
SAME_SITE=lax              # recommended: lax or strict
HTTP_ONLY=true             # prevents JavaScript access to cookies
SECURE_COOKIE=true         # only via HTTPS in production
  </pre>

  <!-- CONFIG FILES -->
  <h3 class="text-2xl font-bold text-slate-200 mt-12 mb-6 border-b border-slate-800 pb-2">Configuration Files</h3>

  <!-- app.php -->
  <h4 class="text-xl font-bold text-indigo-400 mb-2">config/app.php</h4>
  <pre class="bg-black/80 border border-slate-900 rounded-xl p-4 text-xs overflow-x-auto">
&lt;?php
// =========================================================
// FILE PURPOSE:
//   - Basic application identity and behavior settings
//   - Influenced by ENV values but NOT a source of secrets
// =========================================================

return [
    'app_name'    =&gt; 'Bastion Internal Dashboard',
    // Reads variable from ENV using `env()` helper, fallback to default if missing
    'environment' =&gt; env('APP_ENV', 'production'),
    'debug_mode'  =&gt; env('APP_DEBUG', false),
    // Uses server timezone for consistent log timestamps
    'timezone'    =&gt; env('TIMEZONE', 'UTC'),
];
?&gt;
  </pre>

  <!-- security.php -->
  <h4 class="text-xl font-bold text-red-400 mb-2 mt-8">config/security.php</h4>
  <pre class="bg-black/80 border border-slate-900 rounded-xl p-4 text-xs overflow-x-auto">
&lt;?php
// =========================================================
// FILE PURPOSE:
//   - Controls backend protection behavior
//   - Security is always ON, these flags tune behavior only
// =========================================================

return [
  'JWT_SIGNING_KEY'   =&gt; env('JWT_SECRET'),
  'JWT_ACCESS_EXPIRY' =&gt; (int)env('JWT_TTL', 900),

  // CSRF protection toggle
  'ENABLE_CSRF' =&gt; (bool) env('CSRF_ENABLED', true),

  // Cookie Security
  'COOKIE_OPTIONS' =&gt; [
      'SameSite' =&gt; env('SAME_SITE', 'lax'),
      'HttpOnly' =&gt; true,
      'Secure'   =&gt; env('APP_ENV') === 'production'
  ],

  // CSP header config (URI for violation reports)
  'CSP_REPORT_URI' =&gt; '/api/csp-report',
];
?&gt;
  </pre>

  <!-- style.php -->
  <h4 class="text-xl font-bold text-emerald-400 mb-2 mt-8">config/style.php</h4>
  <pre class="bg-black/80 border border-slate-900 rounded-xl p-6 text-xs overflow-x-auto">
&lt;?php
// =========================================================
// FILE PURPOSE:
//   - Controls style behavior for the frontend
//   - THIS DOC PAGE uses Tailwind CDN, generated apps compile locally
// =========================================================

return [
  // Recommended UI theme for generated apps
  'theme' =&gt; 'dark',

  // Default frontend styles shipped with scaffold
  'use_tailwind' =&gt; true,

  // Layout configuration flags so each layout nested can behave correctly
  'layout' =&gt; [
      'navbar_fixed' =&gt; true,   // navbar should stay visible when scrolling
      'sidebar'     =&gt; true,   // sidebar enabled by default for dashboard UX
      'container_padding' =&gt; 'p-4 sm:p-6 lg:p-8',
  ],

  // Framework which developer can include if CDN is desired (not secrets)
  'fallbackCss' =&gt; '/public/css/fallback.css',
];
?&gt;
  </pre>
</section>

<!-- ========================================================= -->
<!-- 3. DV ENGINE EXAMPLES                                     -->
<!-- ========================================================= -->
<section id="dv-engine-examples" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-purple-500 pl-3">3. DV Engine Usage</h2>

  <p class="text-sm text-slate-400">
    The Data View Engine (<code>DV::class</code>) stores UI metadata to be consumed by layouts.
  </p>

  <pre class="bg-black/80 border border-slate-900 rounded-xl p-4 text-xs overflow-x-auto">
&lt;?php
// =========================================================
// BEST PRACTICE FOR BASTION APPS:
// Use DV::set() inside page files BEFORE output
// so layouts consume them like Next.js layout nesting.
// =========================================================

// Sets the dynamic page title to be read by all stacked layout files
DV::set('title', 'Admin · Products');

// Stores UI flags
DV::set('showSidebar', true);
DV::set('hideNavbar', false);

// Example: Breadcrumbs for navigation
DV::set('breadcrumbs', ['Admin', 'Products', 'Create']);
?&gt;
  </pre>

  <p class="text-xs text-slate-500 mt-3">
    We <strong>never escape JSON using `e()`</strong>, but we <strong>always escape HTML output</strong>.
  </p>
</section>

<!-- ========================================================= -->
<!-- 4. ESCAPING EXPLANATION (e() why matters)                 -->
<!-- ========================================================= -->
<section id="escaping-why" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-red-400 pl-3">4. Escaping Output: Why <code>e()</code> Matters</h2>

  <p class="text-lg text-slate-300">
    <strong>The e() function exists ONLY for HTML rendering safety.</strong>
  </p>

  <p class="text-sm text-slate-400">
    It prevents XSS attacks by converting dangerous characters:
  </p>

  | Raw | Escaped |
  |---|---|
  | `<script>` | `&lt;script&gt;` |
  | `"` | `&amp;quot;` |
  | `'` | `&amp;#039;` |
  | `&` | `&amp;amp;` |

<pre class="bg-black/70 border border-slate-800 rounded-xl p-4 text-xs overflow-auto">
&lt;?php
// Escape product name BEFORE inserting into HTML
$name = e("Cookies <b> & CSP"); 
echo $name;
?&gt;
</pre>

  <p class="text-xs text-slate-500">
    Again: <strong>Escape data when rendering HTML, NEVER when returning JSON.</strong>
  </p>
</section>

<!-- ========================================================= -->
<!-- 5. Database QueryBuilder ORM-like usage                   -->
<!-- ========================================================= -->
<section id="db-section" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-blue-500 pl-3">5. Database Layer & QueryBuilder</h2>

<pre class="bg-black/80 border border-slate-900 rounded-xl p-4 text-xs overflow-x-auto">
&lt;?php
// =========================================================
// CONNECTION:
// Bastion uses PDO internally. SQLite is default because
// it supports WAL mode for concurrency.
// QueryBuilder is facade-like, simulating ORM chains.
// =========================================================

// Fetch many rows
$users = DB::table('users')
  -&gt;where('role','admin')
  -&gt;limit(10)
  -&gt;get();

// Fetch single row
$user = DB::table('users')
  -&gt;where('email','test@example.com')
  -&gt;first();

// Insert new row
$id = DB::table('products')
  -&gt;insert([
      'name'       =&gt; 'Keyboard',
      'price'      =&gt; 99.5,
      'created_at' =&gt; time()
   ]);

// Update row
DB::table('products')
  -&gt;where('id', $id)
  -&gt;update(['price'=&gt;120]);

// Delete row
DB::table('products')
  -&gt;where('id', $id)
  -&gt;delete();
?&gt;
</pre>
</section>

<!-- ========================================================= -->
<!-- 6. File-based Layout Nesting like Next.js                 -->
<!-- ========================================================= -->
<section id="layouts" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-green-500 pl-3">6. Layout Nesting</h2>

  <p class="text-sm text-slate-300">
    BastionPHP uses nested layouts automatically loaded by the router.
    The title comes from DV engine to avoid manual plumbing between nested layouts.
  </p>

<pre class="bg-black/80 border border-slate-900 rounded-xl p-4 text-xs overflow-x-auto">
&lt;?php
// FILE: app/admin/layout.php
// PURPOSE: Wraps all `/admin/*` routes

// Reads the shared title set by DV::set('title', ...) inside page.php
$title = DV::get('title','Admin Panel');
$nonce = req()-&gt;meta['csp_nonce'] ?? '';

// Print HTML shell for admin pages (ALWAYS escape dynamic content)
echo "&lt;title&gt;" . e($title) . "&lt;/title&gt;";
?&gt;
  </pre>
</section>

<!-- ========================================================= -->
<!-- 7. Generated page.php behavior                             -->
<!-- ========================================================= -->
<section id="pages" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-lime-400 pl-3">7. page.php Usage</h2>

  <p class="text-sm text-slate-300">
    page.php files render ONLY the body fragment.
    They can set DV metadata safely.
  </p>

<pre class="bg-black/80 border border-slate-900 rounded-xl p-6 text-xs overflow-x-auto">
&lt;?php
// FILE: app/admin/products/[Id]/page.php
// ROUTE: /admin/products/{Id}
// BastionPHP auto-extracts `[Id]` from the folder and stores into Request meta.

$GLOBALS['title'] = "Editing product {$req-&gt;meta['params']['Id']}";

// DV Metadata
DV::set('title','Product Details');
?&gt;
  </pre>
</section>

<!-- ========================================================= -->
<!-- 8. REST API Endpoint examples (products)                  -->
<!-- ========================================================= -->
<section id="api-products" class="space-y-8">
  <h2 class="text-4xl font-bold border-l-4 border-cyan-400 pl-3">8. API · FastAPI Style Endpoints</h2>

  <h3 class="text-2xl font-bold text-cyan-300">8.1 Collection endpoint (<code>app/api/products/+server.php</code>)</h3>

<pre class="bg-black border border-slate-900 rounded-xl p-5 text-xs overflow-x-auto">
<span>&lt;?php</span>
// ROUTE: /api/products
// Bastion PHP endpoint returning JSON. Handled similar to FastAPI method map.
// Uses req() and res() helpers, and DB QueryBuilder chains.

return [
  'get' =&gt; function($req) {
      // no e() here, because this is JSON, not HTML
      $limit = (int)($req-&gt;input('limit') ?? 20);
      $products = DB::table('products')-&gt;orderBy('id','DESC')-&gt;limit($limit)-&gt;get();
      return res()-&gt;json([
         'data'=>$products,
         'count'=>count($products),
         'limit'=>$limit,
      ], 200);
  },

  'post' =&gt; function($req) {
      $json = $req-&gt;json(); 
      $id = DB::table('products')-&gt;insert([
         'name'  =&gt; (string)$json['name'],
         'price' =&gt; (float)$json['price'],
         'created_at' =&gt; time(),
      ]);
      return res()-&gt;json(['id'=>$id],201);
  }
];
<span>?&gt;</span>
</pre>

<h3 class="text-2xl font-bold text-lime-400">8.2 Single endpoint (<code>app/api/products/[Id]/+server.php</code>)</h3>

<pre class="bg-black border border-slate-900 rounded-xl p-5 text-xs overflow-x-auto">
<span>&lt;?php</span>
// ROUTE: /api/products/{Id}

return [
  'get' =&gt; function($req) {
      $id = (int) req()-&gt;meta['params']['Id'];
      $product = DB::table('products')-&gt;where('id',$id)-&gt;first();
      if(!$product) return res()-&gt;abort(404,'Product not found');
      return res()-&gt;json(['data'=>$product],200);
  },

  'put' =&gt; function($req) {
      $id = (int)req()-&gt;meta['params']['Id'];
      $json = $req-&gt;json();
      DB::table('products')-&gt;where('id',$id)-&gt;update(['price'=>(float)$json['price']]);
      return res()-&gt;json(['updated'=>true],200);
  },

  'delete' =&gt; function($req) {
      $id=(int)req()-&gt;meta['params']['Id'];
      DB::table('products')-&gt;where('id',$id)-&gt;delete();
      return res()-&gt;json(['deleted'=>true],200);
  }
];
<span>?&gt;</span>
</pre>
</section>

<!-- ========================================================= -->
<!-- 9. How to consume JSON endpoints from PHP server side      -->
<!-- ========================================================= -->
<section id="consume-json-php" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-blue-500 pl-3">9. Consuming JSON API Endpoints from PHP</h2>

  <p class="text-sm text-slate-300">
    When you want your PHP backend to consume internal endpoints (BFF architecture), you call them like this internally:
  </p>

<pre class="bg-black/80 border border-slate-900 rounded-xl p-5 text-xs overflow-x-auto">
&lt;?php
// Internal PHP module/client consuming JSON from Bastion endpoint
$response = file_get_contents('/api/products?limit=3');

// Convert JSON string to PHP array
$payload = json_decode($response, true);

// When rendering into HTML we MUST escape with e()
foreach ($payload['data'] as $p) {
    echo "&lt;div&gt;Product: " . e($p['name']) . " ($" . e((string)$p['price']) . ")&lt;/div&gt;";
}
?&gt;
  </pre>

  <p class="text-xs text-slate-500">✔ This is common inside Services or Controllers to avoid frontend JS calls.</p>
</section>

<!-- ========================================================= -->
<!-- 10. Docs Routing Wizard UI                               -->
<!-- ========================================================= -->
<section id="routing-wizard-section" class="space-y-6">
  <h2 class="text-3xl font-bold border-l-4 border-purple-500 pl-3">10. Docs Routing Wizard</h2>
  <p class="text-sm text-slate-300">
    This tool simulates filesystem routing resolution inside BastionPHP, including layout stacking,
    API detection, and dynamic param extraction.
  </p>

  <div class="bg-slate-900/20 border border-slate-800 rounded-xl p-5 shadow-xl space-y-3">
    <input type="text" id="routeInput" placeholder="/api/products/10"
      class="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-sm placeholder-slate-500 focus:ring-2 focus:ring-purple-500">
    
    <button id="simulateBtn"
      class="px-4 py-2 bg-purple-500/10 border border-purple-500/40 text-purple-300 rounded-lg hover:bg-purple-500/20 transition">
      Simulate Route Resolution
    </button>

    <pre id="resolutionOutput" class="mt-3 bg-black/70 border border-slate-900 rounded-xl p-4 text-xs sm:text-sm text-slate-300 overflow-auto"></pre>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('simulateBtn');
        const input = document.getElementById('routeInput');
        const output = document.getElementById('resolutionOutput');

        btn.addEventListener('click', function() {
            const path = input.value.trim();
            const segments = path.replace(/^\/+/, '').split('/').filter(Boolean);

            let file = 'app/page.php';
            const layouts = ['app/layout.php'];
            let dynamicParams = [];

            if (segments[0] === 'api') {
                file = `app/api/${segments[1] || ''}/+server.php`;
                if (segments[2]) {
                    dynamicParams.push(`[${segments[2]}]`);
                    file = `app/api/${segments[1]}/[${segments[2]}]/+server.php`;
                }
            } else {
                let walker = 'app';
                segments.forEach(seg => {
                    walker += '/' + seg;
                    layouts.push(walker + '/layout.php');
                    dynamicParams.push(`[${seg}]`);
                });
                file = `app/${path}/page.php`;
            }

            output.innerHTML = `
✔ Type: ${ segments[0]==='api' ? 'API Endpoint' : 'Page' }
✔ Resolved file: ${ file }
✔ Layout stack:
  ${ layouts.join('\n  ') }
✔ Dynamic params found:
  ${ dynamicParams.join(', ') }
            `;
        });
    });
  </script>
</section>

<!-- ========================================================= -->
<!-- 11. Additional features your scaffold can support         -->
<!-- ========================================================= -->
<section id="future-section" class="space-y-6">
  <h2 class="text-3xl font-bold border-l-4 border-lime-400 pl-3">11. Additional Framework Capabilities</h2>

  <p class="text-sm text-slate-400">
    These features are NOT required to run apps, but can be manually built *on top of the generated boilerplate*:
  </p>

  <ul class="list-disc list-inside text-sm text-slate-300">
    <li>Service container extensions (bind new dependencies)</li>
    <li>Custom adapters to key-value stores or other DB engines</li>
    <li>Collapsable admin panels for employees/parts/audits</li>
    <li>Dynamic log dashboards with auto-refresh feeds</li>
    <li>Live event listeners via WebSockets</li>
  </ul>

  <p class="text-xs text-slate-500">If you want, now we can also generate full Admin Panels or E2E tests.</p>
</section>

</main>
</main>
</body>
</html>