<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <!--
    TITLE (for docs site):
    This is static only because this index.html belongs to the documentation website.
    In Bastion generated apps, titles must be dynamic using the DV engine:
       DV::set('title', 'Your Page');
    And consumed in layout with:
       <title><?= e(DV::get('title', 'Fallback')) ?></title>
  -->
  <title>Bastion PHP 0.1.0 â€“ Developer Documentation</title>

  <!--
    VIEWPORT:
    Ensures responsiveness on all devices. This is a docs convenience, not Bastion runtime code.
  -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!--
    TAILWIND CDN (always active in docs page):
    Bastion itself is Tailwind-ready by default in generated apps, but this docs page loads CDN directly for simplicity.
  -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!--
    SMALL STYLE:
    These are only visual improvements for code readability inside documentation.
  -->
  <style>
    html, body { scroll-behavior: smooth; }
    pre, code  { font-family: ui-monospace, monospace; }
  </style>
</head>

<!--
  BODY:
  Uses dark theme for documentation clarity. In real apps, theme can be toggled using DV::set('theme').
-->
<body class="bg-slate-950 text-slate-100 min-h-screen leading-relaxed antialiased">

<!-- =============================== TOP HEADER =============================== -->
<header class="sticky top-0 z-50 bg-slate-900/70 border-b border-slate-800 backdrop-blur px-4 py-3 shadow-lg">
  <div class="max-w-6xl mx-auto flex items-center gap-3">
    <!-- Minimal visual logo block -->
    <div class="h-10 w-10 flex items-center justify-center bg-cyan-500/10 border border-cyan-500/40 rounded-lg text-cyan-300 text-xs font-bold">
      BP
    </div>
    <div>
      <h1 class="text-xl font-bold">Bastion PHP <span class="text-xs font-normal text-slate-400">v0.1.0</span></h1>
      <p class="text-xs text-slate-500 mt-[-2px]">Security-First, Filesystem-Routed, Zero-Magic PHP Framework</p>
    </div>
  </div>
</header>

<!-- =============================== SIDEBAR NAVIGATION =============================== -->
<aside class="fixed top-24 left-0 w-64 h-[calc(100vh-6rem)] overflow-y-auto border-r border-slate-800/40 text-sm bg-slate-900/10 p-4 hidden lg:block">
  <!--
    This is a docs-only sidebar, it does NOT exist in generated apps unless you create one.
    Used to quickly navigate sections like pro docs.
  -->
  <nav class="space-y-2 text-slate-400">
    <p class="font-semibold text-xs text-slate-500 uppercase tracking-widest mb-2">Docs Navigation</p>
    <ul class="space-y-1">
      <li><a class="hover:text-cyan-400" href="#overview">Overview</a></li>
      <li><a class="hover:text-cyan-400" href="#installation">Installation</a></li>
      <li><a class="hover:text-cyan-400" href="#configuration">Configuration</a></li>
      <li><a class="hover:text-cyan-400" href="#title-system">Title System</a></li>
      <li><a class="hover:text-cyan-400" href="#dv-engine">DV Engine</a></li>
      <li><a class="hover:text-cyan-400" href="#routing">Filesystem Routing</a></li>
      <li><a class="hover:text-cyan-400" href="#middleware">Middleware Pipeline</a></li>
      <li><a class="hover:text-cyan-400" href="#database">Database & QueryBuilder</a></li>
      <li><a class="hover:text-cyan-400" href="#components">Components</a></li>
      <li><a class="hover:text-cyan-400" href="#api-endpoints">Products API</a></li>
      <li><a class="hover:text-cyan-400" href="#routing-wizard">Routing Wizard</a></li>
      <li><a class="hover:text-cyan-400" href="#php-rest-consume">REST from PHP</a></li>
      <li><a class="hover:text-cyan-400" href="#migrations-seeds">Migrations & Seeds</a></li>
      <li><a class="hover:text-cyan-400" href="#cli">CLI Commands</a></li>
      <li><a class="hover:text-cyan-400" href="#deployment">Deployment</a></li>
    </ul>
  </nav>
</aside>

<!-- =============================== MAIN CONTAINER =============================== -->
<main class="max-w-6xl mx-auto px-4 pt-12 lg:pl-72 space-y-32">

<!-- ================================================================ -->
<!-- 1. OVERVIEW                                                     -->
<!-- ================================================================ -->
<section id="overview" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-cyan-500 pl-3">1. Overview</h2>

  <p class="text-lg text-slate-300">
    Bastion PHP is a <strong>company-grade internal framework</strong> designed for security and fast deployment.
    Nothing is optional. Everything is generated with protections always enabled.
    It works like a fusion of ideas from <strong>Next.js (filesystem routing)</strong>,
    <strong>Django (structured admin tools)</strong>, and <strong>FastAPI (closure endpoints and validation ergonomics)</strong>,
    but implemented entirely in pure PHP with HTMX for client interactions.
  </p>

  <div class="bg-slate-900/20 border border-slate-800 rounded-2xl p-6 text-sm shadow-xl">
    <p class="font-bold text-base text-cyan-400 mb-2">Framework Principles</p>
    <ul class="list-disc list-inside space-y-1 text-slate-400">
      <li>âœ” No frontend frameworks like React or template engines like Twig/Jinja</li>
      <li>âœ” All runtime pages are fragments (<code>page.php</code> without HTML shell)</li>
      <li>âœ” Routing happens through folders, not annotations</li>
      <li>âœ” <code>+server.php</code> returns closures mapping HTTP methods</li>
      <li>âœ” Security is not disabled in any environment</li>
      <li>âœ” SQLite is main database by default using WAL for parallel writes</li>
      <li>âœ” DV Engine is used to set <code>title</code>, <code>theme</code>, <code>breadcrumbs</code>, or UI flags</li>
      <li>âœ” ORM ergonomics exist via QueryBuilder (<code>DB::table()</code>) but never hides SQL entirely</li>
    </ul>
  </div>
</section>

<!-- ================================================================ -->
<!-- 2. INSTALLATION                                                  -->
<!-- ================================================================ -->
<section id="installation" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-emerald-500 pl-3" id="installation">2. Installation</h2>

  <p class="text-lg text-slate-300">
    Install Bastion by cloning the repository and running the app generator script.
  </p>

<pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-x-auto">
# Clone framework
git clone https://github.com/alexmejiaIMPRO/BastionPHP.git

# Move into project directory
cd BastionPHP
</pre>

  <p class="text-sm text-slate-500">
    From here, you execute the generator script (see repository) to scaffold a full secure app.
  </p>
</section>

<!-- ================================================================ -->
<!-- 3. CONFIGURATION SYSTEM                                         -->
<!-- ================================================================ -->
<section id="configuration" class="space-y-8">
  <h2 class="text-4xl font-bold border-l-4 border-yellow-500 pl-3">3. Configuration System</h2>

  <p class="text-sm text-slate-300">
    Bastion reads configuration in this order:
  </p>
  <ol class="list-decimal list-inside text-sm text-slate-400 space-y-1">
    <li><code>.env</code> â†’ secrets and environment switches.</li>
    <li><code>config/app.php</code> â†’ app name, environment, debug mode.</li>
    <li><code>config/database.php</code> â†’ DB connection definitions.</li>
    <li><code>config/security.php</code> â†’ CSRF, JWT, cookies & CSP options.</li>
    <li><code>config/style.php</code> â†’ theme and Tailwind usage.</li>
  </ol>

  <!-- 3.1 ENV -->
  <h3 class="text-xl font-semibold text-slate-200">3.1 <code>.env</code> variables</h3>
  <p class="text-sm text-slate-400">
    Environment variables give you <strong>different behavior per environment</strong> but never disable security.
    You never store secrets in PHP code; only here.
  </p>

<pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-auto">
# App behavior
APP_ENV=development         # "development" or "production"
APP_DEBUG=true             # shows full stack traces during development

# Encryption seed for internal helpers
APP_KEY=base64:GENERATED_APP_KEY_HERE

# Database (default: SQLite)
DB_CONNECTION=sqlite
DB_PATH=storage/db/app.db     # main DB file

# Optional cache DB for heavy API or dashboards
DB_CACHE_PATH=storage/db/cache.db

# Authentication (JWT)
JWT_SECRET=GENERATED_JWT_SECRET_HERE
JWT_TTL=900                # seconds â†’ 15 minutes
JWT_REFRESH_TTL=604800     # 7 days

# Cookie Security
SECURE_COOKIES=false
SAME_SITE=lax              # "strict", "lax" or "none"

# CSRF Protection
CSRF_ENABLED=true          # compare CSRF for unsafe HTTP methods
CSRF_HEADER_NAME=X-CSRF-Token

# Content Security Policy reporting endpoint
CSP_REPORT_URI=/api/csp-report
</pre>

  <p class="text-xs text-slate-500">
    In short: <strong>.env = where your secrets and toggles live, but they never turn off security controls, only tune them.</strong>
  </p>

  <!-- 3.2 APP CONFIG -->
  <h3 class="text-2xl font-semibold text-slate-200">3.2 <code>config/app.php</code> â€“ App identity</h3>
  <p class="text-sm text-slate-400">
    This file answers: "What is this application?" and "How noisy can errors be?".
    It does <strong>not</strong> hold secrets; it only reads from <code>env()</code>.
  </p>

<pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-auto">
&lt;?php
// FILE: config/app.php
// PURPOSE: app identity and environment behavior.

return [
  'name'     =&gt; 'Bastion App',
  'env'      =&gt; env('APP_ENV', 'production'),
  'debug'    =&gt; env('APP_DEBUG', false),
  'timezone' =&gt; 'America/Mexico_City',
];
?&gt;
</pre>

  <!-- 3.3 DATABASE CONFIG -->
  <h3 class="text-2xl font-semibold text-blue-400">3.3 <code>config/database.php</code> â€“ DB engines</h3>
  <p class="text-sm text-slate-400">
    The DB config does not open real connections by itself. It only tells the <code>DB</code> service how to connect
    when first used.
  </p>

<pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-auto">
&lt;?php
// FILE: config/database.php
// PURPOSE: define named PDO connections.

return [
  'connections' =&gt; [
    'sqlite' =&gt; [
      'driver' =&gt; 'sqlite',
      'path'   =&gt; env('DB_PATH', 'storage/db/app.db'),
    ],
    'oracle' =&gt; [
      'driver'   =&gt; 'oci',
      'host'     =&gt; env('ORACLE_HOST'),
      'port'     =&gt; env('ORACLE_PORT','1521'),
      'database' =&gt; env('ORACLE_DB'),
      'username' =&gt; env('ORACLE_USER'),
      'password' =&gt; env('ORACLE_PASS'),
      'charset'  =&gt; 'AL32UTF8',
    ],
  ],
];
?&gt;
</pre>

  <p class="text-xs text-slate-500">
    In your Bastion apps, the QueryBuilder chooses one connection (usually <code>sqlite</code>) but can be extended to Oracle or others.
  </p>

  <!-- 3.4 SECURITY CONFIG -->
  <h3 class="text-2xl font-semibold text-red-400">3.4 <code>config/security.php</code> â€“ Guards & Policies</h3>
  <p class="text-sm text-slate-400">
    This file describes how strict security is at runtime.
    Even in development, protections remain ON.
  </p>

<pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-auto">
&lt;?php
// FILE: config/security.php
// PURPOSE: toggle and tune security behavior.

return [
  'csrf_enabled' =&gt; (bool)env('CSRF_ENABLED', true),
  'csrf_header'  =&gt; env('CSRF_HEADER_NAME', 'X-CSRF-Token'),
  'jwt_secret'   =&gt; env('JWT_SECRET'),
  'cookie' =&gt; [
    'same_site' =&gt; env('SAME_SITE','lax'),
    'http_only' =&gt; true,
    'secure'    =&gt; env('APP_ENV') === 'production',
  ],
  'input_sanitization_global' =&gt; true,
];
?&gt;
</pre>

  <p class="text-xs text-slate-500">
    Think of it as: <strong>this is where you enforce how strict CSRF, JWT, and cookies should behave per environment.</strong>
  </p>

  <!-- 3.5 STYLE CONFIG -->
  <h3 class="text-2xl font-semibold text-emerald-400">3.5 <code>config/style.php</code> â€“ Tailwind & theme</h3>
  <p class="text-sm text-slate-400">
    This file controls the visual defaults for generated apps.
    The docs site uses Tailwind CDN for simplicity, but your app will compile CSS if configured.
  </p>

<pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-auto">
&lt;?php
// FILE: config/style.php
// PURPOSE: theme & Tailwind behavior.

return [
  'theme'         =&gt; 'dark',       // initial theme
  'use_tailwind'  =&gt; true,
  'tailwind_mode' =&gt; 'build',      // "cdn" for prototyping, "build" for production pipelines
  'navbar_fixed'  =&gt; true,
  'sidebar' =&gt; [
    'enabled'     =&gt; true,
    'breakpoints' =&gt; [ 'lg' =&gt; true, 'md' =&gt; false, 'sm' =&gt; false ],
  ],
];
?&gt;
</pre>

  <p class="text-xs text-slate-500">
    In short: <strong>Config section 3.0 explains "what the app is", "how secure it is", and "how it looks", all driven by .env.</strong>
  </p>
</section>

<!-- ================================================================ -->
<!-- 4. TITLE SYSTEM                                                  -->
<!-- ================================================================ -->
<section id="title-system" class="space-y-4">
  <h2 class="text-4xl font-bold border-l-4 border-yellow-500 pl-3">4. Title System</h2>
  <!--
    Bastion supports legacy globals and DV Engine titles, but always prefers DV.
  -->
  <p class="text-sm text-slate-300">
    Generated apps should always prefer DV Engine. Legacy <code>$GLOBALS['title']</code> is supported but only as fallback.
  </p>

  <p class="text-sm text-slate-300">Set title inside <code>page.php</code>:</p>
  <pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-auto">
&lt;?php
// FILE: app/admin/users/page.php

// Recommended: DV Engine
DV::set('title','Admin Â· Users');

// Legacy (still supported if you want to keep old code)
$GLOBALS['title'] = 'Admin Â· Users (legacy)';
?&gt;
  </pre>

  <p class="text-sm text-slate-300">Read it inside <code>layout.php</code>:</p>
  <pre class="bg-black/40 border border-slate-900 rounded-xl p-4 text-xs overflow-auto">
&lt;?php
// FILE: app/admin/layout.php
$title = DV::get('title', $GLOBALS['title'] ?? 'Admin');
?&gt;
&lt;title&gt;&lt;?= e($title) ?&gt;&lt;/title&gt;
  </pre>

  <p class="text-xs text-slate-500">
    <strong>Rule:</strong> You always escape the title with <code>e()</code> because it is being printed into HTML.
  </p>
</section>

<!-- ================================================================ -->
<!-- 5. DV ENGINE                                                     -->
<!-- ================================================================ -->
<section id="dv-engine" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-purple-500 pl-3">5. DV Engine</h2>

  <p class="text-sm text-slate-300">
    DV is a static keyâ€“value store used to share metadata between pages, layouts, and sometimes endpoints.
    It works like a "view bag".
  </p>

  <ul class="list-disc list-inside text-sm text-slate-400 space-y-1">
    <li><code>DV::set('key', $value)</code> â†’ set state.</li>
    <li><code>DV::get('key', $fallback)</code> â†’ get state.</li>
  </ul>

  <pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-x-auto">
Common keys used in Bastion generated apps:
  - title
  - theme
  - breadcrumbs[]
  - hideSidebar
  - hideNavbar
  - requiresAuth (bool)
  </pre>

  <h3 class="text-xl font-semibold text-slate-200">5.1 Example: nested layout + page + DV</h3>
  <pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-x-auto">
&lt;?php
// FILE: app/admin/layout.php
// Purpose: wraps ALL "/admin/*" pages.

$nonce = req()->meta['csp_nonce'] ?? '';
$title = DV::get('title', 'Admin Area');

?&gt;
&lt;!doctype html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="utf-8"&gt;
  &lt;title&gt;&lt;?= e($title) ?&gt;&lt;/title&gt;
  &lt;!-- CSP nonced inline styles/scripts go here using $nonce --&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;nav&gt;...&lt;/nav&gt;

  &lt;main&gt;
    &lt;?php
      // The router will render the inner page.php fragment here.
      echo $content;
    ?&gt;
  &lt;/main&gt;
&lt;/body&gt;
&lt;/html&gt;
  </pre>

  <pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-x-auto">
&lt;?php
// FILE: app/admin/users/page.php
// Purpose: "/admin/users" page fragment (no &lt;html>, only body content).

use App\Core\DV;
use App\Core\DB;

DV::set('title', 'Admin Â· Users');
DV::set('breadcrumbs', ['Admin', 'Users']);

// We can also pre-load data here, or call a REST endpoint if desired:
$users = DB::table('users')-&gt;orderBy('id','DESC')-&gt;limit(20)-&gt;get();
?&gt;

&lt;section class="space-y-3"&gt;
  &lt;h1 class="text-2xl font-bold"&gt;Users&lt;/h1&gt;
  &lt;ul class="text-sm"&gt;
    &lt;?php foreach ($users as $u): ?&gt;
      &lt;li&gt;User #&lt;?= e((string)$u['id']) ?&gt; â€“ &lt;?= e($u['email']) ?&gt;&lt;/li&gt;
    &lt;?php endforeach; ?&gt;
  &lt;/ul&gt;
&lt;/section&gt;
  </pre>

  <p class="text-xs text-slate-500">
    Notice: <strong>DV is set by the page</strong> and <strong>consumed by nested layouts</strong>. You never pass <code>$title</code> manually.
  </p>
</section>

<!-- ================================================================ -->
<!-- 6. FILESYSTEM ROUTING (like Next.js)                            -->
<!-- ================================================================ -->
<section id="routing" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-indigo-500 pl-3">6. Filesystem Routing</h2>

  <p class="text-sm text-slate-300">
    Bastion resolves routes as file paths, just like Next.js:
  </p>
  <pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-x-auto">
/                    -> app/page.php
/admin               -> app/admin/page.php (+ app/admin/layout.php)
/admin/users         -> app/admin/users/page.php (+ admin layouts stack)
/products/[Id]       -> app/products/[Id]/page.php
/api/products        -> app/api/products/+server.php
/api/products/10     -> app/api/products/[Id]/+server.php
  </pre>

  <p class="text-xs text-slate-500">
    Dynamic segments use <code>[Param]</code> folder names. The param is injected into <code>$req->meta['params']</code>.
  </p>
</section>

<!-- ================================================================ -->
<!-- 7. MIDDLEWARE PIPELINE                                          -->
<!-- ================================================================ -->
<section id="middleware" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-teal-500 pl-3">7. Middleware Pipeline</h2>

  <p class="text-sm text-slate-300">
      Every request passes through middlewares BEFORE router resolution.
      Default order:
  </p>

  <pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-x-auto">
SecurityHeaders â†’ RateLimit â†’ AuthMiddleware â†’ AdminOnly â†’ Router
  </pre>

  <p class="text-xs text-slate-500">
      You cannot "turn security off", only add more logic.
  </p>
</section>

<!-- ================================================================ -->
<!-- 8. DATABASE LAYER                                                -->
<!-- ================================================================ -->
<section id="database" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-lime-500 pl-3">8. Database & QueryBuilder</h2>

  <p class="text-sm text-slate-300">
      Default DB: SQLite with WAL for parallel writes. You can plug Oracle manually.
  </p>

<pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-auto">
&lt;?php
// FILE: using DB QueryBuilder

// Get admins:
$admins = DB::table('users')
  -&gt;where('role','admin')
  -&gt;orderBy('id','DESC')
  -&gt;limit(10)
  -&gt;get();

// Get single:
$user = DB::table('users')
  -&gt;where('email','user@example.com')
  -&gt;first();

// Insert product:
$id = DB::table('products')
  -&gt;insert([
     'name'  =&gt; 'Mouse',
     'price' =&gt; 49.5,
  ]);

// Update:
DB::table('products')
  -&gt;where('id',$id)
  -&gt;update(['price'=&gt;55]);

// Delete:
DB::table('products')
  -&gt;where('id',$id)
  -&gt;delete();
?&gt;
</pre>

  <p class="text-xs text-slate-500">
    <strong>Dynamic vs static:</strong> you can call the QueryBuilder anywhere (page, service, API closure), but SQL is always explicit.
  </p>
</section>

<!-- ================================================================ -->
<!-- 9. COMPONENTS (SERVER AND CLIENT INTERACTIVE)                    -->
<!-- ================================================================ -->
<section id="components" class="space-y-12">
  <h2 class="text-4xl font-bold border-l-4 border-pink-500 pl-3">9. Components System</h2>

  <p class="text-lg text-slate-400">
    Bastion PHP simulates <strong>React component ergonomics without a frontend framework</strong>.
    Reusable UI is implemented as simple PHP functions under <code>app/components/</code>.
  </p>

  <!-- Server side -->
  <div>
    <h3 class="text-2xl font-bold text-emerald-400">9.1 Server-Side PHP Components</h3>
    <p class="text-sm text-slate-400 mb-2">
      Pure server components: they do not use HTMX. They render static HTML fragments.
    </p>

<pre class="bg-black/70 border border-slate-800 rounded-xl p-6 text-xs overflow-x-auto">
&lt;?php
// FILE: app/components/ProductCard.php
// PURPOSE: render a reusable product UI card safely in server-side HTML.

function ProductCard(array $product): string {
  // Convert and escape BEFORE building HTML:
  $id    = (int) $product['id'];            // id as integer
  $name  = e($product['name']);             // escape HTML from DB
  $price = e((string)$product['price']);    // cast to string + escape

  return "
  &lt;article id='product-{$id}' 
           class='p-4 sm:p-6 bg-slate-900/20 border border-slate-800 rounded-xl shadow-lg'&gt;
    &lt;h3 class='text-xl font-bold'&gt;{$name}&lt;/h3&gt;
    &lt;p class='text-sm opacity-70'&gt;ðŸ’° Price: \${$price}&lt;/p&gt;
    &lt;p class='text-xs text-slate-500'&gt;ðŸ†” ID: {$id}&lt;/p&gt;
  &lt;/article&gt;
  ";
}
?&gt;
</pre>

    <p class="text-xs text-slate-500">
      Use <code>e()</code> for any user/DB data printed into HTML. This is where XSS is prevented.
    </p>
  </div>

  <!-- Client hydrated with HTMX -->
  <div>
    <h3 class="text-2xl font-bold text-red-400">9.2 Client-Interactive Components (HTMX)</h3>
    <p class="text-sm text-slate-400 mb-2">
      Interactive components live in the same <code>app/components/</code> folder but use HTMX attributes.
      They still return HTML strings, but the browser will call API endpoints automatically.
    </p>

<pre class="bg-black/70 border border-slate-800 rounded-xl p-6 text-xs overflow-x-auto text-slate-200">
&lt;?php
// FILE: app/components/ProductRow.php
// PURPOSE: reusable row that can delete a product via HTMX, no JS.

function ProductRow(array $product): string {
  $id   = (int)$product['id'];
  $name = e($product['name']);

  return "
  &lt;tr id='product-{$id}' class='border-b border-slate-800 hover:bg-slate-900/20'&gt;
    &lt;td class='py-2'&gt;ðŸ“¦ {$name}&lt;/td&gt;
    &lt;td class='text-right'&gt;
      &lt;button
        hx-delete='/api/products/{$id}'
        hx-target='#product-{$id}'
        hx-swap='outerHTML'
        class='px-2 py-1 bg-red-500/10 border border-red-500/30 text-red-400 rounded-md hover:bg-red-500/20'&gt;
        ðŸ—‘ Delete
      &lt;/button&gt;
    &lt;/td&gt;
  &lt;/tr&gt;
  ";
}
?&gt;
</pre>

    <p class="text-xs text-slate-500">
      HTMX handles the HTTP call. Bastion handles the +server.php closure and returns HTML or JSON.
    </p>
  </div>
</section>

<!-- ================================================================ -->
<!-- 10. API ENDPOINTS (PRODUCTS EXAMPLE)                            -->
<!-- ================================================================ -->
<section id="api-endpoints" class="space-y-12">
  <h2 class="text-4xl font-bold border-l-4 border-orange-500 pl-3">10. Products API Endpoints</h2>
  
  <p class="text-lg text-slate-400">
    API endpoints live under <code>app/api/&lt;resource&gt;/+server.php</code>.
    Each file returns an array mapping HTTP method names to closures (like FastAPI).
  </p>

  <!-- api/products/+server.php -->
  <div>
    <h3 class="text-2xl font-bold text-cyan-400">10.1 Collection Endpoint (<code>app/api/products/+server.php</code>)</h3>

<pre class="bg-black/70 border border-slate-800 rounded-xl p-6 text-xs overflow-x-auto">
&lt;?php
// FILE: app/api/products/+server.php
// ROUTE: /api/products
// PURPOSE: list and create products in JSON.

use App\Core\DB;

// This file returns an array of closures keyed by lowercase HTTP method.
return [

  // GET /api/products?limit=10
  'get' =&gt; function($req) {
      // read query param ?limit= (string) and cast
      $limit = (int)($req-&gt;input('limit') ?? 10);

      // build query using QueryBuilder
      $rows = DB::table('products')
          -&gt;orderBy('id','DESC')
          -&gt;limit($limit)
          -&gt;get();

      // return JSON using global res() helper
      return res()-&gt;json([
          'success' =&gt; true,
          'limit'   =&gt; $limit,
          'count'   =&gt; count($rows),
          'data'    =&gt; $rows,
      ], 200);
  },

  // POST /api/products
  'post' =&gt; function($req) {
      // parse JSON body: { "name": "...", "price": 123.45 }
      $body = $req-&gt;json();

      $name  = (string)($body['name']  ?? '');
      $price = (float) ($body['price'] ?? 0);

      // insert row
      $id = DB::table('products')-&gt;insert([
          'name'       =&gt; $name,
          'price'      =&gt; $price,
          'created_at' =&gt; time(),
          'created_by' =&gt; auth()['id'] ?? 0,
      ]);

      return res()-&gt;json([
          'success' =&gt; true,
          'id'      =&gt; $id,
      ], 201);
  },
];
?&gt;
</pre>
  </div>

  <!-- api/products/[Id]/+server.php -->
  <div>
    <h3 class="text-2xl font-bold text-amber-400">10.2 Single Resource Endpoint (<code>app/api/products/[Id]/+server.php</code>)</h3>

<pre class="bg-black/70 border border-slate-800 rounded-xl p-6 text-xs overflow-x-auto">
&lt;?php
// FILE: app/api/products/[Id]/+server.php
// ROUTE: /api/products/{Id}
// PURPOSE: work with one product: read, update, delete.

use App\Core\DB;

return [

  // GET /api/products/{Id}
  'get' =&gt; function($req) {
      // router extracts [Id] and stores in meta
      $id = (int)$req-&gt;meta['params']['Id'];

      $product = DB::table('products')
          -&gt;where('id',$id)
          -&gt;first();

      if (! $product) {
          return res()-&gt;abort(404, 'Product not found');
      }

      return res()-&gt;json([
          'success' =&gt; true,
          'data'    =&gt; $product,
      ], 200);
  },

  // PUT /api/products/{Id}
  'put' =&gt; function($req) {
      $id   = (int)$req-&gt;meta['params']['Id'];
      $json = $req-&gt;json();

      $fields = [];

      if (isset($json['name'])) {
          $fields['name'] = (string)$json['name'];
      }

      if (isset($json['price'])) {
          $fields['price'] = (float)$json['price'];
      }

      if ($fields) {
          DB::table('products')-&gt;where('id',$id)-&gt;update($fields);
      }

      return res()-&gt;json([
          'success' =&gt; true,
          'updated' =&gt; (bool)$fields,
          'id'      =&gt; $id,
      ], 200);
  },

  // DELETE /api/products/{Id}
  'delete' =&gt; function($req) {
      $id = (int)$req-&gt;meta['params']['Id'];

      DB::table('products')-&gt;where('id',$id)-&gt;delete();

      return res()-&gt;json([
          'success' =&gt; true,
          'deleted' =&gt; true,
          'id'      =&gt; $id,
      ], 200);
  },
];
?&gt;
</pre>
  </div>

  <!-- Dynamic page example -->
  <div>
    <h3 class="text-2xl font-bold text-lime-400">10.3 Dynamic Page (<code>app/products/[Id]/page.php</code>)</h3>
    <p class="text-sm text-slate-400">
      Same <code>[Id]</code> pattern but for HTML fragments instead of JSON.
      Here we use DV Engine for the title and escape all UI.
    </p>

<pre class="bg-black/60 border border-slate-800 rounded-xl p-6 text-xs overflow-x-auto">
&lt;?php
// FILE: app/products/[Id]/page.php
// ROUTE: /products/{Id}

use App\Core\DB;
use App\Core\DV;

$id = (int) req()-&gt;meta['params']['Id'];

$product = DB::table('products')
  -&gt;where('id',$id)
  -&gt;first();

if (! $product) {
  res()-&gt;abort(404, 'Product not found');
  exit;
}

DV::set('title', 'Product #'.$id);

?&gt;
&lt;section class="space-y-2"&gt;
  &lt;h1 class="text-2xl font-bold"&gt;Product #&lt;?= e((string)$id) ?&gt;&lt;/h1&gt;
  &lt;p&gt;Name: &lt;?= e($product['name']) ?&gt;&lt;/p&gt;
  &lt;p&gt;Price: $&lt;?= e((string)$product['price']) ?&gt;&lt;/p&gt;
&lt;/section&gt;
</pre>
  </div>
</section>

<!-- ================================================================ -->
<!-- 11. DOCS ROUTING WIZARD                                          -->
<!-- ================================================================ -->
<section id="routing-wizard" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-purple-500 pl-3">11. Docs Routing Wizard</h2>
  <p class="text-sm text-slate-300">
      Tool to simulate and visualize route resolution inside Bastion PHP.
  </p>

  <div class="bg-slate-900/40 border border-slate-700 rounded-xl p-6 shadow-xl space-y-3">
    <label class="block text-xs text-slate-500 uppercase tracking-widest">Test a route</label>
    <input type="text" id="routeInput" placeholder="/api/products/10"
      class="w-full bg-slate-950 border border-slate-800 rounded-lg p-2 text-sm placeholder-slate-600 focus:ring-2 focus:ring-purple-500">

    <button id="resolveRouteBtn"
      class="w-full sm:w-auto px-4 py-2 bg-purple-500/10 border border-purple-500/40 text-purple-300 rounded-lg hover:bg-purple-500/20 transition text-sm font-medium">
      Resolve Route
    </button>

    <pre id="wizardOutput" class="mt-3 bg-black/60 border border-slate-800 rounded-xl p-5 text-xs text-slate-400 overflow-auto"></pre>
  </div>
</section>

<!-- ================================================================ -->
<!-- 12. REST API FROM PHP (NO JS)                                   -->
<!-- ================================================================ -->
<section id="php-rest-consume" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-blue-500 pl-3">12. REST API from PHP (no JavaScript)</h2>

  <p class="text-sm text-slate-300">
    Bastion is meant to be used as a <strong>Backend-for-Frontend</strong>: PHP can consume its own JSON endpoints.
    The pattern is always:
  </p>
  <ol class="list-decimal list-inside text-sm text-slate-400 space-y-1">
    <li>Call internal URL (like <code>/api/products</code>) from PHP.</li>
    <li><code>json_decode()</code> the response into an array.</li>
    <li>Escape values with <code>e()</code> only when printing HTML.</li>
  </ol>

<pre class="bg-black/80 border border-slate-900 rounded-xl p-5 text-xs overflow-x-auto">
&lt;?php
// FILE: app/admin/products/page.php
// PURPOSE: consume REST API from PHP and show HTML without using JS.

use App\Core\DV;

// 1. Set title for layouts:
DV::set('title', 'Admin Â· Products');

// 2. Call internal REST endpoint (e.g. via file_get_contents).
//    In production you could switch this to a dedicated HTTP client.
$json = file_get_contents('/api/products?limit=5');

// 3. Decode JSON into PHP array
$payload = json_decode($json, true);

// 4. Safely render HTML using e()
?&gt;

&lt;section class="space-y-3"&gt;
  &lt;h1 class="text-2xl font-bold"&gt;Last 5 Products&lt;/h1&gt;

  &lt;?php if (!empty($payload['data'])): ?&gt;
    &lt;ul class="space-y-1 text-sm"&gt;
      &lt;?php foreach ($payload['data'] as $p): ?&gt;
        &lt;li&gt;
          &lt;strong&gt;ID:&lt;/strong&gt; &lt;?= e((string)$p['id']) ?&gt;
          &amp;mdash;
          &lt;strong&gt;Name:&lt;/strong&gt; &lt;?= e($p['name']) ?&gt;
          &amp;mdash;
          &lt;strong&gt;Price:&lt;/strong&gt; $&lt;?= e((string)$p['price']) ?&gt;
        &lt;/li&gt;
      &lt;?php endforeach; ?&gt;
    &lt;/ul&gt;
  &lt;?php else: ?&gt;
    &lt;p class="text-xs text-slate-500"&gt;No products returned by REST API.&lt;/p&gt;
  &lt;?php endif; ?&gt;
&lt;/section&gt;
</pre>

  <div class="bg-slate-900/40 border border-slate-700 rounded-xl p-4 text-xs text-slate-300 space-y-1">
    <p><strong>Very important rules:</strong></p>
    <ul class="list-disc list-inside text-slate-400 space-y-1">
      <li>Do <strong>not</strong> call <code>e()</code> when building JSON in <code>+server.php</code>. JSON must be raw.</li>
      <li>Do call <code>e()</code> when printing into HTML (<code>page.php</code>, components, layouts).</li>
      <li>REST endpoints are responsible for data; pages/components are responsible for safe HTML.</li>
    </ul>
  </div>
</section>

<!-- ================================================================ -->
<!-- 13. MIGRATIONS & SEEDS                                         -->
<!-- ================================================================ -->
<section id="migrations-seeds" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-lime-500 pl-3">13. Migrations & Seeds</h2>

  <p class="text-md text-slate-300">
    Bastion runs migrations and seeders using CLI commands (no flags, always included).
  </p>

  <h3 class="text-lg font-bold text-slate-400">13.1 Migration Example (SQL)</h3>
<pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-x-auto">
-- FILE: database/migrations/001_create_products.sql
CREATE TABLE IF NOT EXISTS products (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  price REAL NOT NULL,
  sku TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  created_by INTEGER NOT NULL
);
</pre>

  <p class="text-xs text-slate-500">Run migrations:</p>
  <pre class="bg-black/20 border border-slate-900 rounded-xl p-3 text-xs">
./bastion migrate
  </pre>

  <h3 class="text-lg font-bold text-slate-400">13.2 Seed Example</h3>
<pre class="bg-black/60 border border-slate-800 rounded-xl p-4 text-xs overflow-auto">
&lt;?php
// FILE: database/seeds/001_seed_users.php

DB::table('users')-&gt;insert([
  'email'      =&gt; 'admin@local.test',
  'password'   =&gt; password_hash('AdminPass123', PASSWORD_BCRYPT),
  'role'       =&gt; 'admin',
  'created_at' =&gt; time(),
  'created_by' =&gt; 0,
]);

DB::table('products')-&gt;insert([
  'name'       =&gt; 'Hydrated Product Example',
  'price'      =&gt; 10.5,
  'sku'        =&gt; 'SKU-DEMO-001',
  'created_at' =&gt; time(),
  'created_by' =&gt; 0,
]);
?&gt;
</pre>

  <p class="text-xs text-slate-500">Run seeds:</p>
  <pre class="bg-black/20 border border-slate-900 rounded-xl p-3 text-xs">
./bastion seed
    </pre>
</section>

<!-- ================================================================ -->
<!-- 14. CLI COMMANDS OVERVIEW                                       -->
<!-- ================================================================ -->
<section id="cli" class="space-y-6">
  <h2 class="text-4xl font-bold border-l-4 border-red-500 pl-3">14. CLI Bastion Commands</h2>

  <p class="text-sm text-slate-300">
    Bastion CLI acts like a small mix of Django's <code>manage.py</code> and Artisan:
  </p>

  <ul class="list-disc list-inside text-sm text-slate-400 space-y-2">
    <li><code>./bastion run-dev</code> â†’ dev server.</li>
    <li><code>./bastion migrate</code> â†’ run migrations.</li>
    <li><code>./bastion seed</code> â†’ run seeds.</li>
    <li><code>./bastion key:generate</code> â†’ APP_KEY.</li>
    <li><code>./bastion jwt:secret</code> â†’ JWT_SECRET.</li>
    <li><code>./bastion make:page Users</code> â†’ page scaffold.</li>
    <li><code>./bastion make:api Products</code> â†’ API scaffold.</li>
    <li><code>./bastion make:component ProductCard --server</code></li>
    <li><code>./bastion make:component ProductForm --client</code></li>
  </ul>
</section>

<!-- ================================================================ -->
<!-- 15. DEPLOYMENT                                                   -->
<!-- ================================================================ -->
<section id="deployment" class="space-y-6 pb-16">
  <h2 class="text-4xl font-bold border-l-4 border-rose-500 pl-3">15. Deployment</h2>

  <p class="text-lg text-slate-300">
      After building the app with <code>./bastion run-build</code> your scaffold stays fixed for production.
      You still keep all protections active.
  </p>

  <pre class="bg-black/20 border border-slate-900 rounded-xl p-3 text-xs overflow-x-auto">
./bastion run-build
  </pre>
</section>

</main>

<script>
  // ESCAPE helper used only for the docs Routing Wizard output.
  const eDoc = str => String(str).replace(/[&<>"']/g, c => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;"
  }[c]));

  function resolveRouteSimulated(path) {
    const clean = path.trim().replace(/^\/+/, '');
    const segs  = clean === '' ? [] : clean.split('/').filter(Boolean);
    let type = 'page';
    let file = 'app/page.php';
    const layouts = ['app/layout.php'];
    const params = {};

    if (segs[0] === 'api') {
      type = 'api';
      const resource = segs[1] ?? '';
      if (resource === 'products') {
        if (segs.length === 2) {
          file = 'app/api/products/+server.php';
        } else if (segs.length >= 3) {
          file = 'app/api/products/[Id]/+server.php';
          params['Id'] = segs[2];
        }
      } else {
        file = 'app/api/' + resource + '/+server.php';
      }
    }

    let walker = 'app';
    for (const s of segs) {
      if (s === 'api') continue;
      walker += '/' + s;
      layouts.push(walker + '/layout.php');
    }

    return { type, file, layouts: [...new Set(layouts)], params };
  }

  window.addEventListener('load', () => {
    const btn = document.getElementById('resolveRouteBtn');
    const inp = document.getElementById('routeInput');
    const out = document.getElementById('wizardOutput');

    if (!btn || !inp || !out) return;

    btn.addEventListener('click', () => {
      const result = resolveRouteSimulated(inp.value || '/');
      out.textContent =
`Route               : ${inp.value || '/'}
Detected type       : ${result.type.toUpperCase()}
Resolved file       : ${result.file}
Layout stack        :
  - ${result.layouts.join('\n  - ')}
Dynamic params      : ${result.params['Id'] ?? 'none'}`;
    });
  });
</script>

</body>
</html>