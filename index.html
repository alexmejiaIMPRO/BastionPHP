<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bastion PHP — Documentation</title>
  <meta name="description" content="Bastion PHP — Developer documentation, how-to, and exhaustive reference." />
  <style>
    /* Simplified readable style derived from provided theme */
    :root { --bg:#071428; --panel:#0b1220; --muted:#98a0b3; --accent:#64d5ff; --card:#071024; --glass: rgba(255,255,255,0.03); --accent-glow:#3b9eff; }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; margin:0; background:linear-gradient(180deg,#071428 0%,#081225 100%); color:#e6eef8; line-height:1.6}
    .wrap{max-width:1200px;margin:32px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
    header h1{font-size:20px;margin:0}
    nav a{color:var(--muted);margin-left:12px;text-decoration:none}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:24px}
    .sidebar{background:var(--panel);padding:18px;border-radius:12px;border:1px solid rgba(100,213,255,.06);height:calc(100vh - 120px);position:sticky;top:24px;overflow:auto}
    .content{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:28px;border-radius:12px;border:1px solid rgba(100,213,255,.06)}
    h2{color:#fff;margin-top:0}
    pre{background:#021126;padding:14px;border-radius:8px;overflow:auto}
    code{font-family:monospace;background:rgba(255,255,255,0.02);padding:2px 6px;border-radius:4px}
    .banner{background:linear-gradient(90deg, rgba(100,213,255,.06), rgba(167,139,250,.03));padding:8px 12px;border-radius:8px;margin-bottom:12px;color:var(--muted)}
    .section{margin-bottom:28px}
    .muted{color:var(--muted)}
    .btn{background:var(--accent);color:#041026;padding:6px 10px;border-radius:6px;text-decoration:none;font-weight:700}
    details{margin:6px 0}
    summary{cursor:pointer;font-weight:700}
    .depr{background:#3b2b2b;padding:8px;border-left:4px solid #f59e0b;border-radius:6px;color:#ffdcb3;margin:12px 0}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);text-align:left}
    footer{margin-top:24px;color:var(--muted);font-size:13px}
    .copy {cursor:pointer;color:var(--accent);font-weight:700;margin-left:8px}
    .toc a{display:block;color:var(--muted);text-decoration:none;padding:6px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Bastion PHP — Documentation</h1>
      <nav>
        <a class="btn" href="#how-to-use">How to Use</a>
        <a class="btn" href="#reference">Reference</a>
        <a class="btn" href="docs/CHANGELOG.md" target="_blank">Changelog</a>
      </nav>
    </header>

    <div class="grid">
      <aside class="sidebar">
        <div class="banner">Developer-first docs. Start with "How to Use". Reference is exhaustive and searchable.</div>
        <nav class="toc">
          <a href="#how-to-use">How to Use — Quick Onboarding</a>
          <a href="#quick-commands">Quick Commands (Cheatsheet)</a>
          <a href="#getting-started">Getting Started (detailed)</a>
          <a href="#workflows">Common Workflows & Examples</a>
          <a href="#reference">Reference (Exhaustive)</a>
          <a href="docs/REFERENCE.md" target="_blank">Open full REFERENCE.md</a>
          <a href="docs/CHANGELOG.md" target="_blank">CHANGELOG</a>
          <a href="docs/README.md" target="_blank">README (legacy)</a>
        </nav>
      </aside>

      <main class="content">
        <!-- HOW TO USE -->
        <section id="how-to-use" class="section">
          <h2>How to Use — Quick Onboarding (Developer-first)</h2>

          <p class="muted">This section is the recommended fast path to get started: install, run, create a page, add a route, and deploy.</p>

          <h3 id="quick-commands">Quick reference — most-used commands</h3>
          <pre><code>./bastion run-dev      # Start dev environment: PHP server + Tailwind watch + BrowserSync
./bastion run-build    # Build CSS for production
./bastion migrate      # Run database migrations
./bastion db:seed      # Run database seeders (creates admin and demo user)
./bastion serve        # Run PHP built-in server
./bastion key:generate # Generate APP_KEY and save to .env</code></pre>

          <h3 id="getting-started">Step-by-step: Create & Run a new project (local)</h3>

          <ol>
            <li>Run the installer/generator:
              <pre><code>bash create-php-app.sh my-app</code></pre>
            </li>
            <li>Enter the project:
              <pre><code>cd my-app</code></pre>
            </li>
            <li>Install dependencies (if not auto-installed):
              <pre><code>composer install
npm install</code></pre>
            </li>
            <li>Create DB schema and seed example users:
              <pre><code>./bastion migrate
./bastion db:seed</code></pre>
            </li>
            <li>Start development server (live reload):
              <pre><code>./bastion run-dev
# Visit: http://localhost:9876</code></pre>
            </li>
          </ol>

          <h3 id="first-page">Create your first page (file-based routing)</h3>

          <p>Create: <code>app/about/page.php</code> with content:</p>
          <pre><code>&lt;?php
$title = 'About';
?&gt;

&lt;h1&gt;&lt;?= e($title) ?&gt;&lt;/h1&gt;
&lt;p&gt;Welcome to Bastion.&lt;/p&gt;</code></pre>

          <p>Access in browser: <code>http://localhost:9876/about</code></p>

          <h3 id="add-api">Add an API endpoint (+server.php)</h3>
          <pre><code>// app/api/ping/+server.php
return [
  'get' => function($req) {
      header('Content-Type: application/json');
      echo json_encode(['pong' => true]);
  }
];</code></pre>

          <h3 id="auth-quick">Auth quickstart</h3>
          <ol>
            <li>Default seeders create two accounts (admin/demo) after db:seed</li>
            <li>Login endpoint issues access + refresh tokens via Auth::issueTokens()</li>
            <li>Use Auth::requireAuth or Auth::loadUser middleware to protect routes</li>
          </ol>

          <div class="depr"><strong>Deprecated:</strong> If you previously used <code>artisan</code> as the canonical CLI, the project now uses <code>./bastion</code>. The old <code>artisan</code> is kept only as a backup.</div>
        </section>

        <!-- WORKFLOWS -->
        <section id="workflows" class="section">
          <h2>Common Workflows & Examples</h2>

          <h3>Create a service and register in DI container</h3>
          <p>1) Create <code>app/Services/MyService.php</code>:</p>
          <pre><code>&lt;?php
namespace App\Services;

class MyService {
  public function greet(string $name): string {
    return "Hello $name";
  }
}</code></pre>

          <p>2) Register and resolve:</p>
          <pre><code>// in app bootstrap or App::registerCoreServices
$app->singleton(App\Services\MyService::class, fn() => new App\Services\MyService());

// Use elsewhere
$svc = App\Core\App::getInstance()->resolve(App\Services\MyService::class);
echo $svc->greet('Dev');</code></pre>

          <h3>Debugging tips</h3>
          <ul>
            <li>Use <code>logger()->debug()</code> to emit debug messages to <code>storage/logs/app.log</code>.</li>
            <li>Temporarily enable errors: set <code>APP_DEBUG=true</code> in .env and restart server.</li>
            <li>Check DB file for SQLite: <code>storage/db/app.db</code>. Use SQLite CLI for quick queries.</li>
          </ul>

          <h3>Production deploy (concise)</h3>
          <pre><code># 1. Set production env
APP_ENV=production
APP_DEBUG=false
SECURE_COOKIES=true

# 2. Install deps & build
composer install --no-dev --optimize-autoloader
npm ci && ./bastion run-build

# 3. Run migrations on production database (MySQL/Postgres recommended)
./bastion migrate

# 4. Configure web server (Nginx/Apache) document root -> public/</code></pre>

          <h3>Troubleshooting common issues</h3>
          <ul>
            <li><strong>Missing env keys:</strong> run <code>./bastion key:generate</code> then edit <code>.env</code>.</li>
            <li><strong>Tailwind CSS not generating:</strong> confirm <code>npm install</code> and run <code>./bastion run-build</code>.</li>
            <li><strong>Database locked:</strong> ensure WAL mode is enabled; check file permissions on <code>storage/db/app.db</code>.</li>
          </ul>
        </section>

        <!-- REFERENCE -->
        <section id="reference" class="section">
          <h2>Reference (Exhaustive)</h2>

          <p class="muted">The full machine-friendly reference is in <a href="docs/REFERENCE.md" target="_blank">docs/REFERENCE.md</a>.
            Below are quick links and a small embedded index for common symbols. Every public class and function is documented
            in <code>docs/REFERENCE.md</code> with signature, examples, side effects, and security notes.</p>

          <details open>
            <summary>Top-level files & CLI (click to expand)</summary>
            <div style="margin-top:8px">
              <table>
                <thead><tr><th>Identifier</th><th>Purpose (one-liner)</th></tr></thead>
                <tbody>
                  <tr><td><code>create-php-app.sh</code></td><td>Installer/generator: scaffolds project structure, files, and installs deps.</td></tr>
                  <tr><td><code>./bastion</code></td><td>Primary CLI replacing artisan — dev server, builds, migrations, seeders, key generator.</td></tr>
                  <tr><td><code>public/index.php</code></td><td>Front controller: bootstraps app and dispatches requests via Router.</td></tr>
                  <tr><td><code>app/bootstrap.php</code></td><td>Loads .env into environment, starts session, sets timezone.</td></tr>
                </tbody>
              </table>
              <p>Open <a href="docs/REFERENCE.md" target="_blank">docs/REFERENCE.md</a> for the full list of classes, files and examples.</p>
            </div>
          </details>

          <details>
            <summary>Searchable reference (download docs/REFERENCE.md)</summary>
            <div style="margin-top:8px">
              <p>Click to open the full reference: <a href="docs/REFERENCE.md" target="_blank">docs/REFERENCE.md</a></p>
            </div>
          </details>
        </section>

        <section id="change-log" class="section">
          <h2>Changelog (summary of this update)</h2>
          <p>This release consolidates v3 generator with the following major changes relative to previous 2.x:</p>
          <ul>
            <li><strong>CLI consolidation:</strong> <code>./bastion</code> becomes canonical CLI (replaces artisan). — Breaking change: scripts and docs updated.</li>
            <li><strong>Smaller generator script:</strong> create-php-app.sh compacted; optional full templates can be toggled.</li>
            <li><strong>Restored features:</strong> Migrations & seeders, User model, Admin panel, Security middleware, Logger, Response, enhanced Request, CSRF, RateLimit.</li>
            <li><strong>Deprecated:</strong> heavy inline demo HTML in generator (moved to separate files) — marked in docs and README as deprecated for maintainability.</li>
          </ul>
          <p>See <a href="docs/CHANGELOG.md" target="_blank">docs/CHANGELOG.md</a> for a full changelog and migration notes.</p>
        </section>

        <footer>
          <p>Documentation generated for repository snapshot. If anything is marked <strong>⚠️ inferred</strong>, please verify the example or signature against the source code before publishing.</p>
        </footer>
      </main>
    </div>
  </div>

  <script>
    // Small copy-to-clipboard handler for code blocks
    document.querySelectorAll('pre').forEach(block => {
      const btn = document.createElement('button');
      btn.textContent = 'Copy';
      btn.className = 'copy';
      btn.style.float = 'right';
      btn.style.marginTop = '-28px';
      btn.style.marginRight = '6px';
      btn.onclick = () => {
        navigator.clipboard.writeText(block.innerText).then(() => {
          btn.textContent = 'Copied';
          setTimeout(()=>btn.textContent='Copy',1200);
        });
      };
      block.parentNode.insertBefore(btn, block);
    });
  </script>
</body>
</html>
